<?xml version="1.0" encoding="utf-8"?>
<Window>
	<Form BKColor="user0" Height="528" Id="frmcust1101MCustSMSSend" Left="8" OnKeyDown="Form_OnKeyDown" OnLoadCompleted="Form_OnLoadCompleted" OnUnloadCompleted="Form_OnUnloadCompleted" PidAttrib="7" Style="sty_Form" Title="단일문자메시지발송팝업" ToolTipFont="Default,0" Top="8" Ver="1.0" Width="480" WorkArea="true">
		<Datasets>
			<Dataset DataSetType="Dataset" Id="ds_ioSmsSingle">
				<Contents></Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_ioEduNoticeHistoryResearchEduSms1"></Dataset>
			<Dataset DataSetType="Dataset" Id="ds_ioEduNoticeHistoryResearchEduSms2"></Dataset>
			<Dataset DataSetType="Dataset" Id="ds_oSMSMMS">
				<Contents>
					<colinfo id="CD" size="256" summ="default" type="STRING"/>
					<colinfo id="DATA" size="256" summ="default" type="STRING"/>
					<record>
						<CD>0</CD>
						<DATA>단문</DATA>
					</record>
					<record>
						<CD>1</CD>
						<DATA>장문(MMS)</DATA>
					</record>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_oBatchSendSeq"></Dataset>
			<Dataset DataSetType="Dataset" Id="ds_iSms"></Dataset>
			<Dataset DataSetType="Dataset" Id="ds_oSms"></Dataset>
		</Datasets>
		<Button ButtonStyle="TRUE" Cursor="HAND" Enable="FALSE" Height="22" Id="btnSend" ImageID="BTN_TEXT_COM" Left="301" OnClick="lfn_Send" Style="sty_Button" TabOrder="7" Text="보내기(F4)" ToolTipText="SMS&#32;보내기" Top="4" Width="85"></Button>
		<Image Height="487" Id="imgSmsTraining" ImageID="IMG_SMARTPHONE" Left="-10" TabOrder="13" Top="32" Width="287"></Image>
		<TextArea Border="SunkenEdge" Font="굴림,11,Bold" Height="261" Id="taMessage" ImeMode="native" Left="23" MaxLength="2000" OnCharChanged="taMessage_OnCharChanged" OnFocus="gfn_ComponentOnFocus" OnKeyDown="gfn_EnterNextFocus" OnKillFocus="gfn_ComponentOnKillFocus" TabOrder="1" Top="109" UserData="S" VScroll="TRUE" Width="226"></TextArea>
		<Static Align="Right" Font="Arial,9,Bold" Height="16" Id="lbLength" Left="111" TabOrder="14" Text="0" Top="369" Width="20"></Static>
		<Static Font="Arial,9,Bold" Height="16" Id="lbTotalLength" Left="135" TabOrder="2" Text="Byte" Top="369" Width="56"></Static>
		<Checkbox Height="20" Id="chkReseve" Left="95" OnClick="chkReseve_OnClick" OnKeyDown="gfn_EnterNextFocus" TabOrder="4" Top="436" Value="FALSE" Width="14"></Checkbox>
		<MaskEdit AutoSelect="TRUE" AutoSkip="TRUE" Border="Flat" Height="20" Id="medReserveTime" Left="209" LeftMargin="2" Mask="##:##" OnFocus="gfn_ComponentOnFocus" OnKeyDown="gfn_EnterNextFocus" OnKillFocus="gfn_ComponentOnKillFocus" Style="sty_Time" TabOrder="6" Top="436" Type="STRING" UserData="S" Visible="FALSE" Width="40"></MaskEdit>
		<Calendar Border="Flat" Dateformat="yyyy-MM-dd" DayFont="돋음,9" DaySelect="Auto" EditAlign="CENTER" HeaderFont="돋음,10,Bold" Height="20" Id="calReserveDate" Left="113" OnChanged="calReserveDate_OnChanged" OnFocus="gfn_ComponentOnFocus" OnKeyDown="gfn_EnterNextFocus" OnKillFocus="gfn_ComponentOnKillFocus" SaturdayTextColor="blue" SelectedDayFont="돋음,9,Bold" Style="sty_Calendar" SundayTextColor="red" TabOrder="5" Top="436" UserData="S" Visible="FALSE" WeeksFont="돋음,9" Width="94"></Calendar>
		<Edit AutoSelect="TRUE" Border="Flat" Font="굴림,11,Bold" Height="20" Id="edReplyNumber" ImeMode="native" Left="95" LeftMargin="2" MaxLength="12" OnFocus="gfn_ComponentOnFocus" OnKeyDown="gfn_EnterNextFocus" OnKillFocus="gfn_ComponentOnKillFocus" Readonly="TRUE" Style="sty_Edit" TabOrder="3" Top="398" UserData="S" Width="122"></Edit>
		<Static Align="Center" Height="20" Id="lbRecvTel" Left="277" Style="sty_Label" TabOrder="15" Text="전송예정인원" Top="92" VAlign="Middle" Width="88"></Static>
		<Edit AutoSelect="TRUE" Border="Flat" Enable="FALSE" Height="20" Id="edRecvPerson" ImeMode="native" Left="369" LeftMargin="2" OnFocus="gfn_ComponentOnFocus" OnKillFocus="gfn_ComponentOnKillFocus" Style="sty_Edit" TabOrder="9" Top="92" UserData="I:수신번호" Width="106"></Edit>
		<Static Align="Center" Height="20" Id="lbSmsGubun" Left="277" Style="sty_Label" TabOrder="16" Text="발송구분" Top="164" VAlign="Middle" Visible="FALSE" Width="88"></Static>
		<Edit AutoSelect="TRUE" Border="Flat" Enable="FALSE" Height="20" Id="edSmsGubun" ImeMode="native" Left="369" LeftMargin="2" OnFocus="gfn_ComponentOnFocus" OnKeyDown="gfn_EnterNextFocus" OnKillFocus="gfn_ComponentOnKillFocus" Style="sty_Edit" TabOrder="12" Top="164" Visible="FALSE" Width="106"></Edit>
		<Static Align="Center" Height="20" Id="lbJibu" Left="277" Style="sty_Label" TabOrder="17" Text="발송지부" Top="116" VAlign="Middle" Width="88"></Static>
		<Edit AutoSelect="TRUE" Border="Flat" Enable="FALSE" Height="20" Id="edJibu" ImeMode="native" Left="369" LeftMargin="2" OnFocus="gfn_ComponentOnFocus" OnKeyDown="gfn_EnterNextFocus" OnKillFocus="gfn_ComponentOnKillFocus" Style="sty_Edit" TabOrder="10" Top="116" Width="106"></Edit>
		<Static Align="Center" Height="20" Id="lbSabun" Left="277" Style="sty_Label" TabOrder="18" Text="발송자" Top="140" VAlign="Middle" Width="88"></Static>
		<Edit AutoSelect="TRUE" Border="Flat" Enable="FALSE" Height="20" Id="edSabun" ImeMode="native" Left="369" LeftMargin="2" OnFocus="gfn_ComponentOnFocus" OnKeyDown="gfn_EnterNextFocus" OnKillFocus="gfn_ComponentOnKillFocus" Style="sty_Edit" TabOrder="11" Top="140" Width="106"></Edit>
		<Button ButtonStyle="TRUE" Cursor="HAND" Height="22" Id="btnEnd" ImageID="BTN_COM_END" Left="388" OnClick="lfn_End" Style="sty_Button" TabOrder="8" ToolTipText="닫기" Top="4" Width="85"></Button>
	</Form>
	<Script><![CDATA[/*
 * 프로그램명 : frmCOM1100MOneSMSSend.xml
 * 설명 : 단일문자메시지발송팝업
 * 작성일 : 2009.09.20
 * 작성자 : 이창희
 */

#include "LIB::COMMON.js"; // 공통 관련

var SmsCust_SQL = ""; // 공통 쿼리 변수 

/* 공통 필수 시작 */
function Form_OnLoadCompleted(obj) {
    gfn_Form_OnLoadCompleted(obj); // 공통 폼 로딩 이벤트 처리

    if (IsExistVar("sBSCNT")) {
        edRecvPerson.Text = sBSCNT + "명";
        edSmsGubun.Text = sMBCCD;
    }

    if (edRecvPerson.Text == "") {
        btnSend.Enable = false;
    } else {
        btnSend.Enable = true;
    }

    edJibu.Text = gds_oUserInfo.GetColumn(0, "PDEPTNM");
    edSabun.Text = gds_oUserInfo.GetColumn(0, "PPERSONNM");
    
    //edReplyNumber.Text = replace(gds_oUserInfo.GetColumn(0, "TEL"), "-", "");
    edReplyNumber.Text = mid(gfn_GetNumber(gds_oUserInfo.GetColumn(0, "TEL")), 0, 10);   
}

function Form_OnUnloadCompleted(obj) {
    Close();
}

function Form_OnKeyDown(obj,objSenderObj,nChar,bShift,bControl,bAlt,nLLParam,nHLParam) {
    switch (nChar) {
        case 27 : // 종료(Esc)
            lfn_End();
            break;
        case 115 : // 단일문자메시지발송(F4)
            lfn_Send();
            break;
    }
}

// 단일문자메시지발송
function lfn_Send(obj)
{
	var sMSENDDATE = "";
	var sMBSMGNO = "";

	taMessage.UserData = "S:전달 메세지";   // 전달 메세지와 회신 연락처 확인 위함
	edReplyNumber.UserData = "S:회신연락처";   // 전달 메세지와 회신 연락처 확인 위함

	if (!gfn_FormValidate(this)) { // 입력 Validation Check
		return false;
	}

	ds_ioEduNoticeHistoryResearchEduSms1.copy(parent.ds_ioEduDay2);  // 세번째 ds
    //trace("3->" + ds_ioEduNoticeHistoryResearchEduSms1.count);         
    ds_ioEduNoticeHistoryResearchEduSms1.Filter("SELA= '1'");    // 통지서 발급 선택한것만 걸러줌
    //trace("3_1->" + ds_ioEduNoticeHistoryResearchEduSms1.count);     
    ds_ioEduNoticeHistoryResearchEduSms2.copyf(ds_ioEduNoticeHistoryResearchEduSms1);  // 통지서 발급 선택한것을 복사 담음   
    //trace("4->" + ds_ioEduNoticeHistoryResearchEduSms2.count);
   	
    for(i = 0; i < ds_ioEduNoticeHistoryResearchEduSms2.RowCount(); i++) {
        if (ds_ioEduNoticeHistoryResearchEduSms2.GetColumn(i, "SELB") == 0) {
            ds_ioEduNoticeHistoryResearchEduSms2.SetColumn(i, "SELB", "1") ;
          //  ds_ioEduDay1.SetColumn(, "SELB", "1") ;
        } else {
            
        }
    }
	if (chkReseve.Value == "1") {	// 예약발송이면
		sMSENDDATE = left(calReserveDate.value,8) + medReserveTime.value + "00";
	}	

	// MBSMGNO 관리번호 추출 및 BATCHSEND INSERT 
	ds_oBatchSendSeq.ClearData(); // 데이타셋 초기화    tit_clearActionInfo();
	tit_addSingleActionInfo("com:insertKTSMSBatchSendSeq", "", 0, "");
    // 서버 호출    tit_callService(        ""        , ""        , "" // inDs        , "ds_oBatchSendSeq=ds_oBatchSendSeq" // outDs        , "GTMGNO=" + quote(gds_oUserInfo.GetColumn(0, "PDEPTCD"))	// -- 지부
          + " MBCCD=" + quote(sMBCCD)			// --업무구분
          + " MSENDDATE=" + quote(iif(chkReseve.Value == "1", sMSENDDATE, left(getDate(),14)))					// -- 발송일시
          + " BSCNT=" + quote(sBSCNT)					// --발송건수
          + " MREGSABUN=" + quote(gds_oUserInfo.GetColumn(0, "PSABUN")) // -- 사번        , ""        ,false        ,false        ,true    );
	
	// 일괄발송 관리번호
	sMBSMGNO = ds_oBatchSendSeq.GetColumn(0, "O_BSMGNO");

	tit_clearActionInfo();
	tit_AddMultiActionInfo(			"com:insertKTSMSSendBatch"	// insert  			, ""	// update  			, ""	// delete			, ""	// flag column 명			, ""	// key sql id			, 0	// key 증가 값			, "" 			, 0 			, "N"	// 실행타입		); 
	// 서버 호출 	tit_callService(		""		,""		,"ds_iSms=ds_ioEduNoticeHistoryResearchEduSms2:U"// inDs		,""	// outDs		, "MBCCD=" + quote(sMBCCD)					// --업무구분
		   +" MBSMGNO=" + quote(sMBSMGNO)	// --일괄발송MGNO(BATCHSEND.BSMGNO)
		   +" MSENDTYPE=" + quote(chkReseve.value)		// --발송구분(0:즉시,1:예약)
		   +" MSENDDATE=" + quote(sMSENDDATE) // --발송(예정)시간
		   +" MCALLBACK=" + quote(edReplyNumber.value) 	// -- 송신자전화번호
		   +" MTITLE=" + quote("한국소방안전원")		// -- 제목           +" MMSG=" + quote(taMessage.text) 			// -- 문자메시지           +" MREGSABUN=" + quote(gds_oUserInfo.GetColumn(0, "PSABUN")) // -- 사번 // args
		,"lfn_AfterSaveSms"		,false	);	
	taMessage.UserData ="S:"; // 전달 메세지와 회신 연락처 확인 위함(조회가능하게 초기화함)    edReplyNumber.UserData ="S:";

	// 2200705 shjung //////////////////////////////////// 	
	/*for( var x=0 ; x< ds_ioEduNoticeHistoryResearchEduSms2.GetCount() ; x++ ) {				
		
		tit_clearActionInfo(); 
		tit_addSearchActionInfo("cust:insertCust1107MFireDefDMData", false);		// 서버 호출 		tit_callService(			""			,""			,"" // inDs			,""	// outDs			,"MPK1=" + quote(ds_ioEduNoticeHistoryResearchEduSms2.getColumn(x, "MPK1"))
			+ " MREGSABUN=" + quote(gds_oUserInfo.GetColumn(0, "PSABUN"))  
			+ " ECMGNO="+ quote(ds_ioEduNoticeHistoryResearchEduSms2.getColumn(x, "ECMGNO"))	
			,"" // callback			,false		);				
	}*/
	// 220705 shjung ////////////////////////////////////	
	
	
		tit_clearActionInfo(); 
		tit_addMultiActionInfo("cust:insertCust1107MFireDefDMData", "", 0, "", "N");		// 서버 호출 		tit_callService(			""			,""			,"ds_iSms=ds_ioEduNoticeHistoryResearchEduSms2:U"// inDs			,""	// outDs			
			,"" 
			,"" // callback			,false		);		
}

function lfn_End(obj) {
    Close();
}
/* 공통 필수 종료 */

/* 사용자 함수 */
/*
 * 기능 : 발송 후 처리해야 할 내용
 * parameter : nErrorCode - 에러코드
 *             strErrorMsg - 에러메시지
 * Return : 없음
 */
function lfn_AfterSaveSms(nErrorCode, strErrorMsg) {
    if (nErrorCode != 0) { // 트랜잭션 에러를 처리한다.
        gfn_ErrorMsg(nErrorCode, strErrorMsg);
        return;
    }

	gfn_Alert("정상적으로 발송되었습니다.");
	
    //parent.ds_ioEduDay2.copy(ds_ioEduDay1);  // 두번째 쿼리
    parent.ds_ioEduDay2.Filter("SEL=" + quote(sRow));
	
    //parent.medSmsCnt.text = "";  

    Close();
}

/*
 * 기능 : 문자열 길이를 계산한다.
 * parameter : obj - 컴포넌트 오브젝트
 *             sMsg - 메세지 앞부분
 *             nLength - 최대문자열수
 * return : 없음
 */
function lfn_CheckLength(obj, sMsg, nLength)
{
    obj.value = ltrim(obj.value);
    var ln_ObjLength = lfn_CheckByte(obj.value);
    if (ln_ObjLength > nLength) {
        gfn_Alert(sMsg + nLength + '자를(영문기준) 초과할 수 없습니다. 현재 ' + ln_ObjLength + '글자입니다.' + ' 80자까지만 내용이 발송됩니다.');
        return false;
    }
    return true;
}

/*
 * 기능 : 바이트수 계산한다.
 * parameter : sString - 계산할 문자열
 * return : 문자열 바이트수
 */
function lfn_CheckByte(sString)
{
    var ln_StringByte = 0;
    var ln_Len = sString.length;
    for (var i = 0; i < ln_Len; i++) {
        if (sString.CharAt(i) >= ' ' && sString.CharAt(i) <= '~' ) {
            ln_StringByte++;
        } else {
            ln_StringByte += 2;
        }
    }
    return ln_StringByte;
}

/* 사용자 이벤트 함수 */
function chkReseve_OnClick(obj,strValue)
{
    if (ChkReseve.Value = true)	{
        calReserveDate.Value = GetDate();
        medReserveTime.Value = "0000";
        calReserveDate.Visible = true;
        medReserveTime.Visible = true;
    } else {
        calReserveDate.Value = "";
        medReserveTime.Value = "";
        calReserveDate.Visible = false;
        medReserveTime.Visible = false;
    }
}

function taMessage_OnCharChanged(obj,strPreText,strPostText)
{
	lbLength.Text = lfn_CheckByte(obj.value);
}




function calReserveDate_OnChanged(obj,strOldText,strNewText)
{
	if (!gfn_isNull(calReserveDate.Value) && (left(getDate(),8) > left(calReserveDate.Value,8))) {
	
		gfn_Alert("예약발송을 현재일자 이전으로 설정할 수 없습니다.");
		
		calReserveDate.Value = "";
		
		return false;
	
	}
}
]]></Script>
</Window>