<?xml version="1.0" encoding="utf-8"?>
<Window>
	<Form BKColor="user0" Height="352" Id="frmtraining0090PInternetJubsuStatistics" Left="8" OnKeyDown="Form_OnKeyDown" OnLoadCompleted="Form_OnLoadCompleted" OnUnloadCompleted="Form_OnUnloadCompleted" PidAttrib="7" Style="sty_Form" Title="[인터넷]강습접수상세내역" ToolTipFont="Default,0" Top="8" Ver="1.0" Width="732" WorkArea="true">
		<Datasets>
			<Dataset DataSetType="Dataset" Id="ds_oJubsu"></Dataset>
			<Dataset DataSetType="Dataset" Id="ds_oSunap"></Dataset>
			<Dataset DataSetType="Dataset" Id="ds_oChange"></Dataset>
			<Dataset DataSetType="Dataset" Id="ds_oRepay"></Dataset>
			<Dataset DataSetType="Dataset" Id="ds_oInternetReport">
				<Contents></Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_iJubsuH">
				<Contents>
					<colinfo id="TJHTJMGNO" size="22" summ="default" type="DECIMAL"/>
					<colinfo id="TJHSEQ" size="22" summ="default" type="DECIMAL"/>
					<colinfo id="TJHSTATUSCD" size="256" summ="default" type="STRING"/>
					<colinfo id="TJHTSSEQREF" size="22" summ="default" type="DECIMAL"/>
					<colinfo id="TJHTOHSEQREF" size="22" summ="default" type="DECIMAL"/>
					<colinfo id="TJHMGGTMGNO" size="256" summ="default" type="STRING"/>
					<colinfo id="TJHREASON" size="1000" summ="default" type="STRING"/>
					<colinfo id="TSSEQ" size="22" summ="default" type="DECIMAL"/>
					<colinfo id="PPAPMYEAR" size="4" summ="default" type="STRING"/>
					<colinfo id="PPAPMMGNO" size="22" summ="default" type="DECIMAL"/>
					<colinfo id="PPAFINISHAMOUNT" size="22" summ="default" type="DECIMAL"/>
					<colinfo id="TSSUNAPACTIONREF" size="256" summ="default" type="STRING"/>
					<colinfo id="TOMGNO" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_ioSettlement">
				<Contents>
					<colinfo id="TSTJMGNO" size="22" summ="default" type="DECIMAL"/>
					<colinfo id="TSGUBUNCD" size="2" summ="default" type="STRING"/>
					<colinfo id="TSGUBUN" size="2" summ="default" type="STRING"/>
					<colinfo id="TSPROCAMOUNT" size="22" summ="default" type="DECIMAL"/>
					<colinfo id="TSTRAININGAMOUNT" size="22" summ="default" type="DECIMAL"/>
					<colinfo id="TSEXAMAMOUNT" size="22" summ="default" type="DECIMAL"/>
					<colinfo id="TSLICENSEAMOUNT" size="22" summ="default" type="DECIMAL"/>
					<colinfo id="TSAMOUNTGUBUN" size="1" summ="default" type="STRING"/>
					<colinfo id="TSPONYGUBUN" size="1" summ="default" type="STRING"/>
					<colinfo id="TSMGGTMGNO" size="4" summ="default" type="STRING"/>
					<colinfo id="TSPROCGTMGNO" size="4" summ="default" type="STRING"/>
					<colinfo id="TSREPAYCD" size="1" summ="default" type="STRING"/>
					<colinfo id="TSSUNAPACTIONREF" size="22" summ="default" type="DECIMAL"/>
					<colinfo id="TSREPAYREF" size="22" summ="default" type="DECIMAL"/>
					<colinfo id="TSSEQ" size="22" summ="default" type="DECIMAL"/>
					<colinfo id="TSSETLMTYN" size="256" summ="default" type="STRING"/>
					<colinfo id="TSTFCSEQ" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_oPosData">
				<Contents>
					<colinfo id="PMYEAR" size="256" summ="default" type="STRING"/>
					<colinfo id="PMMGNO" size="22" summ="default" type="DECIMAL"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_iPosData">
				<Contents>
					<colinfo id="PMYEAR" size="4" summ="default" type="STRING"/>
					<colinfo id="PMMGNO" size="22" summ="default" type="DECIMAL"/>
					<colinfo id="PMINPUT" size="1" summ="default" type="STRING"/>
					<colinfo id="PMPCGUBUN" size="1" summ="default" type="STRING"/>
					<colinfo id="PMPROCDATE" size="8" summ="default" type="STRING"/>
					<colinfo id="PMPIID" size="12" summ="default" type="STRING"/>
					<colinfo id="PMPGMID" size="2" summ="default" type="STRING"/>
					<colinfo id="PMPGMPK" size="100" summ="default" type="STRING"/>
					<colinfo id="PMBUYER" size="50" summ="default" type="STRING"/>
					<colinfo id="PMCLAS" size="2" summ="default" type="STRING"/>
					<colinfo id="PMPGMGUBUN" size="2" summ="default" type="STRING"/>
					<colinfo id="PMITEM1" size="100" summ="default" type="STRING"/>
					<colinfo id="PMITEM2" size="100" summ="default" type="STRING"/>
					<colinfo id="PMITEM3" size="100" summ="default" type="STRING"/>
					<colinfo id="PMITEM4" size="100" summ="default" type="STRING"/>
					<colinfo id="PMAMT" size="22" summ="default" type="DECIMAL"/>
					<colinfo id="PMVAT" size="22" summ="default" type="DECIMAL"/>
					<colinfo id="PMPAYMENTFLAG" size="1" summ="default" type="STRING"/>
					<colinfo id="PMRESULT" size="1" summ="default" type="STRING"/>
					<colinfo id="PMREGDATE" size="7" summ="default" type="STRING"/>
					<colinfo id="PMREGSABUN" size="8" summ="default" type="STRING"/>
					<colinfo id="PPNM" size="256" summ="default" type="STRING"/>
					<colinfo id="PMPCORDERNO" size="256" summ="default" type="STRING"/>
					<colinfo id="PCGUBUN" size="1" summ="default" type="STRING"/>
					<colinfo id="PCORDERNO" size="20" summ="default" type="STRING"/>
					<colinfo id="PCUSERTYPE" size="1" summ="default" type="STRING"/>
					<colinfo id="PCTRANSACTIONDATE" size="8" summ="default" type="STRING"/>
					<colinfo id="PCTRANSACTIONTIME" size="6" summ="default" type="STRING"/>
					<colinfo id="PCSERIALNO" size="22" summ="default" type="DECIMAL"/>
					<colinfo id="PCAMT" size="22" summ="default" type="DECIMAL"/>
					<colinfo id="PCVAT" size="22" summ="default" type="DECIMAL"/>
					<colinfo id="PCSOCIALBUSINESSNO" size="18" summ="default" type="STRING"/>
					<colinfo id="PCAUTHNO" size="10" summ="default" type="STRING"/>
					<colinfo id="PCRESPONSECODE" size="4" summ="default" type="STRING"/>
					<colinfo id="PCRESPONSEDATE" size="14" summ="default" type="STRING"/>
					<colinfo id="PCTRANSACTIONCODE" size="24" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_oAttendance"></Dataset>
			<Dataset DataSetType="Dataset" Id="ds_oEstimate"></Dataset>
		</Datasets>
		<Shape Bottom="28" Height="28" Id="shpBtnBox" Left="637" LineColor="user14" Right="728" TabOrder="2" Top="0" Type="Rectangle" Width="91"></Shape>
		<Button ButtonStyle="TRUE" Cursor="HAND" Height="22" Id="btnEnd" ImageID="BTN_COM_END" Left="640" OnClick="lfn_End" Style="sty_Button" TabOrder="1" ToolTipText="닫기" Top="3" Width="85"></Button>
		<Div BKColor="user0" Height="128" Id="divRepay" Left="1" OnLoadCompleted="Form_OnLoadCompleted" Style="sty_Form" TabOrder="3" TabStop="FALSE" Text="Div0" Top="436" Url="training::frmtraining0095SInternetJubsuRepayInfo.xml" Visible="FALSE" Width="727">
			<Contents></Contents>
		</Div>
		<Shape Bottom="136" Height="88" Id="Shape0" Left="2" LineColor="user15" Right="725" TabOrder="7" Top="48" Type="Rectangle" Width="723"></Shape>
		<Static Align="Center" Height="20" Id="lbYear" Left="245" Style="sty_Label" TabOrder="6" Text="교육년도" Top="60" VAlign="Middle" Width="84"></Static>
		<Edit AutoSelect="TRUE" Border="Flat" Enable="FALSE" Height="20" Id="edOrderNo" ImeMode="native" Left="109" LeftMargin="2" OnFocus="gfn_ComponentOnFocus" OnKeyDown="gfn_EnterNextFocus" OnKillFocus="gfn_ComponentOnKillFocus" Readonly="TRUE" Style="sty_Edit" TabOrder="5" Top="84" Width="132"></Edit>
		<Static Align="Center" Height="20" Id="Static2" Left="13" Style="sty_LabelGruopBox" TabOrder="8" Text="접수내역" Top="36" VAlign="Middle" Width="96"></Static>
		<Static Align="Center" Height="20" Id="lbJibu" Left="5" Style="sty_Label" TabOrder="9" Text="접수지부" Top="60" VAlign="Middle" Width="100"></Static>
		<Edit AutoSelect="TRUE" Border="Flat" Enable="FALSE" Height="20" Id="edJibu" ImeMode="native" Left="109" LeftMargin="2" OnFocus="gfn_ComponentOnFocus" OnKeyDown="gfn_EnterNextFocus" OnKillFocus="gfn_ComponentOnKillFocus" Readonly="TRUE" Style="sty_Edit" TabOrder="4" Top="60" Width="132"></Edit>
		<Static Align="Center" Height="20" Id="lbEmail" Left="501" Style="sty_Label" TabOrder="10" Text="메일수신" Top="84" VAlign="Middle" Width="84"></Static>
		<Static Align="Center" Height="20" Id="lbEducationTerm" Left="245" Style="sty_Label" TabOrder="11" Text="교육일자" Top="84" VAlign="Middle" Width="84"></Static>
		<Static Align="Center" Height="20" Id="lbOrderNo" Left="5" Style="sty_Label" TabOrder="12" Text="회차+접수번호" Top="84" VAlign="Middle" Width="100"></Static>
		<Edit AutoSelect="TRUE" Border="Flat" Enable="FALSE" Height="20" Id="edEducaitonPlace" ImeMode="native" Left="109" LeftMargin="2" OnFocus="gfn_ComponentOnFocus" OnKeyDown="gfn_EnterNextFocus" OnKillFocus="gfn_ComponentOnKillFocus" Readonly="TRUE" Style="sty_Edit" TabOrder="13" Top="108" Width="388"></Edit>
		<Static Align="Center" Height="20" Id="lbJubsuDate" Left="501" Style="sty_Label" TabOrder="15" Text="접수일시" Top="108" VAlign="Middle" Width="84"></Static>
		<MaskEdit AutoSelect="TRUE" AutoSkip="TRUE" Border="Flat" Enable="FALSE" Height="20" Id="meJubsuDate" Left="588" LeftMargin="2" Mask="####-##-##&#32;##:##:##" OnFocus="gfn_ComponentOnFocus" OnKeyDown="gfn_EnterNextFocus" OnKillFocus="gfn_ComponentOnKillFocus" Style="sty_Time" TabOrder="14" Top="108" Type="STRING" Width="132"></MaskEdit>
		<Static Align="Center" Height="20" Id="lbEducationPlace" Left="5" Style="sty_Label" TabOrder="16" Text="교육장소" Top="108" VAlign="Middle" Width="100"></Static>
		<Static Align="Center" Height="20" Id="lbCourse" Left="468" Style="sty_Label" TabOrder="17" Text="교육분야" Top="60" VAlign="Middle" Width="84"></Static>
		<MaskEdit AutoSelect="TRUE" AutoSkip="TRUE" Border="Flat" Enable="FALSE" Height="20" Id="meEducationTerm" Left="333" LeftMargin="2" Mask="####-##-##&#32;~&#32;####-##-##" OnFocus="gfn_ComponentOnFocus" OnKeyDown="gfn_EnterNextFocus" OnKillFocus="gfn_ComponentOnKillFocus" Style="sty_Time" TabOrder="18" Top="84" Type="STRING" Width="164"></MaskEdit>
		<Div BKColor="user0" Height="104" Id="divChange" Left="1" OnLoadCompleted="Form_OnLoadCompleted" Style="sty_Form" TabOrder="19" TabStop="FALSE" Text="Div0" Top="136" Url="training::frmtraining0092SInternetJubsuChangeInfo.xml" Visible="FALSE" Width="727">
			<Contents></Contents>
		</Div>
		<Div BKColor="user0" Height="80" Id="divSunap" Left="1" OnKeyDown="Form_OnKeyDown" OnLoadCompleted="Form_OnLoadCompleted" OnUnloadCompleted="Form_OnUnloadCompleted" Style="sty_Form" TabOrder="20" TabStop="FALSE" Text="Div0" Top="352" Url="training::frmtraining0094SInternetJubsuSunapInfo.xml" Visible="FALSE" Width="727">
			<Contents></Contents>
		</Div>
		<Div BKColor="user0" Height="104" Id="divJubsu" Left="1" OnKeyDown="Form_OnKeyDown" OnLoadCompleted="Form_OnLoadCompleted" OnUnloadCompleted="Form_OnUnloadCompleted" Style="sty_Form" TabOrder="21" TabStop="FALSE" Text="Div0" Top="244" Url="training::frmtraining0093SInternetJubsuJubsuInfo.xml" Visible="FALSE" Width="727">
			<Contents></Contents>
		</Div>
		<Edit AutoSelect="TRUE" Border="Flat" Enable="FALSE" Height="20" Id="edCourse" ImeMode="native" Left="556" LeftMargin="2" OnFocus="gfn_ComponentOnFocus" OnKeyDown="gfn_EnterNextFocus" OnKillFocus="gfn_ComponentOnKillFocus" Readonly="TRUE" Style="sty_Edit" TabOrder="22" Top="60" Width="164"></Edit>
		<Edit AutoSelect="TRUE" Border="Flat" Enable="FALSE" Height="20" Id="edYear" ImeMode="native" Left="333" LeftMargin="2" OnFocus="gfn_ComponentOnFocus" OnKeyDown="gfn_EnterNextFocus" OnKillFocus="gfn_ComponentOnKillFocus" Readonly="TRUE" Style="sty_Edit" TabOrder="23" Top="60" Width="131"></Edit>
		<Button ButtonStyle="TRUE" Cursor="HAND" Height="22" Id="btnProc" ImageID="BTN_TEXT_07" Left="527" OnClick="btnProc_OnClick" Style="sty_Button" TabOrder="24" Top="3" Transparent="TRUE" Visible="FALSE" Width="105"></Button>
		<Edit AutoSelect="TRUE" Border="Flat" Enable="FALSE" Height="20" Id="edEmail" ImeMode="native" Left="588" LeftMargin="2" OnFocus="gfn_ComponentOnFocus" OnKeyDown="gfn_EnterNextFocus" OnKillFocus="gfn_ComponentOnKillFocus" Readonly="TRUE" Style="sty_Edit" TabOrder="25" Top="84" Width="132"></Edit>
		<Button ButtonStyle="TRUE" Cursor="HAND" Height="22" Id="btnRepay" ImageID="BTN_TEXT_06" Left="229" OnClick="btnRepay_OnClick" Style="sty_Button" TabOrder="26" Text="환불접수처리" Top="3" Transparent="TRUE" Visible="FALSE" Width="92"></Button>
		<Div BKColor="user0" Height="24" Id="divPos" Left="596" OnLoadCompleted="Form_OnLoadCompleted" OnTimer="frmCOM3010SPOS_OnTimer" OnUnloadCompleted="frmCOM3010SPOS_OnUnloadCompleted" Style="sty_Form" TabOrder="27" TabStop="FALSE" Text="Div0" Top="32" Url="COM::frmCOM3010SPOS.xml" Visible="FALSE" Width="128">
			<Contents></Contents>
		</Div>
		<Button ButtonStyle="TRUE" Cursor="HAND" Height="22" Id="btnRepayCancel" ImageID="BTN_TEXT_06" Left="324" OnClick="btnRepayCancel_OnClick" Style="sty_Button" TabOrder="28" Text="환불취소" Top="3" Transparent="TRUE" Visible="FALSE" Width="92"></Button>
		<Image Height="10" Id="imgImage" ImageID="IMG_BULLET" Left="8" Style="sty_Image" TabOrder="30" Top="9" Transparent="TRUE" Width="12"></Image>
		<Static Font="굴림,12,Bold" Height="20" Id="lbWorkFormTitle" Left="28" TabOrder="29" Text="[인터넷]접수&#32;상세&#32;내역" Top="4" VAlign="Middle" Width="200"></Static>
		<Button ButtonStyle="TRUE" Cursor="HAND" Height="22" Id="btnOrderChange" ImageID="BTN_TEXT_07" Left="419" OnClick="btnOrderChange_OnClick" Style="sty_Button" TabOrder="31" Text="일정변경신청서" Top="3" Transparent="TRUE" Visible="FALSE" Width="105"></Button>
	</Form>
	<Script><![CDATA[/*
 * 강습접수정보명 : frmtraining0090PInternetJubsuStatistics.xml
 * 설명 : [인터넷]강습접수상세내역팝업
 * 작성일 : 2009.09.13
 * 작성자 : 김동현
 */

#include "LIB::COMMON.js"; // 공통 관련

var ls_ResultPrintPosMsg = ""; // Pos 처리결과 메세지
var ls_ResultPrintLgdMsg = ""; // LG데이콤결과메세지
var ls_ResultPrintKemsMsg = ""; // 안전원결과메세지
var ls_ResultPrintReTransYn = "N"; // 재전송 여부
var ls_DeletePosOrderNo = array(2); //삭제할 영수증 번호
var ls_TFCSEQ = "";				// 수수료코드 관리번호

/* 공통 필수 시작 */
function Form_OnLoadCompleted(obj) {
    window.Height = sFormHeight;

    gfn_Form_OnLoadCompleted(obj); // 공통 폼 로딩 이벤트 처리

    if (sTohSeq > 1) {
        lfn_SearchChange();
        divChange.Visible = true;
    } else {
        divJubsu.Top = divChange.Top;
        divSunap.Top = divJubsu.Bottom;
        divRepay.Top = divSunap.Bottom;
    }
    divJubsu.Visible = true;
    divSunap.Visible = true;

    lfn_SearchJubsuInfo();
    lfn_SearchSunap();

    switch (sJubsuStatus) {
        case "8":
        case "2":
        case "4":
//			btnOrderChange.Visible = true;	// 일정변경신청서
        case "1":
            divSunap.btnPrintReRct.Enable = true;
            btnProc.Value = "원서출력";
            btnProc.Visible = true;

            break;

        case "3":

            break;

        case "5":
            btnRepay.Text = "환불접수처리";
            btnRepay.Visible = true;
            btnProc.Value = "환불신청서 출력";
            btnProc.Visible = true;
            btnRepayCancel.Visible = true; //환불 취소 버튼
            divRepay.Visible = true;
            divRepay.edChangeReason.SetFocus();
            
            lfn_SearchRepay();
            lfn_SearchAttendance();			
			
            divRepay.cbxTrainingAmount.Value = toNumber(ds_oRepay.GetColumn(0,"PPAPLANAMOUNT")) - toNumber(ds_oRepay.GetColumn(0,"TSLICENSEAMOUNT"));

			divRepay.medAmount2.Value = ds_oRepay.GetColumn(0,"PPAPLANAMOUNT");
            
            divRepay.lfn_TotalAmount();

            break;
            
        case "6":
            divRepay.edChangeReason.Enable = false;
            btnRepay.Text = "환불완료처리";
            btnRepay.Visible = true;
            btnProc.Value = "환불신청서 출력";
            btnRepayCancel.Visible = true; //환불 취소 버튼
            btnProc.Visible = true;
            divRepay.Visible = true;
            divRepay.cbxTrainingAmount.Enable = false;
            
            lfn_SearchRepay();
            lfn_SearchAttendance();
            
			divRepay.medAmount2.Value = ds_oRepay.GetColumn(0,"PPAPLANAMOUNT");
            divRepay.cbxTrainingAmount.Value = divRepay.ds_oTrainingRepayFee.GetColumn(
                divRepay.ds_oTrainingRepayFee.searchrow(
                    "REPAY='"+(toNumber(ds_oRepay.GetColumn(0, "PPAFINISHAMOUNT"))-toNumber(divRepay.medOtherAmount.Value))+"'"
                )
                ,"REPAY"
            );
            
            divRepay.lfn_TotalAmount();

            break;

        case "7":
            btnProc.Value = "환불신청서 출력";
            btnProc.Visible = true;
            divRepay.Visible = true;
            divRepay.cbxTrainingAmount.Enable = false;
            divRepay.edChangeReason.Enable = false;

            lfn_SearchRepay();
            lfn_SearchAttendance();
            
			divRepay.medAmount2.Value = ds_oRepay.GetColumn(0,"PPAPLANAMOUNT");
            divRepay.cbxTrainingAmount.Value = divRepay.ds_oTrainingRepayFee.GetColumn(
                divRepay.ds_oTrainingRepayFee.searchrow(
                    "REPAY='"+(toNumber(ds_oRepay.GetColumn(0, "PPAFINISHAMOUNT"))-toNumber(divRepay.medOtherAmount.Value))+"'"
                )
                ,"REPAY"
            );

            divRepay.lfn_TotalAmount();

            break;

        default :
            lfn_SearchJubsuInfo();
    }

}

function Form_OnKeyDown(obj,objSenderObj,nChar,bShift,bControl,bAlt,nLLParam,nHLParam) {
    switch (nChar) {
        case 27 : // 종료(Esc)
            lfn_End();
            break;
    }
}

function Form_OnUnloadCompleted(obj) {
    //Close("END");
}

/*
 * 기능 : 종료
 */
function lfn_End(obj) {
    Close();
}
/* 공통 필수 종료 */

/* 사용자 함수 */

function lfn_SearchJubsuInfo() {

    var sArg = "TJMGNO=" + quote(sJubsuNo)
        + " TJHSTATUSCD=" + quote(sJubsuStatus);

    ds_oJubsu.ClearData();

    tit_clearActionInfo();
    tit_addCsvSearchActionInfo("training:searchInternetTrainingJubsuInfo", false);
    tit_callService(
        ""
        ,""
        ,"" // inDs
        ,"ds_oJubsu=ds_oInternetTrainingJubsu"	// outDs
        ,sArg // args 
        ,""
        ,false
        ,""
        ,true
    );
    
    edJibu.Text = ds_oJubsu.GetColumn(0, "GTDEPTNM");
    edYear.Text = ds_oJubsu.GetColumn(0, "TOYEAR");
    edCourse.Text = ds_oJubsu.GetColumn(0, "TCCOURSENM") + ds_oJubsu.GetColumn(0, "MUNJENM");
    edOrderNo.Text = ds_oJubsu.GetColumn(0, "TOTRAININGORDER") + " - " + right(ds_oJubsu.GetColumn(0, "TOHJUBSUNO"), 3);
    meEducationTerm.Value = ds_oJubsu.GetColumn(0, "EDUCATIONTERM");
    edEmail.Text = ds_oJubsu.GetColumn(0, "EMAILCHECK");
    edEducaitonPlace.Text = ds_oJubsu.GetColumn(0, "EPNM");
    meJubsuDate.Value = ds_oJubsu.GetColumn(0, "TJHREGDATE");

    divJubsu.edPersonNm.Text = ds_oJubsu.GetColumn(0, "TPNM");
    divJubsu.meBirthday.Text = ds_oJubsu.GetColumn(0, "TPBIRTHDAY");
    divJubsu.edHpTel.Text = ds_oJubsu.GetColumn(0, "TPHPTEL");
    divJubsu.edEmail.Text = iif(ds_oJubsu.GetColumn(0, "EMAIL")=="@","",ds_oJubsu.GetColumn(0, "EMAIL"));
    divJubsu.edAddr.Text = "(" + left(ds_oJubsu.GetColumn(0, "TJZIPCD"),3)
        + "-" + right(ds_oJubsu.GetColumn(0, "TJZIPCD"),3) + ") "
        + ds_oJubsu.GetColumn(0, "ADDR");
    divJubsu.edTel.Text = ds_oJubsu.GetColumn(0, "TPTEL");

}

function lfn_SearchSunap() {
    var sArg = "TJMGNO=" + quote(sJubsuNo)
        + " TJHSTATUSCD=" + quote(sJubsuStatus);
    
    ds_oSunap.ClearData();
    
    tit_clearActionInfo();
    tit_addCsvSearchActionInfo("training:searchInternetTrainingJubsuSunapInfo", false);
    tit_callService(
        ""
        ,""
        ,"" // inDs
        ,"ds_oSunap=ds_oInternetTrainingJubsu"	// outDs
        ,sArg // args 
        ,""
        ,false
        ,""
        ,true
    );

    divSunap.edSetlmYn.Text = ds_oSunap.GetColumn(0, "TSSETLMT");
    divSunap.meAmount.Text = ds_oSunap.GetColumn(0, "TSPROCAMOUNT");
    
    if (ds_oSunap.GetColumn(0, "TSSETLMTYN") == "Y") {
        divSunap.edSetlmGubun.Text = ds_oSunap.GetColumn(0, "TSGUBUNNM");
        divSunap.edPersonNm.Text = ds_oSunap.GetColumn(0, "TJPERSONNM");
        divSunap.meProcDate.Value = ds_oSunap.GetColumn(0, "TSPROCDATE");
    }
    
    if (ds_oSunap.GetColumn(0, "TSGUBUN") == "13"
        || ds_oSunap.GetColumn(0, "TSGUBUN") == "15"
        || ds_oSunap.GetColumn(0, "TSGUBUN") == "23"
        || ds_oSunap.GetColumn(0, "TSGUBUN") == "25") {
        divSunap.btnShowVirtualAccount.Enable = true;
    }
    ls_TFCSEQ = ds_oSunap.GetColumn(0, "TSTFCSEQ");				// 수수료코드 관리번호
    
}

function lfn_SearchChange() {
    var sArg = "TJMGNO=" + quote(sJubsuNo)
        + " TJHSEQ=" + quote(sTjhSeq);

    ds_oChange.ClearData();

    tit_clearActionInfo();
    tit_addCsvSearchActionInfo("training:searchInternetTrainingJubsuChangeInfo", false);
    tit_callService(
        ""
        ,""
        ,"" // inDs
        ,"ds_oChange=ds_oInternetTrainingJubsu"	// outDs
        ,sArg // args
        ,""
        ,false
        ,""
        ,true
    );

    divChange.edOrder.Text = ds_oChange.GetColumn(0, "TOAFTERDEPTNM")
        + " " + ds_oChange.GetColumn(0, "TOAFTERORDER")
        + " - " + right(ds_oChange.GetColumn(0, "TOAFTERTJNO"),3);
    divChange.edBeforeOrder.Text = ds_oChange.GetColumn(0, "TOBEFOREDEPTNM")
        + " " + ds_oChange.GetColumn(0, "TOBEFOREORDER")
        + " - " + right(ds_oChange.GetColumn(0, "TOBEFORETJNO"),3);
    divChange.meEduTerm.Value = ds_oChange.GetColumn(0, "TOTERMDATE");
    divChange.edEduNm.Text = ds_oChange.GetColumn(0, "EPNM");
    divChange.edReason.Text = ds_oChange.GetColumn(0, "TJHREASON");
    divChange.meProcDate.Value = ds_oChange.GetColumn(0, "TJHREGDATE");

}

function lfn_SearchRepay() {

    var sArg = "TJMGNO=" + quote(sJubsuNo)
        + " TJHSEQ=" + quote(sTjhSeq)
        + " TJHSTATUSCD=" + quote(sJubsuStatus);

    ds_oRepay.ClearData();
    
    tit_clearActionInfo();
    tit_addCsvSearchActionInfo("training:searchInternetTrainingJubsuRepayInfo", false);
    tit_callService(
        ""
        ,""
        ,"" // inDs
        ,"ds_oRepay=ds_oInternetTrainingJubsu"	// outDs
        ,sArg // args
        ,""
        ,false
        ,""
        ,true
    );
   
	var exam = ds_oRepay.GetColumn(0, "TSEXAMAMOUNT"); //시험 선수납비
	var license = ds_oRepay.GetColumn(0, "TSLICENSEAMOUNT"); //수첩 선수납비

    divRepay.edPersonNm.Text = ds_oRepay.GetColumn(0, "PPAOWNER");
    divRepay.edBank.Text = ds_oRepay.GetColumn(0, "PPABANKNM");
	divRepay.meRepayDate.Value = ds_oRepay.GetColumn(0, "PMREGDATE");
	divRepay.edAccount.Text = ds_oRepay.GetColumn(0, "PPACCOUNT");
	divRepay.edReason.Text = ds_oRepay.GetColumn(0, "TJHREASON");
	divRepay.edChangeReason.Text = ds_oRepay.GetColumn(0, "TJHCHANGEREASON");
	
	if (license != 0) {
        divRepay.lbOtherAmount.Text = "수첩 수수료     " + NumFormat(license);
        divRepay.medOtherAmount.Value = license;
	} else if (exam != 0) {
        divRepay.lbOtherAmount.Text = "시험 수수료     " + NumFormat(exam);
        divRepay.medOtherAmount.Value = exam;
	} else {
        divRepay.lbOtherAmount.Text = "수수료          0";
        divRepay.medOtherAmount.Value = 0;
	}
	
	divRepay.lfn_SearchTrainingSunapRepayFee();
    
}

function btnProc_OnClick(obj) {

    var ls_RexFile = "";

    ds_oInternetReport.ClearData();
    
    tit_clearActionInfo();

    switch (sJubsuStatus) {
        case "1":
        case "2":
        case "3":
        case "4":
            
            tit_addCsvSearchActionInfo("training:searchInternetTrainingJubsuReport", false);
            ls_RexFile = "frmtraining0060R03TrainingApplicationBatch.rex";
            
            break;

        case "5":
        case "6":
        case "7":

            tit_addCsvSearchActionInfo("training:searchInternetTrainingRepayReport", false);
            ls_RexFile = "frmtraining0090R01TrainingRepayAppl.rex";
            
            break;
            
        case "8":
            break;
    }
    
    tit_callService(
        ""
        ,""
        ,"" // inDs
        ,"ds_oInternetReport=ds_oInternetTrainingJubsuInfoReport"	// outDs
        ,"TJMGNO=" + quote(sJubsuNo) // args
        ,""
        ,false
        ,""
        ,true
    );
    
    gfn_CallReportPopup(ls_RexFile
        , "ds_oInternetReport"
        , "rpDirpath=" + GF_FILE_SERVER_URL + "kems"
        , true
    );
    
}

function btnRepay_OnClick(obj) {

    var ls_PosResult = "5";
    var ls_RetResultPopup = "RETRANS";
    
    switch (sJubsuStatus) {

        case "5":

            if (!gfn_Confirm("환불신청을 접수 하시겠습니까?")) {
                return false;
            }

            ds_iJubsuH.ClearData();
            ds_iJubsuH.InsertRow(0);
            ds_iJubsuH.SetColumn(0, "TJHTJMGNO", ds_oRepay.GetColumn(0, "TJHTJMGNO"));
            ds_iJubsuH.SetColumn(0, "TJHSTATUSCD", toNumber(sJubsuStatus)+1);
            ds_iJubsuH.SetColumn(0, "TJHREASON", divRepay.edChangeReason.Text);
            ds_iJubsuH.SetColumn(0, "PPAPMYEAR", ds_oRepay.GetColumn(0, "TSPMYEAR"));
            ds_iJubsuH.SetColumn(0, "PPAPMMGNO", ds_oRepay.GetColumn(0, "TSPMMGNO"));
            ds_iJubsuH.SetColumn(0, "PPAFINISHAMOUNT", divRepay.medAmount.Value);

            tit_clearActionInfo();
            tit_addSingleActionInfo("training:insertInternetTrainingJubsuRepayBefore", "", 0, "");
            tit_callService(
                ""
                ,""
                ,"ds_iInternetTrainingJubsuRepay=ds_iJubsuH:U" // inDs
                ,""	// outDs
                ,"" // args
                ,""
                ,false
                ,""
                ,true
            );
    
            break;

        case "6":

            if (!gfn_Confirm("환불완료를 하시겠습니까?")) {
                return false;
            }
            
			if (ds_oSunap.GetColumn(ds_oSunap.currow, "PVINFO") == "발행") {
			
				gfn_Alert("                   < (세금)계산서 발행 자료 >\n\n"
		
					 + "해당 자료는 (세금)계산서가 발행되어 있습니다.\n\n"
		
					 + "    - (세금)계산서 관리번호 : " + ds_oSunap.GetColumn(ds_oSunap.currow, "PVVMYEAR") +"-"
														+ iif(ds_oSunap.GetColumn(ds_oSunap, "PVVMBILLTYPE")=="1","F","T") +"-"
														+ ds_oSunap.GetColumn(ds_oSunap.currow, "PVVMVATNO") + "\n\n"
		
					 //+ "회계 담당자에게 (세금)계산서 삭제 후 환불해 주시기 바랍니다.");
					 + "환불시 수정계산서가 자동발행됩니다. 유의하시고 환불해 주시기 바랍니다.");
			}

            //결제 완료 안된 관리번호, 관리년도 검색
            //ds_oPosData 데이터셋 필요
            lfn_SearchMgno();

            if (ds_oPosData.GetColumn(0, "TJLASTSUNAPGUBUN") == "Y") {
				gfn_Alert("이미 환불된 자료입니다.");
                return false;
			}

            if (ds_oPosData.GetRowCount() == 0) {
                lfn_InsertSettlement();
                lfn_SearchMgno();
            }

            //POSM 데이터 생성
            //ds_iPosData 데이터셋 필요
            lfn_CreatePosData();

            if (ds_oRepay.GetColumn(0, "PMPGMGUBUN") == "22"
                || ds_oRepay.GetColumn(0, "PMPGMGUBUN") == "25"
                || ds_oRepay.GetColumn(0, "PMPGMGUBUN") == "26"
                || ds_oRepay.GetColumn(0, "PMPGMGUBUN") == "12"
                || ds_oRepay.GetColumn(0, "PMPGMGUBUN") == "15"
                || ds_oRepay.GetColumn(0, "PMPGMGUBUN") == "16"
                ) { //현금 영수증 일 때
                
                while(ls_RetResultPopup == "RETRANS") {

                    ls_ResultPrintReTransYn = "N";

                    for (var i=0; i<ds_oPosData.GetRowCount() ;i++) {
                        
                        if (ds_oPosData.GetColumn(i, "PMPCGUBUN") == "02") { // 환불일 때
                            ls_PosResult = lfn_PosProc(ds_oPosData.GetColumn(i, "PMYEAR"), ds_oPosData.GetColumn(i, "PMMGNO"));
                        } else { //수납일 때 방문 현금으로 처리(임시)
                            ls_PosResult = 0;
                        }
                        
                        switch (ls_PosResult) { // POS 결과
                        
                            case "0" : // 데이콤 성공, 안전원 성공
                                ls_ResultPrintLgdMsg = "성공"; // LG데이콤결과메세지
                                ls_ResultPrintKemsMsg = "성공"; // 안전원결과메세지
                                lfn_CheckSettlement(i); // 성공 체크
                                break;

                            case "1" : // 데이콤 성공, 안전원 실패
                                // 안전원 성공으로 수정
                                divPos.ds_ioPosInput.SetColumn(0, "STATUS", "1"); // 초기저장시 4
                                
                                var ls_RetRetry = "";
                                var ln_Cnt = 0; // 시도회수
                                while (true) {
                                    ls_RetRetry = divPos.lfn_POS(); // POS 호출
                                    if (ls_RetRetry == "0") { // 성공
                                        ls_ResultPrintLgdMsg = "성공"; // LG데이콤결과메세지
                                        ls_ResultPrintKemsMsg = "성공"; // 안전원결과메세지
                                        lfn_CheckSettlement(i); // 성공 체크
                                        break;
                                    }
                                    if (ln_Cnt == 10) { // 안전원 성공으로 수정하기 실패
                                        gfn_Alert("데이콤 처리는 성공했으나, 안전원 저장 처리는 실패했습니다.\n정보지원과로 문의하시기 바랍니다.");
                                        Close("KFSA-FAIL");
                                    }
                                    ln_Cnt++;
                                }
                                break;
                    
                            case "3" : // 데이콤 실패, 안전원 실패
                            case "4" : // 초기 신청 상태
                                ls_ResultPrintLgdMsg = "실패"; // LG데이콤결과메세지
                                ls_ResultPrintKemsMsg = "실패"; // 안전원결과메세지
                                ls_ResultPrintReTransYn = "Y";
                                break;

                            default : // 결과를 알 수 없는 상태
                                gfn_Alert("처리 결과를 알 수가 없습니다.\n정보지원과로 문의하시기 바랍니다.");
                                ls_ResultPrintReTransYn = "Y";
                                Close("UNKNOWN-FAIL");
                                break;
                        }
                        
                        if (ls_PosResult >= "3") {
                            break;
                        }

                    }
                    
                    ls_RetResultPopup = lfn_PopupResultPos(ds_oPosData.GetColumn(0, "PMYEAR"), ds_oPosData.GetColumn(0, "PMMGNO")); // 결과출력팝업을 호출한다.

                    lfn_SearchMgno();

                    if (ls_RetResultPopup == "OK") { // 전체 성공 시
                        lfn_UpdateSettlement(); // Settlement 업데이트
                        //gfn_Alert("환불이 정상적으로 처리되었습니다.");
                        break;
                    } else if (ls_RetResultPopup <> "RETRANS") { // 실패시 실패 된 것 만 삭제
                        lfn_DeletePos();
                        gfn_Alert("환불 처리가 완료되지 않았습니다.");
                    }
                }
            
            } else {
                lfn_UpdateSettlement(); // 현금영수증이 아닐 때 바로 완료
                //gfn_Alert("환불이 정상적으로 처리되었습니다.");
            }
            
            break;
    }

    close(true);
}

/**
 * 환불취소
 */
function btnRepayCancel_OnClick(obj) {
    if (!gfn_Confirm("환불취소를 하시겠습니까?")) {
        return false;
    }
    
    ds_iJubsuH.ClearData();
    ds_iJubsuH.InsertRow(0);
    ds_iJubsuH.SetColumn(0, "TJHTJMGNO", ds_oRepay.GetColumn(0, "TJHTJMGNO"));
    ds_iJubsuH.SetColumn(0, "TJHSTATUSCD", "8");
    ds_iJubsuH.SetColumn(0, "TJHREASON", "환불 취소");
    ds_iJubsuH.SetColumn(0, "PPAPMYEAR", ds_oRepay.GetColumn(0, "TSPMYEAR"));
    ds_iJubsuH.SetColumn(0, "PPAPMMGNO", ds_oRepay.GetColumn(0, "TSPMMGNO"));

    tit_clearActionInfo();
    tit_addSingleActionInfo("training:insertInternetTrainingJubsuRepayCancel", "", 0, "");
    tit_callService(
        ""
        ,""
        ,"ds_iInternetTrainingJubsuRepay=ds_iJubsuH:U" // inDs
        ,""	// outDs
        ,"" // args
        ,""
        ,false
        ,""
        ,true
    );
    
    close(true);
}


/* POS 결과 코드 - ls_PosResultCode
    MI_RSCODE - ○:성공, Ⅹ:실패
    LGD   DB   코드
    ○    ○    0
    ○    Ⅹ    1
    Ⅹ    ○    2
    Ⅹ    Ⅹ    3
    無    無    4    초기입력
    ?     ?     5    알수없음
*/

/*
 * POS처리
 */
function lfn_PosProc(sYear, sMgno) {

    divPos.ds_ioPosInput.ClearData();
    divPos.ds_ioPosInput.InsertRow(0);
    divPos.ds_ioPosInput.SetColumn(0, "PMYEAR", sYear);
    divPos.ds_ioPosInput.SetColumn(0, "PMMGNO", sMgno);
    divPos.ds_ioPosInput.SetColumn(0, "STATUS", "4");
                
    var sArg = "";
    var ls_PosResultCode = ""; // POS 결과코드
    var ls_RetPos = Dialog("COM::frmCOM3001PPOSProgressBar.xml", sArg, 300, 123, "TitleBar=false", -1, -1);

    if (ls_RetPos == "OK") {
        ls_ResultPrintPosMsg = divPos.ds_ioPosOutput.GetColumn(0, "MI_RSMSG"); // 결과메세지
        ls_PosResultCode = divPos.ds_ioPosOutput.GetColumn(0, "MI_RSCODE"); // 결과코드

    } else if (ls_RetPos == "FAIL"){ // 실패
        ls_ResultPrintPosMsg = divPos.ds_ioPosOutput.GetColumn(0, "MI_RSMSG"); // 결과메세지
        if ("OK" == divPos.lfn_POSSearch()) { // 실시간 POS 결과를 조회한다.
            ls_PosResultCode = divPos.ds_ioPosOutput.GetColumn(0, "MI_RSCODE"); // 결과코드
        } else {
            ls_PosResultCode = "5"; // 결과코드
        }

    } else { // 10초 이후(실패)
        ls_ResultPrintPosMsg = "10초 - 시간 초과입니다.";
        if ("OK" == divPos.lfn_POSSearch()) { // 실시간 POS 결과를 조회한다.
            ls_PosResultCode = divPos.ds_ioPosOutput.GetColumn(0, "MI_RSCODE"); // 결과코드
        } else {
            ls_PosResultCode = "5"; // 결과코드
        }

    }

    return ls_PosResultCode;
}

/**
 * POS결과 조회
 */
function lfn_PopupResultPos(sMgno, sYear, sHpTel) {
    gfn_SearchPosResult(sMgno
        , sYear
        , gds_oPosResult); // POS 결과 정보를 조회한다.

    var sArg = ""; // 팝업파라메터
    sArg = "sResultPrintSunapGubun=" + quote("환불"); // 수납환불구분(수납0,환불1)
    sArg += " sResultPrintBuyerNm=" + quote(gds_oPosResult.GetColumn(0, "BUYER")); // 구매자
    sArg += " sResultPrintProgramNm=" + quote(gds_oPosResult.GetColumn(0, "PGMNM")); // 상품정보
    sArg += " sResultPrintJumunNo=" + quote(gds_oPosResult.GetColumn(0, "JUMUNNO")); // 주문번호
    sArg += " sResultPrintPaymentGubun=" + quote(gds_oPosResult.GetColumn(0, "PAYMENT")); // 납부방법
    sArg += " sResultPrintProcAmount=" + quote(divRepay.medAmount.Value); // 처리금액
    sArg += " sResultPrintCardNo=" + quote(gds_oPosResult.GetColumn(0, "CARDNO")); // 카드번호
    sArg += " sResultPrintCardInstall=" + quote(gds_oPosResult.GetColumn(0, "CARDINSTALL")); // 할부개월수
    sArg += " sResultPrintCashReceiptUse=" + quote(gds_oPosResult.GetColumn(0, "CASHRECEIPTUSE")); // 현금영수증발급용도
    sArg += " sResultPrintCashCardNo=" + quote(gds_oPosResult.GetColumn(0, "CASHCARDNO")); // 현금영수증번호
    sArg += " sResultPrintVirtCashReceiptYn=" + quote(iif(gfn_IsNull(gds_oPosResult.GetColumn(0, "CASHCARDNO")), '아니오', '예')); // 현금영수증여부
    sArg += " sResultPrintVirtHpTel=" + quote(divJubsu.edHpTel.Text); // 휴대폰번호
    sArg += " sResultPrintVirtBankCd=" + quote(gds_oPosResult.GetColumn(0, "VIRTBANKCD")); // 입금계좌은행
    sArg += " sResultPrintVirtBankNm=" + quote(gds_oPosResult.GetColumn(0, "VIRTBANKNM")); // 입금계좌은행명
    sArg += " sResultPrintVirtCloseDate=" + quote(gds_oPosResult.GetColumn(0, "VIRTCLOSEDATE")); // 입금마감일

    var ls_RetReult = ""; // 결제처리결과팝업 리턴값용
    ls_RetReult = Dialog("COM::frmCOM3203PSettlementPOSResult.xml", sArg, 500, 316, "", -1, -1);

    return ls_RetReult;
}

/**
 * 포스 처리 전 Settlement insert - 환불
 * 1. ds_ioSettlement, ds_iJubsuH 데이터 셋 필요
 * 2. 각 필드 데이터 입력 값 수정
 */
function lfn_InsertSettlement() {
    ds_ioSettlement.ClearData();
    ds_ioSettlement.InsertRow(0);
    ds_ioSettlement.SetColumn(0, "TSTJMGNO", ds_oRepay.GetColumn(0, "TJHTJMGNO"));
    ds_ioSettlement.SetColumn(0, "TSGUBUNCD", "02"); //환불
    ds_ioSettlement.SetColumn(0, "TSGUBUN", ds_oSunap.GetColumn(0, "TSGUBUN"));
    ds_ioSettlement.SetColumn(0, "TSPROCAMOUNT", toNumber(ds_oSunap.GetColumn(0, "TSPROCAMOUNT")) * (-1));
    ds_ioSettlement.SetColumn(0, "TSTRAININGAMOUNT", toNumber(ds_oSunap.GetColumn(0, "TSTRAININGAMOUNT")) * (-1));
    ds_ioSettlement.SetColumn(0, "TSEXAMAMOUNT", toNumber(ds_oSunap.GetColumn(0, "TSEXAMAMOUNT")) * (-1));
    ds_ioSettlement.SetColumn(0, "TSLICENSEAMOUNT", toNumber(ds_oSunap.GetColumn(0, "TSLICENSEAMOUNT")) * (-1));
    ds_ioSettlement.SetColumn(0, "TSAMOUNTGUBUN", ds_oSunap.GetColumn(0, "TSAMOUNTGUBUN"));
    ds_ioSettlement.SetColumn(0, "TSMGGTMGNO", ds_oJubsu.GetColumn(0, "TOMGGTMGNO"));
    ds_ioSettlement.SetColumn(0, "TSREPAYCD", divRepay.ds_oTrainingRepayFee.GetColumn(divRepay.ds_oTrainingRepayFee.searchrow("REPAY='"+divRepay.cbxTrainingAmount.Value+"'"),"CD")); //환불처리코드:B, 1, 2, 3, 4, 5, A 
    ds_ioSettlement.SetColumn(0, "TSSUNAPACTIONREF", toNumber(ds_oRepay.GetColumn(0, "TSSUNAPACTIONREF")) + 2);
    ds_ioSettlement.SetColumn(0, "TSSEQ", ds_oSunap.GetColumn(0, "TSSEQ"));
    ds_ioSettlement.SetColumn(0, "TSREPAYREF", "0");
    ds_ioSettlement.SetColumn(0, "TSTFCSEQ", ls_TFCSEQ);


	if (toNumber(ds_oSunap.GetColumn(0, "TSTRAININGAMOUNT"))+toNumber(divRepay.cbxTrainingAmount.Value) > 0) {
//    if (divRepay.ds_oTrainingRepayFee.GetColumn(divRepay.ds_oTrainingRepayFee.searchrow("REPAY='"+divRepay.cbxTrainingAmount.Value+"'"),"CD") <> "B") {
    //부분 환불 일 경우
        ds_ioSettlement.InsertRow(0);
        ds_ioSettlement.SetColumn(0, "TSTJMGNO", ds_oRepay.GetColumn(0, "TJHTJMGNO"));
        ds_ioSettlement.SetColumn(0, "TSGUBUNCD", "01"); //수납
        ds_ioSettlement.SetColumn(0, "TSGUBUN", "24"); //인터넷무통장
        ds_ioSettlement.SetColumn(0, "TSPROCAMOUNT", toNumber(ds_oSunap.GetColumn(0, "TSPROCAMOUNT")) + toNumber(divRepay.medAmount.Value));
        ds_ioSettlement.SetColumn(0, "TSTRAININGAMOUNT", toNumber(ds_oSunap.GetColumn(0, "TSTRAININGAMOUNT")) + toNumber(divRepay.ds_oTrainingRepayFee.GetColumn(divRepay.ds_oTrainingRepayFee.searchrow("REPAY='"+divRepay.cbxTrainingAmount.Value+"'"),"REPAY")));
        ds_ioSettlement.SetColumn(0, "TSEXAMAMOUNT", "0");
        ds_ioSettlement.SetColumn(0, "TSLICENSEAMOUNT", "0");
        ds_ioSettlement.SetColumn(0, "TSAMOUNTGUBUN", ds_oSunap.GetColumn(0, "TSAMOUNTGUBUN"));
        ds_ioSettlement.SetColumn(0, "TSMGGTMGNO", ds_oJubsu.GetColumn(0, "TOMGGTMGNO"));
        ds_ioSettlement.SetColumn(0, "TSREPAYCD", "");
        ds_ioSettlement.SetColumn(0, "TSSUNAPACTIONREF", toNumber(ds_oRepay.GetColumn(0, "TSSUNAPACTIONREF")) + 1);
        ds_ioSettlement.SetColumn(0, "TSREPAYREF", "0");
        ds_ioSettlement.SetColumn(0, "TSTFCSEQ", ls_TFCSEQ);
    }

    tit_clearActionInfo();
    tit_addMultiActionInfo("training:insertTrainingSettlement", "", 0, "", "N");
    tit_callService(
        ""
        ,""
        ,"ds_iTrainingSettlement=ds_ioSettlement:U" // inDs
        ,""	// outDs
        ,"" // args
        ,""
        ,false
        ,""
        ,true
    );
}

/**
 * 관리번호 검색
 */
function lfn_SearchMgno() {

    var sArg = "TJHTJMGNO=" + quote(sJubsuNo)
        + " TJHSEQ=" + quote(sTjhSeq)
        + " TJHSTATUSCD=" + quote(sJubsuStatus);

    ds_oPosData.ClearData();
    
    tit_clearActionInfo();
    tit_addCsvSearchActionInfo("training:searchTrainingPosMgno", false);
    tit_callService(
        ""
        ,""
        ,"" // inDs
        ,"ds_oPosData=ds_oPosMgno"	// outDs
        ,sArg // args
        ,""
        ,false
        ,""
        ,true
    );

}

/**
 * POSM 데이터 생성
 */
function lfn_CreatePosData() {

    var ls_Gubun = "";
    var ls_OrderNo = "";
    var ls_PMPIID = "";

    ds_iPosData.ClearData();
    
    for(var i=ds_oPosData.GetRowCount()-1; i>=0; i--) {
    
        ls_Gubun = iif(right(ds_oPosData.GetColumn(i, "PMPCGUBUN"),1) == "1", "0", "1");
        ls_OrderNo = iif(ls_Gubun == "0"
            , ds_oPosData.GetColumn(i, "PMYEAR") + "-" + lpad(ds_oPosData.GetColumn(i, "PMMGNO"),"0",8)
            , ds_oSunap.GetColumn(0, "PMYEAR") + "-" + lpad(ds_oSunap.GetColumn(0, "PMMGNO"),"0",8));

        ls_DeletePosOrderNo[i] = ls_OrderNo;

        ds_iPosData.InsertRow(0);
        ds_iPosData.SetColumn(0, "PMYEAR", ds_oPosData.GetColumn(i, "PMYEAR"));
        ds_iPosData.SetColumn(0, "PMMGNO", ds_oPosData.GetColumn(i, "PMMGNO"));
        ds_iPosData.SetColumn(0, "PMPCORDERNO", ls_OrderNo);
        ds_iPosData.SetColumn(0, "PMINPUT", "1"); //인터넷
        ds_iPosData.SetColumn(0, "PMPCGUBUN", iif(right(ds_oPosData.GetColumn(i, "PMPCGUBUN"),1) == "1", "0", "1"));
        ds_iPosData.SetColumn(0, "PMPROCDATE", left(getDate(),8));
        //ds_iPosData.SetColumn(0, "PMPIID", ds_oRepay.GetColumn(0, "PMPIID"));  // 환불시 처리지부 아이디가 들어가야해서 수정
        if (substr(ds_oRepay.GetColumn(0, "PMPIID"),0,3) == "POS") {
			ls_PMPIID = "POS_kfsa_" + substr(gds_oUserInfo.GetColumn(0, "PDEPTCD"),1,2) + "2";
        } else {
			ls_PMPIID = "kfsa_" + substr(gds_oUserInfo.GetColumn(0, "PDEPTCD"),1,2) + "2";
		}
        ds_iPosData.SetColumn(0, "PMPIID", ls_PMPIID);
        ds_iPosData.SetColumn(0, "PMPGMID", "21"); //강습
        ds_iPosData.SetColumn(0, "PMPGMPK", ds_oPosData.GetColumn(i, "PMPGMPK"));
        ds_iPosData.SetColumn(0, "PMBUYER", ds_oRepay.GetColumn(0, "PMBUYER"));
        ds_iPosData.SetColumn(0, "PMCLAS", ds_oJubsu.GetColumn(0, "TOTCCOURSECD"));
        
        ds_iPosData.SetColumn(0, "PMITEM1", "구    분 : " + ds_oJubsu.GetColumn(0, "TCCOURSENM"));
        ds_iPosData.SetColumn(0, "PMITEM2", "수강자명 : " + ds_oJubsu.GetColumn(0, "TPNM"));
        
        ds_iPosData.SetColumn(0, "PMITEM3", "수강번호 : "
            + iif(ds_oChange.GetColumn(0, "TOAFTERORDER")
                , right(divChange.edOrder.Text,9)
                , edOrderNo.Text
            )
        );
        
        if (ls_Gubun == "0") { //수납 일 때
            ds_iPosData.SetColumn(0, "PMITEM4", "수납일자 : " + left(getDate(),4) + "-" + substr(getDate(),4,2) + "-" + substr(getDate(),6,2));
            ds_iPosData.SetColumn(0, "PMPGMGUBUN", "24");
            ds_iPosData.SetColumn(0, "PMPAYMENTFLAG", "0");
//            ds_iPosData.SetColumn(0, "PCSOCIALBUSINESSNO", ds_oRepay.GetColumn(0, "PCSOCIALBUSINESSNO"));
        } else { //환불 일 때
            ds_iPosData.SetColumn(0, "PMITEM4", "환불일자 : " + left(getDate(),4) + "-" + substr(getDate(),4,2) + "-" + substr(getDate(),6,2));
            ds_iPosData.SetColumn(0, "PMPGMGUBUN", ds_oPosData.GetColumn(i, "PMPGMGUBUN"));
            ds_iPosData.SetColumn(0, "PMPAYMENTFLAG", ds_oPosData.GetColumn(i, "PMPAMENTFLAG"));
        }
        
        ds_iPosData.SetColumn(0, "PMAMT", ds_oPosData.GetColumn(i, "PMAMT"));
        ds_iPosData.SetColumn(0, "PMVAT", 0);
        
        
        if ((ds_oRepay.GetColumn(0, "PMPGMGUBUN") == "22"
                || ds_oRepay.GetColumn(0, "PMPGMGUBUN") == "25")
                && ls_Gubun == "1" //부분수납 임시로 무통장 처리
                ) { //현금 영수증 일 때
            ds_iPosData.SetColumn(0, "PMRESULT", "0");
        } else { //현금 일 때
            ds_iPosData.SetColumn(0, "PMRESULT", "1");
        }
        
        ds_iPosData.SetColumn(0, "PMREGSABUN", gds_oUserInfo.GetColumn(0, "PSABUN") );
        ds_iPosData.SetColumn(0, "PPNM", ds_oJubsu.GetColumn(0, "TCCOURSENM"));

        ds_iPosData.SetColumn(0, "PCGUBUN", ls_Gubun);
        ds_iPosData.SetColumn(0, "PCORDERNO", ls_OrderNo);
        ds_iPosData.SetColumn(0, "PCAMT", ds_oPosData.GetColumn(i, "PMAMT"));
        ds_iPosData.SetColumn(0, "PCVAT", "0");
        ds_iPosData.SetColumn(0, "PCSOCIALBUSINESSNO", ds_oRepay.GetColumn(0, "PCSOCIALBUSINESSNO"));
        ds_iPosData.SetColumn(0, "PCUSERTYPE", ds_oRepay.GetColumn(0, "PCUSERTYPE"));
        ds_iPosData.SetColumn(0, "PCTRANSACTIONCODE", ds_oRepay.GetColumn(0, "PCTRANSACTIONCODE"));
        ds_iPosData.SetColumn(0, "PCPAYTYPE", ds_oRepay.GetColumn(0, "PCPAYTYPE"));
    }
    
    tit_clearActionInfo();
    tit_addMultiActionInfo("training:insertInternetTrainingJubsuRepayPos", "", 0, "", "N");
    tit_callService(
        ""
        ,""
        ,"ds_iInternetTrainingJubsuRepay=ds_iPosData:U" // inDs
        ,""	// outDs
        ,"OTHERAMOUNT=" + quote(divRepay.medOtherAmount.Value) // args
        ,""
        ,false
        ,""
        ,true
    );
    
}

/**
 * 포스 단건 정상 처리 체크
 */
function lfn_CheckSettlement(idx) {
    ds_iJubsuH.ClearData();
    ds_iJubsuH.InsertRow(0);
    ds_iJubsuH.SetColumn(0, "TJHTJMGNO", ds_oPosData.GetColumn(idx, "TSTJMGNO"));
    ds_iJubsuH.SetColumn(0, "TSSEQ", ds_oPosData.GetColumn(idx, "TSSEQ"));
    ds_iJubsuH.SetColumn(0, "TSSUNAPACTIONREF", ds_oRepay.GetColumn(0, "TSSUNAPACTIONREF"));

    tit_clearActionInfo();
    tit_addSingleActionInfo("training:insertInternetTrainingJubsuRepayCheck", "", 0, "");
    tit_callService(
        ""
        ,""
        ,"ds_iInternetTrainingJubsuRepay=ds_iJubsuH:U" // inDs
        ,""	// outDs
        ,"" // args
        ,""
        ,false
        ,""
        ,true
    );
}

/**
 * 포스 정상 처리 후 Settlement update
 */
function lfn_UpdateSettlement() {

    ds_iJubsuH.ClearData();
    ds_iJubsuH.InsertRow(0);
    ds_iJubsuH.SetColumn(0, "TJHTJMGNO", ds_oRepay.GetColumn(0, "TJHTJMGNO"));
    ds_iJubsuH.SetColumn(0, "TJHSTATUSCD", toNumber(sJubsuStatus)+1);
    ds_iJubsuH.SetColumn(0, "TJHMGGTMGNO", gds_oUserInfo.GetColumn(0, "PDEPTCD"));
    ds_iJubsuH.SetColumn(0, "TJHREASON", divRepay.edReason.Text);
    ds_iJubsuH.SetColumn(0, "TSSUNAPACTIONREF", iif(gfn_IsNull(ds_oRepay.GetColumn(0, "TSSUNAPACTIONREF")), "0", ds_oRepay.GetColumn(0, "TSSUNAPACTIONREF")));
    ds_iJubsuH.SetColumn(0, "TOMGNO", sToMgno);
    
    tit_clearActionInfo();
    tit_addSingleActionInfo("training:insertInternetTrainingJubsuRepayAfter", "", 0, "");
    tit_callService(
        ""
        ,""
        ,"ds_iInternetTrainingJubsuRepay=ds_iJubsuH:U" // inDs
        ,""	// outDs
        ,"" // args
        ,"lfn_AfterUpdateSettlement"
        ,false
        ,""
        ,true
    );
}

/**
 * 포스 정상 처리 및 Settlement update 후 수정계산서 발행
 */
function lfn_AfterUpdateSettlement() {

    if (nErrorCode != 0) { // 트랜잭션 에러를 처리한다.
        gfn_ErrorMsg(nErrorCode, strErrorMsg);
        return;
    }
    
    // 부가세 관리번호가 있으면 수정계산서 발행
	if (!gfn_isNull(ds_oSunap.GetColumn(ds_oSunap.currow, "PVVMMGNO"))) {
		var	sVGubun = "";
		// 부분환불 여부
		if (divRepay.ds_oTrainingRepayFee.GetColumn(divRepay.ds_oTrainingRepayFee.searchrow("REPAY='"+divRepay.cbxTrainingAmount.Value+"'"),"CD") <> "B") {
			sVGubun = "1";	// 부분환불
		} else {
			sVGubun = "0";	// 전체환불
		}
	
		tit_clearActionInfo();
		tit_addSingleActionInfo("com:executeEstimatePublication", "", 0, "");
		// 서버 호출
		tit_callService(
			""
			,""
			,""    // inDs
			,"ds_oEstimate=ds_oEstimate" // outDs
			, "GUBUN=" + quote(sVGubun)
			  + " SUNAPDATE=" + quote(left(getDate(),8))
			  + " AMT=" + quote(divRepay.medAmount.Value)
			  + " PVVMMGNO=" + quote(ds_oSunap.GetColumn(ds_oSunap.currow, "PVVMMGNO")) // args
			,"lfn_AfterEstimate"
			,false
			,false
			,true
		);
	} else {
		gfn_Alert("환불이 정상적으로 처리되었습니다.");
	}
}

/**
 *  수정계산서 발행 후 처리
 */
function lfn_AfterEstimate() {

    if (nErrorCode != 0) { // 트랜잭션 에러를 처리한다.
        gfn_ErrorMsg(nErrorCode, strErrorMsg);
        return;
    }
    
	gfn_Alert("환불처리 완료 및 수정계산서가 발행되었습니다.");
    
}


/**
 * 포스 실패 처리 후 Pos delete
 */
function lfn_DeletePos() {

    ds_iPosData.ClearData();

    for(var i=ds_oPosData.GetRowCount()-1; i>=0; i--) {
        ds_iPosData.InsertRow(0);
        ds_iPosData.SetColumn(0, "PMYEAR", ds_oPosData.GetColumn(i, "PMYEAR"));
        ds_iPosData.SetColumn(0, "PMMGNO", ds_oPosData.GetColumn(i, "PMMGNO"));
        ds_iPosData.SetColumn(0, "PMPCORDERNO", ls_DeletePosOrderNo[i]);
        ds_iPosData.SetColumn(0, "PMPAYMENTFLAG", ds_oPosData.GetColumn(i, "PMPAMENTFLAG"));
        ds_iPosData.SetColumn(0, "PMPCGUBUN", iif(right(ds_oPosData.GetColumn(i, "PMPCGUBUN"),1) == "1", "0", "1"));
        ds_iPosData.SetColumn(0, "PMITEM1", ds_oPosData.GetColumn(i, "TSTJMGNO"));
        ds_iPosData.SetColumn(0, "PMITEM2", ds_oPosData.GetColumn(i, "TSSEQ"));
    }

    tit_clearActionInfo();
    tit_addMultiActionInfo("training:deleteInternetTrainingJubsuRepayPos", "", 0, "", "N");
    tit_callService(
        ""
        ,""
        ,"ds_iInternetTrainingJubsuRepay=ds_iPosData:U" // inDs
        ,""	// outDs
        ,"" // args
        ,""
        ,false
        ,""
        ,true
    );
}

/**
 * 실제결강일 검색
 */
function lfn_SearchAttendance() {
    tit_clearActionInfo();
    tit_addCsvSearchActionInfo("training:searchAttendance", false);
    tit_callService(
        ""
        ,""
        ,"" // inDs
        ,"ds_oAttendance=ds_oAttendance" // outDs
        ,"TJMGNO=" + quote(sJubsuNo)
            + " TOMGNO=" + quote(sToMgno)// args
            + " PMREGDATE=" + quote(ds_oRepay.GetColumn(0, "PMREGDATE"))// args
        ,""
        ,false
        ,""
        ,true
    );
    
    if (ds_oAttendance.GetColumn(0,"ADAY") == "B") {
        divRepay.ebAttendance.Text = "교육 시작 전";
    } else if (ds_oAttendance.GetColumn(0,"ADAY") == "A") {
        divRepay.ebAttendance.Text = "교육 시작 후";
    } else {
        divRepay.ebAttendance.Text = ds_oAttendance.GetColumn(0,"ADAY") + "일차 결강";
    }
    
}

// 일정변경신청서 출력
function btnOrderChange_OnClick(obj)
{

}
]]></Script>
</Window>