<?xml version="1.0" encoding="utf-8"?>
<Window>
	<Form BKColor="user0" Height="235" Id="frmprofes0005S01LecHistory" Left="8" OnActivate="frmprofes0005S01LecHistory_OnActivate" OnLoadCompleted="Form_OnLoadCompleted" PidAttrib="7" Style="sty_Form" Title="강의실적_시간표배정" Top="8" Ver="1.0" Width="782" WorkArea="true">
		<Datasets>
			<Dataset DataSetType="Dataset" Id="ds_oEdutype">
				<Contents>
					<colinfo id="EDUTYPE" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
		</Datasets>
		<Shape Bottom="230" Height="214" Id="Shape0" Left="484" LineColor="user15" Right="776" TabOrder="6" Top="16" Type="Rectangle" Width="292"></Shape>
		<Static Align="Center" Height="20" Id="Static8" Left="-144" Style="sty_LabelGruopBox" TabOrder="1" Text="안전원&#32;교수&#32;관리" Top="63" VAlign="Middle" Width="120"></Static>
		<Shape Bottom="230" Height="214" Id="Shape1" Left="4" LineColor="user15" Right="476" TabOrder="2" Top="16" Type="Rectangle" Width="472"></Shape>
		<Button ButtonStyle="TRUE" Cursor="HAND" Height="22" Id="btnAdd" ImageID="BTN_TEXT_03" Left="362" OnClick="btnAdd_OnClick" Style="sty_Button" TabOrder="3" Text="행&#32;추가" Top="19" Transparent="TRUE" Width="53"></Button>
		<Button ButtonStyle="TRUE" Cursor="HAND" Height="22" Id="btnDel" ImageID="BTN_TEXT_03" Left="417" OnClick="btnDel_OnClick" Style="sty_Button" TabOrder="4" Text="행&#32;삭제" Top="19" Transparent="TRUE" Width="53"></Button>
		<Grid AutoEnter="TRUE" AutoFit="TRUE" AutoSelect="TRUE" BindDataset="ds_ioTeachingTimeMaster" BkColor2="user2" BkSelColor="user3" BoldHead="true" Border="Flat" Bottom="226" ColSizing="TRUE" Editable="TRUE" Enable="true" EndLineColor="default" FillAreaType="All" HeadBorder="Flat" HeadHeight="20" Height="182" Id="gdTeachingTimeMaster" InputPanel="FALSE" Left="8" LineColor="default" MinWidth="100" Right="472" RowHeight="20" Style="sty_Grid" TabOrder="5" TabStop="true" Top="44" UseDBuff="true" UsePopupMenu="true" UserData="공통코드목록" UseSelColor="true" Visible="true" VLineColor="default" WheelScrollRow="1" Width="464">
			<contents>
				<format id="Default">
					<columns>
						<col width="40"/>
						<col width="60"/>
						<col width="100"/>
						<col width="180"/>
						<col width="80"/>
					</columns>
					<head>
						<cell align="center" col="0" display="text" text="순번"/>
						<cell align="center" col="1" display="text" text="일차"/>
						<cell align="center" col="2" display="text" text="날짜"/>
						<cell align="center" col="3" display="text" text="시간표유형"/>
						<cell align="center" col="4" display="text" text="시간표시간"/>
					</head>
					<body>
						<cell align="center" col="0" display="number" expr="row+1"/>
						<cell align="center" col="1" colid="LTEDUDAYS" display="text" expr="LTEDUDAYS+&apos;일차&apos;"/>
						<cell align="center" col="2" colid="LTEDUDATE" display="date" edit="date"/>
						<cell align="center" col="3" colid="LTSCHEDULETYPE" combocol="CD" combodataset="ds_oTimeType" combotext="DATA" display="combo" edit="combo"/>
						<cell align="center" col="4" colid="TSHOUR" display="text"/>
					</body>
				</format>
			</contents>
		</Grid>
		<Static Align="Center" Height="20" Id="lblTabTitle" Left="512" Style="sty_LabelGruopBox" TabOrder="7" Text="B유형의&#32;시간표" Top="8" VAlign="Middle" Width="116"></Static>
		<Grid AutoEnter="TRUE" AutoFit="TRUE" AutoSelect="TRUE" BindDataset="ds_ioTeachingTimeDetail" BkColor2="user2" BkSelColor="user3" BoldHead="true" Border="Flat" Bottom="226" ColSizing="TRUE" Enable="true" EndLineColor="default" FillAreaType="All" HeadBorder="Flat" HeadHeight="20" Height="182" Id="gdTeachingTimeDetail" InputPanel="FALSE" Left="488" LineColor="default" MinWidth="100" OnHeadClick="lfn_SortGrid_OnHeadClick" Right="772" RowHeight="20" Style="sty_Grid" TabOrder="8" TabStop="true" Top="44" UseDBuff="true" UsePopupMenu="true" UserData="공통코드목록" UseSelColor="true" Visible="true" VLineColor="default" WheelScrollRow="1" Width="284">
			<contents>
				<format id="Default">
					<columns>
						<col width="52"/>
						<col width="111"/>
						<col width="145"/>
					</columns>
					<head>
						<cell align="center" col="0" display="text" text="순번"/>
						<cell align="center" col="1" display="text" text="교시"/>
						<cell align="center" col="2" display="text" text="교육시간"/>
					</head>
					<body>
						<cell align="center" col="0" display="number" expr="row+1"/>
						<cell align="center" col="1" colid="TSTIME" display="text"/>
						<cell align="center" col="2" colid="EDUTIME" display="text"/>
					</body>
				</format>
			</contents>
		</Grid>
		<Button ButtonStyle="TRUE" Cursor="HAND" Height="22" Id="btnAddBase" ImageID="BTN_TEXT_04" Left="294" OnClick="btnAddBase_OnClick" Style="sty_Button" TabOrder="9" Text="일차생성" Top="19" Transparent="TRUE" Width="66"></Button>
		<Button ButtonStyle="TRUE" Cursor="HAND" Height="22" Id="btnCreateTimeSchedule" ImageID="BTN_TEXT_10" Left="8" OnClick="btnCreateTimeSchedule_OnClick" Style="sty_Button" TabOrder="10" Text="지부별&#32;시간표&#32;생성" Top="19" Transparent="TRUE" Width="145"></Button>
		<Button ButtonStyle="TRUE" Cursor="HAND" Height="22" Id="btnSave" ImageID="BTN_TEXT_03" Left="239" OnClick="btnSave_OnClick" Style="sty_Button" TabOrder="11" Text="저장" Top="19" Transparent="TRUE" Width="53"></Button>
	</Form>
	<Script><![CDATA[/*

 * 프로그램명 : frmPFM0005S01LecHistory.xml

 * 설명 : 강의실적_시간표배정

 * 작성일 : 2009.11.09

 * 작성자 : 김은규

 */



#include "LIB::COMMON.js"; // 공통 관련
var returnval = 0;


var dsParentObj = parent.ds_ioStudyCourse;	//교육과정 데이타셋



/* 공통 필수 시작 */

function Form_OnLoadCompleted(obj) {

    ls_SystemGubun = gs_SystemGubun;
    ls_SystemMenuId = gs_SystemMenuId;

	tit_createActionInfo(); // X-Framework용

}

/*

 * 기능 : 시간표 시간(총시간)을 ds_ioTeachingTimeMaster에 셋팅함.

 * parameter : nRow - ds_ioTeachingTimeMaster 데이타셋의 Row

 * Return : 없음

 */

function lfn_GetTotalTime(nRow) {

	//Insert, Update 된 Row일때

	if(ds_ioTeachingTimeMaster.GetRowType(nRow) <> "Normal") {

		ds_ioTeachingTimeMaster.SetColumn(nRow, "TSHOUR", ds_ioTeachingTimeDetail.GetColumn(0, "SUMTSHOUR"));

	}

}



/*

 * 기능 : 시간표 시간(총시간)을 ds_ioTeachingTimeMaster에 셋팅함.

 * parameter : nRow - ds_ioTeachingTimeMaster 데이타셋의 Row

 * Return : 없음

 */

function lfn_SetTeachingTimeMaster() {

	

	var sEduEndDT = ParseDateTime(dsParentObj.GetColumn(dsParentObj.currow, "EDUEND"));

	var sEduStaDt = ParseDateTime(dsParentObj.GetColumn(dsParentObj.currow, "EDUSTART"));

	var dTerm = sEduEndDT - sEduStaDt;

	 

	//실무교육처럼 하루강의는 일차생성이 안됨.-> 종료시간이 없어서 발생, 

	if (gfn_IsNull(dsParentObj.GetColumn(dsParentObj.currow, "EDUEND"))) {

	    dTerm = 0;
 
	}

	

	ds_ioTeachingTimeMaster.DeleteAll();

	for(var i=0; i<=dTerm; i++) {

		var rIdx = ds_ioTeachingTimeMaster.AddRow();

	

		ds_ioTeachingTimeMaster.SetColumn(rIdx, "LMGNO", dsParentObj.GetColumn(dsParentObj.currow, "EDULMGNO"));	//강의실적관리번호

		ds_ioTeachingTimeMaster.SetColumn(rIdx, "LEDUGUBUN", dsParentObj.GetColumn(dsParentObj.currow, "EDUGUBUN"));//교육과정구분[B:실무 T:강습]

		ds_ioTeachingTimeMaster.SetColumn(rIdx, "LEDUMGNO", dsParentObj.GetColumn(dsParentObj.currow, "EDUMGNO"));	//교육관리번호

		ds_ioTeachingTimeMaster.SetColumn(rIdx, "LGTMGNO", dsParentObj.GetColumn(dsParentObj.currow, "EDUGTMGNO"));	//지부코드

		ds_ioTeachingTimeMaster.SetColumn(rIdx, "LTEDUDAYS", rIdx+1);	//강의일차

		ds_ioTeachingTimeMaster.SetColumn(rIdx, "LTEDUDATE", AddDate(dsParentObj.GetColumn(dsParentObj.currow, "EDUSTART"), rIdx));	//강의일자

	}

}



/* 사용자 이벤트 함수 */



/*

 * 기능 : 시간표 배정 그리드의 행 추가(기본값 셋팅)

 */

function btnAdd_OnClick(obj)

{	
	if(parent.ds_ioStudyCourse.GetColumn(parent.ds_ioStudyCourse.currow, "EDUYEAR") < "2024")
	{
		gfn_Alert("작년 데이터를 수정할 수 없습니다.");
		return;
	}
	
	// 버튼이벤트 발생전, 선택된 로우가 위험물관리자 ( 대리자/교육희망자 ) 신청건이면
	// 버튼이벤트가 발생하지 않도록 처리한다 2023.03.31
	inf_edutypecheck();
	if (returnval == 1) {
		btnAdd.Enable = false;
        return false; 
    }
    
	var rIdx = ds_ioTeachingTimeMaster.AddRow();

	

	ds_ioTeachingTimeMaster.SetColumn(rIdx, "LMGNO", dsParentObj.GetColumn(dsParentObj.currow, "EDULMGNO"));	//강의실적관리번호

	ds_ioTeachingTimeMaster.SetColumn(rIdx, "LEDUGUBUN", dsParentObj.GetColumn(dsParentObj.currow, "EDUGUBUN"));//교육과정구분[B:실무 T:강습]

	ds_ioTeachingTimeMaster.SetColumn(rIdx, "LEDUMGNO", dsParentObj.GetColumn(dsParentObj.currow, "EDUMGNO"));	//교육관리번호

	ds_ioTeachingTimeMaster.SetColumn(rIdx, "LGTMGNO", dsParentObj.GetColumn(dsParentObj.currow, "EDUGTMGNO"));	//지부코드

	ds_ioTeachingTimeMaster.SetColumn(rIdx, "LTEDUDAYS", rIdx+1);	//강의일차

	ds_ioTeachingTimeMaster.SetColumn(rIdx, "LTEDUDATE", AddDate(dsParentObj.GetColumn(dsParentObj.currow, "EDUSTART"), rIdx));	//강의일자

}



/*

 * 기능 : 시간표 배정 그리드의 행 삭제

 */

function btnDel_OnClick(obj)
{
	if(parent.ds_ioStudyCourse.GetColumn(parent.ds_ioStudyCourse.currow, "EDUYEAR") < "2024")
	{
		gfn_Alert("작년 데이터를 수정할 수 없습니다.");
		return;
	}
	
	// 버튼이벤트 발생전, 선택된 로우가 위험물관리자 ( 대리자/교육희망자 ) 신청건이면
	// 버튼이벤트가 발생하지 않도록 처리한다 2023.03.31
	inf_edutypecheck();
	if (returnval == 1) {
		btnDel.Enable = false;
        return false; 
    }
    
	if(ds_ioTeachingTimeMaster.currow+1 == ds_ioTeachingTimeMaster.GetRowCount()) {

		if(ds_ioTeachingTimeMaster.GetRowType(ds_ioTeachingTimeMaster.currow) != "insert") {

			gfn_Alert("행 삭제 후 저장 시에 기존에 저장된 "

						+ ds_ioTeachingTimeMaster.GetColumn(ds_ioTeachingTimeMaster.currow,"LTEDUDAYS")

						+ "일차의 교수배정목록이 모두 초기화 됩니다.");

		}

		ds_ioTeachingTimeMaster.DeleteRow(ds_ioTeachingTimeMaster.currow);

	} else {

		gfn_Alert("마지막 일차 순서대로 행삭제가 가능합니다.");

	}

}





function ds_ioTeachingTimeMaster_OnColumnChanged(obj,nRow,strColumnID,varOldValue,varNewValue,nPivotIndex)

{

	if(strColumnID == "LTSCHEDULETYPE") {

		lfn_SearchTeachingTimeDetail(nRow);	//조회 (시간표배정 디테일)

		frmprofes0005S01LecHistory_OnActivate(obj);

	}

}



function ds_ioTeachingTimeMaster_OnRowPosChanged(obj,nOldRow,nRow)

{

	lfn_SearchTeachingTimeDetail(nRow);	//조회 (시간표배정 디테일)

	frmprofes0005S01LecHistory_OnActivate(obj);

}



function btnAddBase_OnClick(obj)

{
	if(parent.ds_ioStudyCourse.GetColumn(parent.ds_ioStudyCourse.currow, "EDUYEAR") < "2024")
	{
		gfn_Alert("작년 데이터를 수정할 수 없습니다.");
		return;
	}
	
	// 버튼이벤트 발생전, 선택된 로우가 위험물관리자 ( 대리자/교육희망자 ) 신청건이면
	// 버튼이벤트가 발생하지 않도록 처리한다 2023.03.31
	inf_edutypecheck();
	if (returnval == 1) {
		btnAddBase.Enable = false;
        return false; 
    }
    
	lfn_SetTeachingTimeMaster();

}



function btnCreateTimeSchedule_OnClick(obj)

{
	if(parent.ds_ioStudyCourse.GetColumn(parent.ds_ioStudyCourse.currow, "EDUYEAR") < "2024")
	{
		gfn_Alert("작년 데이터를 수정할 수 없습니다.");
		return;
	}
	
	// 버튼이벤트 발생전, 선택된 로우가 위험물관리자 ( 대리자/교육희망자 ) 신청건이면
	// 버튼이벤트가 발생하지 않도록 처리한다 2023.03.31
	inf_edutypecheck();
	if (returnval == 1) {
		btnCreateTimeSchedule.Enable = false;
        return false; 
    }  
    
	var ArrMenuInfo = gfn_SearchMenuInfo("profes", "profes::frmprofes0021MTimeSchedule.xml");	//메뉴정보조회

	if(length(ArrMenuInfo) > 0 ) {

		ls_SystemGubun = arrMenuInfo[7];						//"profes";

		gs_SystemMenuId = arrMenuInfo[5];						//"0000000245";

		global.mnuLeft.tabMenu.tabpgMenu.Text = arrMenuInfo[6];	//"교수관리";

		var ls_MenuId = arrMenuInfo[0];							//"0000000281";

		var ls_MenuTitle = arrMenuInfo[1];						//"강의시간표유형관리";

		var ls_MenuUrl = arrMenuInfo[2];						//"profes::frmprofes0021MTimeSchedule.xml";

		

		global.mnuTop.tabTopMenu.TabIndex = gds_oTopMenu.FindRow("MSYSGUBUN", ls_SystemGubun);

		gfn_OpenChildWindow(ls_MenuUrl, ls_MenuTitle, ls_MenuId, ""); 

	} else {

		gfn_Alert("해당 메뉴를 찾을 수 없습니다.");

	}

}


function frmprofes0005S01LecHistory_OnActivate(obj)

{

	parent.curTabPage = tabTab.tabpgTabPage1;	//current TabPage

	

	if(length(ds_ioTeachingTimeMaster.GetColumn(ds_ioTeachingTimeMaster.currow, "LTSCHEDULETYPE")) > 0) {

		lblTabTitle.Width = 116;

		lblTabTitle.Text = ds_ioTeachingTimeMaster.GetColumn(ds_ioTeachingTimeMaster.currow, "LTSCHEDULETYPE") + "유형의 시간표";

	} else {

		lblTabTitle.Width = 70;

		lblTabTitle.Text = "시간표";

	}

}

function btnSave_OnClick(cFlag)
{
	// 버튼이벤트 발생전, 선택된 로우가 위험물관리자 ( 대리자/교육희망자 ) 신청건이면
	// 버튼이벤트가 발생하지 않도록 처리한다 2023.03.31
	inf_edutypecheck();
	if (returnval == 1) {
		btnsave.Enable = false;
        return false; 
    }    
	
	lfn_Save(cFlag);
}

function inf_edutypecheck()
{
	var nRow = parent.ds_ioStudyCourse.GetCurrow();
	var EDUMGNO = parent.ds_ioStudyCourse.GetColumn(nRow, "EDUMGNO");

	lfn_searchEduType(EDUMGNO);
	
	if(ds_oEdutype.GetRowCount() > 0)
	{
		if(ds_oEdutype.GetColumn(0, "EDUTYPE") == "20") // edutype:20 ==> 실무일정의 교육유형이 : 대리자/교육희망자
		{
			gfn_Alert(" 선택한 교육의 교육유형이 \n\n '대리자/교육희망자' 이면 시간배정 및 \n\n 교수배정을 할 수 없습니다. ");
		}
	}
}

function lfn_searchEduType(EDUMGNO)
{
	tit_clearActionInfo();
    tit_addSearchActionInfo("profes:searchProfes0005Edutype", false);
    // 서버 호출
    tit_callService(
        ""
        ,""
        ,""    // inDs
        ,"ds_oEdutype=ds_oEdutype"    // outDs
        ,"EDUMGNO=" + quote(EDUMGNO)
        ,"ifn_oEdutype"
        ,false
        ,false
        ,true
    );
}

function ifn_oEdutype(nErrorCode, strErrorMsg) {
    if (nErrorCode != 0) { // 트랜잭션 에러를 처리한다.
        gfn_ErrorMsg(nErrorCode, strErrorMsg);
    }
    
    if(ds_oEdutype.GetRowCount() > 0)
    {
		returnval = 1;
    }else {
        returnval = 0;    
    }
}
]]></Script>
</Window>