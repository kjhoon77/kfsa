<?xml version="1.0" encoding="utf-8"?>
<Window>
	<Form BKColor="user0" Height="192" Id="frmcust4030MAutoOverFeeProc" Left="8" OnActivate="Form_OnActivate" OnDeactivate="Form_OnDeactivate" OnFocus="Form_OnFocus" OnKeyDown="Form_OnKeyDown" OnKillFocus="Form_OnKillFocus" OnLoadCompleted="Form_OnLoadCompleted" OnSize="Form_OnSize" OnUnloadCompleted="Form_OnUnloadCompleted" PidAttrib="7" Style="sty_Form" Title="겸직자&#32;회비&#32;자동면제&#32;처리" ToolTipFont="Default,0" Top="8" Ver="1.0" Width="436" WorkArea="true">
		<Datasets>
			<Dataset DataSetType="Dataset" Id="ds_oCustomer">
				<Contents>
					<colinfo id="CMGNO" size="22" summ="default" type="DECIMAL"/>
					<colinfo id="CGTMGNO" size="4" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_iCustomerFee">
				<Contents>
					<colinfo id="CFCMGNO" size="22" summ="default" type="DECIMAL"/>
					<colinfo id="CFSEQ" size="22" summ="default" type="DECIMAL"/>
					<colinfo id="CFSETLMGUBUN" size="1" summ="default" type="STRING"/>
					<colinfo id="CFMEMBERGUBUN" size="1" summ="default" type="STRING"/>
					<colinfo id="CFGUBUN" size="2" summ="default" type="STRING"/>
					<colinfo id="CFGUBUNCD" size="2" summ="default" type="STRING"/>
					<colinfo id="CFSUNAPYEAR" size="4" summ="default" type="STRING"/>
					<colinfo id="CFSUNAPMONTH" size="2" summ="default" type="STRING"/>
					<colinfo id="CFSUNAPHALF" size="1" summ="default" type="STRING"/>
					<colinfo id="CFPROCAMOUNT" size="22" summ="default" type="DECIMAL"/>
					<colinfo id="CFPROCDATE" size="8" summ="default" type="STRING"/>
					<colinfo id="CFPONYGUBUN" size="1" summ="default" type="STRING"/>
					<colinfo id="CFPONYDATE" size="8" summ="default" type="STRING"/>
					<colinfo id="CFMGGTMGNO" size="4" summ="default" type="STRING"/>
					<colinfo id="CFPROCGTMGNO" size="4" summ="default" type="STRING"/>
					<colinfo id="CFPOSGTMGNO" size="4" summ="default" type="STRING"/>
					<colinfo id="CFPMYEAR" size="4" summ="default" type="STRING"/>
					<colinfo id="CFPMMGNO" size="22" summ="default" type="DECIMAL"/>
					<colinfo id="CFGROUPMGNO" size="29" summ="default" type="STRING"/>
					<colinfo id="CFCANCELGUBUN" size="1" summ="default" type="STRING"/>
					<colinfo id="CFCANCELDATE" size="8" summ="default" type="STRING"/>
					<colinfo id="CFCANCELSABUN" size="8" summ="default" type="STRING"/>
					<colinfo id="CFREMARK" size="100" summ="default" type="STRING"/>
					<colinfo id="CFREPAYREF" size="22" summ="default" type="DECIMAL"/>
					<colinfo id="CFACTIVEGUBUN" size="1" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_oJibu">
				<Contents>
					<colinfo id="CD" size="256" summ="default" type="STRING"/>
					<colinfo id="DATA" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
		</Datasets>
		<Shape Bottom="185" Height="116" Id="Shape2" Left="4" LineColor="user15" Right="432" TabOrder="4" Top="69" Type="Rectangle" Width="428"></Shape>
		<Div BKColor="user0" Height="28" Id="divWorkFormTitle" OnLoadCompleted="Form_OnLoadCompleted" Style="sty_Form" TabOrder="1" TabStop="FALSE" Text="Div0" Url="COM::frmCOM0100SWorkFormTitle.xml" Width="252">
			<Contents></Contents>
		</Div>
		<Shape Bottom="29" Height="28" Id="shpBtnBox" Left="260" LineColor="user14" Right="432" TabOrder="3" Top="1" Type="Rectangle" Width="172"></Shape>
		<Button ButtonStyle="TRUE" Cursor="HAND" Height="22" Id="btnEnd" ImageID="BTN_COM_END" Left="344" OnClick="lfn_End" Style="sty_Button" TabOrder="2" ToolTipText="닫기" Top="4" Width="85"></Button>
		<Static Font="굴림,10,Bold" Height="100" Id="lbContents" Left="8" Style="sty_TextBlue" TabOrder="5" Text="&#32;&#32;&#32;고객관리&#32;테이블에서&#32;겸직인&#32;회원들을&#32;찾아서&#13;&#10;&#13;&#10;&#32;&#32;&#32;자동으로&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;년도&#32;회비관리&#32;테이블에&#32;생성시켜&#32;줍니다.&#13;&#10;&#13;&#10;&#32;&#32;&#32;이&#32;작업을&#32;실행하면&#32;결과적으로&#32;기준년도와&#32;겸직자들에&#32;대해&#13;&#10;&#13;&#10;&#32;&#32;&#32;변경이&#32;이루어지므로,&#32;신년에&#32;한번만&#32;작업을&#32;하시면&#32;됩니다." Top="81" Width="420"></Static>
		<Button ButtonStyle="TRUE" Cursor="HAND" Height="22" Id="btnProc" ImageID="BTN_TEXT_05" Left="263" OnClick="btnProc_OnClick" Style="sty_Button" TabOrder="7" Text="작업시작" ToolTipText="합격처리저장" Top="4" Width="79"></Button>
		<Static Color="user6" Font="굴림,10,Bold" Height="12" Id="lbYear" Left="320" Style="sty_TextBlue" TabOrder="6" Top="80" Width="32"></Static>
		<Combo Border="Flat" CodeColumn="CD" DataColumn="DATA" Editable="TRUE" Height="20" Id="cbxJibu" INDEX="0" InnerDataset="ds_oJibu" Left="75" OnFocus="gfn_ComponentOnFocus" OnKeyDown="gfn_EnterNextFocus" OnKillFocus="gfn_ComponentOnKillFocus" ResetIndex="FIRST" Search="NOTFILTERED" Style="sty_Combo" TabOrder="8" Top="43" Value="B" Width="90"></Combo>
		<Static Align="Center" Height="20" Id="lbJibu" Left="8" Style="sty_LabelGruopBox" TabOrder="9" Text="지부" Top="44" VAlign="Middle" Width="64"></Static>
		<Edit Color="user6" Font="굴림,10,Bold" Height="20" Id="edYear" Left="84" MaxLength="4" TabOrder="10" Text="Edit0" Top="103" Width="36"></Edit>
	</Form>
	<Script><![CDATA[/*
 * 프로그램명 : frmcust4030MAutoOverFeeProc.xml
 * 설명 : 겸직자 회비 자동면제 처리
 * 작성일 : 2009.12.30
 * 작성자 : 김동현
 */

#include "LIB::cust.js"; // 공통업무 관련

/* 공통 필수 시작 */
function Form_OnLoadCompleted(obj) {
    gfn_Form_OnLoadCompleted(obj); // 공통 폼 로딩 이벤트 처리

    // 폼 환경설정
    ls_SystemGubun = gs_SystemGubun;
    ls_SystemMenuId = gs_SystemMenuId;
    var ls_FormId = split(sFormUrl, "::");
    ls_FormId = split(ls_FormId[1], ".");
    obj.Title = sFormTitle + "(" + ls_FormId[0] + ")";

    gfn_MakeRequiredInputMark(this); // 필수 입력란을 설정한다.

    ms_FormAuth = gfn_GetFormAuth(this); // 권한을 조회한다.
    if (ms_FormAuth == "W") { // 권한에 따른 버튼 설정
        lfn_SetFormAuth(true); // 저장 권한
    } else if (ms_FormAuth == "R") {
        lfn_SetFormAuth(false); // 읽기 권한
    } else {
        gfn_Alert(MSGI00080);
        close();
    }
    
    gfn_SearchAllJibu(cbxJibu, "Y"); 											// 지부 코드 조회
    
    //lbYear.Text = left(getDate(), 4);				// 당해년도 겸직자료를 만들 경우
    edYear.Text = toNumber(left(getDate(), 4));		// 내년 겸직자료를 미리 만들 경우

}

/**
 * 폼 사이즈
 */
function Form_OnSize(obj,nCx,nCy,nState) {
}

/**
 * 버튼 실행 권한
 */
function lfn_SetFormAuth(bStatus) {
}

/////////////////////////////////////////////////////////////////////////////////
// 기본 버튼
/////////////////////////////////////////////////////////////////////////////////


function btnProc_OnClick(obj) {

    if (!gfn_Confirm("겸직자 자동 겸직면제 처리를 하시겠습니까?")) {
        return;
    }
    
    ds_oCustomer.ClearData(); // 데이타셋 초기화

    tit_clearActionInfo();
    tit_addCsvSearchActionInfo("cust:searchCust4030Customer", false);
    tit_callService(
        ""
        ,""
        ,""	// inDs
        ,"ds_oCustomer=ds_oCustomer"	// outDs
        ,"GTMGNO=" + quote(cbxJibu.Value)
         + " YEAR=" + quote(edYear.Text)// args 
        ,""
        ,false
        ,false
        ,true
    );
	
	ds_iCustomerFee.ClearData(); // 데이타셋 초기화
	for (var i=0; i<ds_oCustomer.GetRowCount(); i++) {
        for (var j=1; j<=12; j++) {
            lfn_SetCustomerFee(ds_oCustomer.GetColumn(i, "CMGNO")
                               , ds_oCustomer.GetColumn(i, "CGTMGNO")
                               , j
                              );
        }
	}

    if (ds_oCustomer.GetRowCount() > 0) {
        tit_clearActionInfo();
        tit_addMultiActionInfo("cust:insertCust2020CustomerFee", "", 0, "", "N");
        tit_callService(
            ""
            ,""
            ,"ds_iCustomerFee=ds_iCustomerFee"	// inDs
            ,""	// outDs
            ,"MUNJE='Y'"	// args 
            ,"lfn_AfterSave"
            ,false
            ,false
            ,true
        );
    } else {
        gfn_Alert("겸직자가 없습니다.");
    }

}

/**
 * 회비/교육비 결제 정보 set
 */
function lfn_SetCustomerFee(nCMgno, sGtMgno, nMonth) {

    var nRow = ds_iCustomerFee.AddRow();
    ds_iCustomerFee.SetColumn(nRow, "CFCMGNO", nCMgno);
//  ds_iCustomerFee.SetColumn(nRow, "CFSEQ", );
    ds_iCustomerFee.SetColumn(nRow, "CFSETLMGUBUN", "0");
    ds_iCustomerFee.SetColumn(nRow, "CFMEMBERGUBUN", "0"); //회원
    ds_iCustomerFee.SetColumn(nRow, "CFGUBUN", "01"); 
	ds_iCustomerFee.SetColumn(nRow, "CFGUBUNCD", "30"); //겸직면제
    ds_iCustomerFee.SetColumn(nRow, "CFSUNAPYEAR", edYear.Text);
    ds_iCustomerFee.SetColumn(nRow, "CFSUNAPMONTH", lpad(nMonth, "0", 2));
    ds_iCustomerFee.SetColumn(nRow, "CFSUNAPHALF", iif(nMonth < 7, "1", "2"));
    ds_iCustomerFee.SetColumn(nRow, "CFPROCAMOUNT", "0");
	//ds_iCustomerFee.SetColumn(nRow, "CFPROCDATE", left(getDate(), 4) + "0101");
	ds_iCustomerFee.SetColumn(nRow, "CFPROCDATE", edYear.Text + "0101");
	ds_iCustomerFee.SetColumn(nRow, "CFPONYGUBUN", "0");
//	ds_iCustomerFee.SetColumn(nRow, "CFPONYDATE", );
	ds_iCustomerFee.SetColumn(nRow, "CFMGGTMGNO", sGtMgno);
	ds_iCustomerFee.SetColumn(nRow, "CFPROCGTMGNO", sGtMgno);
//	ds_iCustomerFee.SetColumn(nRow, "CFPOSGTMGNO",);
//	ds_iCustomerFee.SetColumn(nRow, "CFPMYEAR", );
//	ds_iCustomerFee.SetColumn(nRow, "CFPMMGNO", );
    //ds_iCustomerFee.SetColumn(nRow, "CFGROUPMGNO", left(getDate(), 8) + gds_oUserInfo.GetColumn(0, "PSABUN") + nCMgno);
    ds_iCustomerFee.SetColumn(nRow, "CFGROUPMGNO", edYear.Text + "0101" + gds_oUserInfo.GetColumn(0, "PSABUN") + nCMgno);
//	ds_iCustomerFee.SetColumn(nRow, "CFCANCELDATE", );
//	ds_iCustomerFee.SetColumn(nRow, "CFCANCELSABUN", );
    ds_iCustomerFee.SetColumn(nRow, "CFREMARK", "겸직면제(일괄처리)");
//	ds_iCustomerFee.SetColumn(nRow, "CFREPAYREF", );
    ds_iCustomerFee.SetColumn(nRow, "CFACTIVEGUBUN", "0");

}

/**
 * 저장 후 처리
 */
function lfn_AfterSave(nErrorCode, strErrorMsg) {

    if (nErrorCode != 0) { // 트랜잭션 에러를 처리한다.
        gfn_ErrorMsg(nErrorCode, strErrorMsg);
        gfn_Alert("오류가 발생되었습니다. 정보지원과에 문의 하시기 바랍니다.");
        return "Transaction Error!";
    }
    
    gfn_Alert("자동 겸직면제가 완료되었습니다.");

}

function Form_OnActivate(obj)
{
	gs_SysID = "[stm_01,bsn_1005,dsc_0003]";	// 개인정보접속기록 시스템ID 
}
]]></Script>
</Window>