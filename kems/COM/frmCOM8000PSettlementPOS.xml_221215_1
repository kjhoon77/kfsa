<?xml version="1.0" encoding="utf-8"?>
<Window>
	<Form BKColor="user0" Height="516" Id="frmCOM8000PSettlementPOS" Left="8" OnKeyDown="Form_OnKeyDown" OnLoadCompleted="Form_OnLoadCompleted" OnUnloadCompleted="Form_OnUnloadCompleted" PidAttrib="7" Style="sty_Form" Title="통합영수증발급(POS)시스템팝업" ToolTipFont="Default,0" Top="8" Ver="1.0" Width="800" WorkArea="true">
		<Datasets>
			<Dataset DataSetType="Dataset" Id="ds_oRecieptYn">
				<Contents>
					<colinfo id="CD" size="256" summ="default" type="STRING"/>
					<colinfo id="DATA" size="256" summ="default" type="STRING"/>
					<record>
						<CD>Y</CD>
						<DATA>출력</DATA>
					</record>
					<record>
						<CD>N</CD>
						<DATA>미출력</DATA>
					</record>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_oPosJibu"></Dataset>
			<Dataset DataSetType="Dataset" Id="ds_oPosItem"></Dataset>
			<Dataset DataSetType="Dataset" Id="ds_iSettlementPos">
				<Contents>
					<colinfo id="PROGRAMID" size="256" summ="default" type="STRING"/>
					<colinfo id="SUNAPGUBUN" size="256" summ="default" type="STRING"/>
					<colinfo id="PROCAMOUNT" size="256" summ="default" type="STRING"/>
					<colinfo id="POSYEAR" size="256" summ="default" type="STRING"/>
					<colinfo id="POSMGNO" size="256" summ="default" type="STRING"/>
					<colinfo id="KEY1" size="256" summ="default" type="STRING"/>
					<colinfo id="KEY2" size="256" summ="default" type="STRING"/>
					<colinfo id="PROCDATE" size="256" summ="default" type="STRING"/>
					<colinfo id="PONYDATE" size="256" summ="default" type="STRING"/>
					<colinfo id="PRINTYN" size="256" summ="default" type="STRING"/>
					<colinfo id="BANKSUNAPGUBUN" size="256" summ="default" type="STRING"/>
					<colinfo id="CARDNO" size="256" summ="default" type="STRING"/>
					<colinfo id="CARDINSTALL" size="256" summ="default" type="STRING"/>
					<colinfo id="CASHRECEIPTUSE" size="256" summ="default" type="STRING"/>
					<colinfo id="CASHCARDNO" size="256" summ="default" type="STRING"/>
					<colinfo id="VIRTBANKCODE" size="256" summ="default" type="STRING"/>
					<colinfo id="VIRTCLOSEDATE" size="256" summ="default" type="STRING"/>
					<colinfo id="VIRTHPTEL" size="256" summ="default" type="STRING"/>
					<colinfo id="VIRTCASHRECEIPTYN" size="256" summ="default" type="STRING"/>
					<colinfo id="PAYMENTGUBUN" size="256" summ="default" type="STRING"/>
					<colinfo id="PROCGUBUN" size="256" summ="default" type="STRING"/>
					<colinfo id="PONYGUBUN" size="256" summ="default" type="STRING"/>
					<colinfo id="JIBUMGID" size="256" summ="default" type="STRING"/>
					<colinfo id="VIRTBANKNAME" size="256" summ="default" type="STRING"/>
					<colinfo id="REPAYCD" size="256" summ="default" type="STRING"/>
					<colinfo id="PARTREPAYYN" size="256" summ="default" type="STRING"/>
					<colinfo id="SUNAPACTIONREF" size="256" summ="default" type="STRING"/>
					<colinfo id="REPAYTSSEQ" size="256" summ="default" type="STRING"/>
					<colinfo id="LICENSEAMOUNT" size="256" summ="default" type="STRING"/>
					<colinfo id="EXAMAMOUNT" size="256" summ="default" type="STRING"/>
					<colinfo id="TFCSEQ" size="256" summ="default" type="STRING"/>
					<colinfo id="ORGGUBUN" size="256" summ="default" type="STRING"/>
					<colinfo id="KEY3" size="256" summ="default" type="STRING"/>
					<colinfo id="KEY4" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_oSettlementPos"></Dataset>
			<Dataset DataSetType="Dataset" Id="ds_oPrintHistory"></Dataset>
			<Dataset DataSetType="Dataset" Id="ds_oPosSunap"></Dataset>
			<Dataset DataSetType="Dataset" Id="ds_oDeleteSanap"></Dataset>
			<Dataset DataSetType="Dataset" Id="ds_oTrainingOrderChange"></Dataset>
			<Dataset DataSetType="Dataset" Id="ds_oExecuteRepay"></Dataset>
			<Dataset DataSetType="Dataset" Id="ds_oRepayCancel"></Dataset>
			<Dataset DataSetType="Dataset" Id="ds_oRepayOk"></Dataset>
			<Dataset DataSetType="Dataset" Id="ds_oChangeDate"></Dataset>
			<Dataset DataSetType="Dataset" Id="ds_oTrainingRepayFee">
				<Contents>
					<colinfo id="CD" size="256" summ="default" type="STRING"/>
					<colinfo id="DATA" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_oTrainingAbsentDay">
				<Contents>
					<colinfo id="CD" size="256" summ="default" type="STRING"/>
					<colinfo id="DATA" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_oTrainingSunapFee">
				<Contents>
					<colinfo id="SUNAP" size="22" summ="default" type="DECIMAL"/>
					<colinfo id="SUNAPTEXT" size="10" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_oPosStartInfo"></Dataset>
			<Dataset DataSetType="Dataset" Id="ds_oTrainingEarlySunapFee">
				<Contents>
					<colinfo id="SUNAP" size="22" summ="default" type="DECIMAL"/>
					<colinfo id="SUNAPTEXT" size="10" summ="default" type="STRING"/>
					<colinfo id="TRAININGSUNAP" size="256" summ="default" type="STRING"/>
					<colinfo id="LICENSESUNAP" size="256" summ="default" type="STRING"/>
				</Contents>
			</Dataset>
			<Dataset DataSetType="Dataset" Id="ds_ioTrainingEarlyRepayFee"></Dataset>
			<Dataset DataSetType="Dataset" Id="ds_ioEarlySunapGubun"></Dataset>
			<Dataset DataSetType="Dataset" Id="ds_ioTrainingStartEndDate"></Dataset>
		</Datasets>
		<Shape Bottom="196" Height="100" Id="shpGubunBox3" Left="4" LineColor="user15" Right="796" TabOrder="8" Top="96" Type="Rectangle" Width="792"></Shape>
		<Edit AutoSelect="TRUE" Border="Flat" Enable="FALSE" Height="20" Id="edProcAmount" ImeMode="native" Left="338" LeftMargin="2" OnFocus="gfn_ComponentOnFocus" OnKeyDown="gfn_EnterNextFocus" OnKillFocus="gfn_ComponentOnKillFocus" Readonly="TRUE" Style="sty_Edit" TabOrder="20" Top="124" Visible="FALSE" Width="448"></Edit>
		<Div BKColor="user0" Height="156" Id="divSunap" Left="4" OnLoadCompleted="Form_OnLoadCompleted" Style="sty_Form" TabOrder="22" TabStop="FALSE" Text="Div0" ToolTipFont="Default,0" Top="312" Url="COM::frmCOM8100SSettlementPOSSunap.xml" Width="792">
			<Contents></Contents>
		</Div>
		<Shape Bottom="92" Height="28" Id="shpGubunBox2" Left="4" LineColor="user15" Right="796" TabOrder="5" Top="64" Type="Rectangle" Width="792"></Shape>
		<Shape Bottom="60" Height="28" Id="shpGubunBox1" Left="4" LineColor="user15" Right="796" TabOrder="7" Top="32" Type="Rectangle" Width="792"></Shape>
		<Shape Bottom="28" Height="28" Id="shpBtnBox" Left="705" LineColor="user14" Right="796" TabOrder="6" Top="0" Type="Rectangle" Width="91"></Shape>
		<Button ButtonStyle="TRUE" Cursor="HAND" Height="22" Id="btnEnd" ImageID="BTN_COM_END" Left="708" OnClick="lfn_End" Style="sty_Button" TabOrder="1" ToolTipText="닫기" Top="3" Width="85"></Button>
		<Static Align="Center" Height="20" Id="lbProgramId" Left="8" Style="sty_Label" TabOrder="3" Text="단위프로그램" Top="36" UserData="S" VAlign="Middle" Width="100"></Static>
		<Static Align="Center" Height="20" Id="lbJibuMgId" Left="400" Style="sty_Label" TabOrder="2" Text="지부관리ID" Top="36" VAlign="Middle" Width="100"></Static>
		<Button ButtonStyle="TRUE" Cursor="HAND" Height="22" Id="btnPrintScreen" ImageID="BTN_COM_SCREEN" Left="4" OnClick="lfn_PrintScreen" Style="sty_Button" TabOrder="4" ToolTipText="화면&#32;출력" Top="4" Visible="FALSE" Width="85"></Button>
		<Static Align="Center" Height="20" Id="lbSunapedTotalAmount" Left="8" Style="sty_Label" TabOrder="10" Text="수납된&#32;금액" Top="68" VAlign="Middle" Width="100"></Static>
		<MaskEdit AutoSelect="TRUE" AutoSkip="TRUE" Border="Flat" Enable="FALSE" Height="20" Id="medTotalSunapFee" Left="112" OnFocus="gfn_ComponentOnFocus" OnKeyDown="gfn_EnterNextFocus" OnKillFocus="gfn_ComponentOnKillFocus" Style="sty_Maskedit" TabOrder="9" Top="68" Width="72"></MaskEdit>
		<Edit Align="CENTER" AutoSelect="TRUE" BKColor="#568eb7" Border="None" Cursor="HELP" DisableColor="white" Height="20" Id="edPonyDate" ImeMode="native" Left="232" LeftMargin="2" OnFocus="edPonyDate_OnFocus" Readonly="TRUE" Style="sty_Label" TabOrder="15" Text="정산일자" ToolTipText="방문(직납&#32;OR&#32;은납(통장))에&#32;돈을&#32;입금받은&#32;날짜" Top="148" Width="100"></Edit>
		<Checkbox Height="20" Id="chkPonyDate" Left="336" OnClick="chkPonyDate_OnClick" OnKeyDown="gfn_EnterNextFocus" Style="sty_Checkbox" TabOrder="12" Text="수납일과&#32;틀린&#32;경우" Top="148" Value="FALSE" Width="134"></Checkbox>
		<Calendar Border="Flat" Dateformat="yyyy-MM-dd" DayFont="돋음,9" DaySelect="Auto" EditAlign="CENTER" Enable="FALSE" HeaderFont="돋음,10,Bold" Height="20" Id="calPonyDate" Left="476" OnFocus="gfn_ComponentOnFocus" OnKillFocus="gfn_ComponentOnKillFocus" SaturdayTextColor="blue" SelectedDayFont="돋음,9,Bold" Style="sty_Calendar" SundayTextColor="red" TabOrder="13" Top="148" UserData="I:정산일자" WeeksFont="돋음,9" Width="96"></Calendar>
		<Calendar Border="Flat" Dateformat="yyyy-MM-dd" DayFont="돋음,9" DaySelect="Auto" EditAlign="CENTER" HeaderFont="돋음,10,Bold" Height="20" Id="calSunapDate" Left="112" OnFocus="gfn_ComponentOnFocus" OnKeyDown="gfn_EnterNextFocus" OnKillFocus="gfn_ComponentOnKillFocus" SaturdayTextColor="blue" SelectedDayFont="돋음,9,Bold" Style="sty_Calendar" SundayTextColor="red" TabOrder="11" Top="148" UserData="I:처리일자" WeeksFont="돋음,9" Width="96"></Calendar>
		<Static Align="Center" Height="20" Id="lbSunapDate" Left="8" Style="sty_Label" TabOrder="14" Text="처리일자" Top="148" VAlign="Middle" Width="100"></Static>
		<Static Align="Center" Height="20" Id="lbProcGubun" Left="8" Style="sty_Label" TabOrder="16" Text="결제구분" Top="100" VAlign="Middle" Width="100"></Static>
		<Static Align="Center" Height="20" Id="lbRepayAmount" Left="8" Style="sty_Label" TabOrder="17" Text="환불금액" Top="124" VAlign="Middle" Width="100"></Static>
		<Static Align="Center" Height="20" Id="lbRecieptYn" Left="8" Style="sty_Label" TabOrder="19" Text="영수증출력여부" Top="172" VAlign="Middle" Width="100"></Static>
		<Radio Border="None" CodeColumn="CD" ColumnCount="2" DataColumn="DATA" Height="18" Id="radRecieptYn" INDEX="0" InnerDataset="ds_oRecieptYn" Left="114" OnKeyDown="gfn_EnterNextFocus" Style="sty_Radio" TabOrder="18" Top="173" Value="Y" Width="150"></Radio>
		<Button BKColor="user17" ButtonStyle="TRUE" Cursor="HAND" Font="굴림,10,Bold" Height="44" Id="btnSetlmt" Left="300" OnClick="btnSetlmt_OnClick" Style="sty_Button" TabOrder="21" Text="결제처리" Top="468" Width="200"></Button>
		<Div BKColor="user0" Height="112" Id="divRepay" Left="4" OnLoadCompleted="Form_OnLoadCompleted" Style="sty_Form" TabOrder="23" TabStop="FALSE" Text="Div0" Top="200" Url="COM::frmCOM8051SSettlementPOSRepay.xml" Width="792">
			<Contents></Contents>
		</Div>
		<Combo Border="Flat" CodeColumn="PGMID" DataColumn="PGMNM" Editable="TRUE" Enable="FALSE" Height="20" Id="cbxProgramId" INDEX="0" InnerDataset="gds_oPosProgramId" Left="111" OnFocus="gfn_ComponentOnFocus" OnKeyDown="gfn_EnterNextFocus" OnKillFocus="gfn_ComponentOnKillFocus" ResetIndex="FIRST" Search="NOTFILTERED" Style="sty_Combo" TabOrder="24" Top="35" Width="285"></Combo>
		<Edit AutoSelect="TRUE" Border="Flat" Enable="FALSE" Height="20" Id="edBizGubunNm" ImeMode="native" Left="712" LeftMargin="2" OnFocus="gfn_ComponentOnFocus" OnKeyDown="gfn_EnterNextFocus" OnKillFocus="gfn_ComponentOnKillFocus" Readonly="TRUE" Style="sty_Edit" TabOrder="25" Top="36" Width="80"></Edit>
		<Edit AutoSelect="TRUE" Border="Flat" Enable="FALSE" Height="20" Id="edJibuMgId" ImeMode="native" Left="504" LeftMargin="2" OnFocus="gfn_ComponentOnFocus" OnKeyDown="gfn_EnterNextFocus" OnKillFocus="gfn_ComponentOnKillFocus" Readonly="TRUE" Style="sty_Edit" TabOrder="26" Top="36" Width="204"></Edit>
		<Div BKColor="user0" Height="20" Id="divProcGubun" Left="112" OnLoadCompleted="Form_OnLoadCompleted" Style="sty_Form" TabOrder="27" TabStop="FALSE" Text="Div0" Top="100" Width="632">
			<Contents></Contents>
		</Div>
		<Div BKColor="user0" Height="24" Id="divPos" Left="92" OnLoadCompleted="Form_OnLoadCompleted" OnTimer="frmCOM3010SPOS_OnTimer" OnUnloadCompleted="frmCOM3010SPOS_OnUnloadCompleted" Style="sty_Form" TabOrder="28" TabStop="FALSE" Text="Div0" ToolTipFont="Default,0" Top="4" Url="COM::frmCOM3010SPOS.xml" Visible="FALSE" Width="84">
			<Contents></Contents>
		</Div>
		<Combo Border="Flat" CodeColumn="CD" DataColumn="REPAYTEXT" Height="20" Id="cbxRepayFee" INDEX="0" InnerDataset="ds_oTrainingRepayFee" Left="111" OnChanged="cbxRepayFee_OnChanged" OnFocus="gfn_ComponentOnFocus" OnKeyDown="gfn_EnterNextFocus" OnKillFocus="gfn_ComponentOnKillFocus" ResetIndex="FIRST" Search="NOTFILTERED" Style="sty_Combo" TabOrder="29" Top="123" UserData="I" Width="222"></Combo>
		<Static Align="Center" Height="20" Id="lbAbsentDay" Left="338" Style="sty_Label" TabOrder="30" Text="결강일차" Top="124" VAlign="Middle" Visible="FALSE" Width="100"></Static>
		<Combo Border="Flat" CodeColumn="CD" DataColumn="DATA" Enable="FALSE" Height="20" Id="cbxAbsentDay" INDEX="0" InnerDataset="ds_oTrainingAbsentDay" Left="441" OnChanged="cbxRepayFee_OnChanged" OnFocus="gfn_ComponentOnFocus" OnKeyDown="gfn_EnterNextFocus" OnKillFocus="gfn_ComponentOnKillFocus" ResetIndex="FIRST" Search="NOTFILTERED" Style="sty_Combo" TabOrder="31" Top="123" UserData="I" Visible="FALSE" Width="132"></Combo>
		<Combo Border="Flat" CodeColumn="SUNAP" DataColumn="SUNAPTEXT" Enable="FALSE" Height="20" Id="cbxSunapingAmount" ImeMode="none" INDEX="0" InnerDataset="ds_oTrainingSunapFee" Left="695" OnFocus="gfn_ComponentOnFocus" OnKeyDown="gfn_EnterNextFocus" OnKillFocus="gfn_ComponentOnKillFocus" ResetIndex="FIRST" Search="NOTFILTERED" Style="sty_Combo" TabOrder="32" Top="275" UserData="I:수납금액" Width="98"></Combo>
		<Checkbox FalseValue="N" Height="20" Id="chkCardChangeYn" Left="380" OnClick="chkCardChangeYn_OnClick" Style="sty_Checkbox" TabOrder="33" Text="카드&#32;등&#32;납부방법&#32;변경&#32;시&#32;클릭" Top="100" TrueValue="Y" Value="FALSE" Visible="FALSE" Width="200"></Checkbox>
		<Static Height="18" Id="lbTrainingAndLicenseCostInfo" Left="444" TabOrder="34" Text="TrainingLicenseCost(선수납상세정보)" Top="70" Width="348"></Static>
		<Combo Border="Flat" CodeColumn="SUNAP" DataColumn="SUNAPTEXT" Enable="FALSE" Height="20" Id="cbxEarlySunapingAmount" ImeMode="none" INDEX="0" InnerDataset="ds_oTrainingEarlySunapFee" Left="695" OnChanged="cbxEarlySunapingAmount_OnChanged" OnFocus="gfn_ComponentOnFocus" OnKeyDown="gfn_EnterNextFocus" OnKillFocus="gfn_ComponentOnKillFocus" ResetIndex="FIRST" Search="NOTFILTERED" Style="sty_Combo" TabOrder="35" Top="307" UserData="I:수납금액" Visible="FALSE" Width="98"></Combo>
		<Edit Align="CENTER" BKColor="user4" Border="None" Height="20" Id="edSunapingAmount_Edit" Left="688" TabOrder="36" Top="160" Visible="FALSE" Width="98"></Edit>
		<Edit Align="CENTER" BKColor="user4" Border="None" Height="20" Id="edSunapingAmount_Edit_View" Left="576" TabOrder="37" Top="168" Visible="FALSE" Width="98"></Edit>
		<Div BKColor="user0" Height="24" Id="divSETTLEBANKPos" Left="208" OnLoadCompleted="Form_OnLoadCompleted" OnTimer="frmCOM3010SPOS_OnTimer" OnUnloadCompleted="frmCOM3010SPOS_OnUnloadCompleted" Style="sty_Form" TabOrder="38" TabStop="FALSE" Text="Div0" ToolTipFont="Default,0" Top="4" Url="COM::frmCOM3011SPOS.xml" Visible="FALSE" Width="144">
			<Contents></Contents>
		</Div>
	</Form>
	<Script><![CDATA[/*
 * 프로그램명 : frmCOM8000PSettlementPOS.xml
 * 설명 : 통합영수증발급(POS)시스템팝업
 * 작성일 : 2009.09.11
 * 작성자 : 장성호
 */
#include "LIB::COMMON.js"; // 공통 관련

/* 파라메터
    sProgramId - POS단위업무프로그램
    sKey1 - Key1(접수관리번호)
    sKey2 - Key2(회차관리번호)
    sKey3 - Key3(접수번호)
    sKey4 - Key4(부가세관리번호)
*/
var Amount = 0;
var ms_SunapGubun = ""; // 수납환불구분
var ms_SunapedTotalAmount = ""; // 수납된 금액
var ms_SunapingAmount = ""; // 강습수수료(수납할 금액)
var ms_RepayPosYear = ""; // 환불용 POS년도
var ms_RepayPosMgno = ""; // 환불용 POS관리번호
var ms_RepayPayment = ""; // 결과출력용 납입방법(0,1,2,3)
var ms_RepayAbsenDayGubun = ""; // 결강일차
var ms_HpTel= ""; // 휴대폰번호
var ms_ExecutePosSettlementChangeYn = "N"; //회계 수납환불 실행여부
var ms_SunapActionRef = ""; // TSSUNAPACTIONREF수납환불_REF
var ms_TFCSEQ = "";			// 수수료코드 관리번호

var mb_ShowProgressBar = false; // POS 진행상태
var mb_IsRetry = false; // 재전송여부
var mn_PartRepayCnt = 0; // 부분환불여부용 0:전액환불, 1:납부방법변경 환불, 2:납부방법변경 수납
var ls_OfflinePG = "N"; // 오프라인PG 결제여부

/* 공통 필수 시작 */
function Form_OnLoadCompleted(obj) {

    gfn_Form_OnLoadCompleted(obj); // 공통 폼 로딩 이벤트 처리
    gfn_SearchPosJibu( ds_oPosJibu, "1"); // POS 지부 조회
    
    var ls_PosJibu = substr( gds_oUserInfo.GetColumn(0, "PDEPTCD"), 1, 2); // POS 지부 코드
    cbxProgramId.Value = sProgramId; // 단위업무프로그램
    edBizGubunNm.Text = gds_oPosProgramId.GetColumn( cbxProgramId.Index, "PGMGUBUNNM"); // 사업구분
    edJibuMgId.Text = ds_oPosJibu.GetColumn( ds_oPosJibu.FindRow("PICHPT", ls_PosJibu), "PIID"); // 지부관리ID

    // 관리자의 경우 테스트 수행위해 지부코드 수기입력
    if ( gds_oUserInfo.GetColumn(0, "ADMINGUBUN") == "SM") edJibuMgId.Text = "POS_kfsa_152";	
    calSunapDate.Value = GetDate();
    gfn_SearchCommonCode( ds_oTrainingAbsentDay, "REPAYFEECODE", "Y"); // 결강일차 조회                    !!!
    //  lfnTrainingStartEndDate();       // 강습 회차에 대한 강습 시작일과 종료일 가져옴 (20100101 이전 강습은 선수납 안되게 하기 위함)  !!!  
    lfn_SearchTrainingPosStartInfo(); // POS 처리를 위한 정보들을 조회한다. 그리고 선수납 한 인원인지 조회함   !!!

    medTotalSunapFee.Value = ms_SunapedTotalAmount; // 수납된 금액
        
    lfn_SearchTrainingSunapRepayFee(); // 강습 환불/수납 수수료 조회/강습 회차에 대한 강습 시작일과 종료일 가져옴 (20100101 이전 강습은 선수납 안되게 하기 위함)            !!!

    /////// 강습 비용 + 수첩(시험같이 씀)비용 + 해서 DS 담기 위함 
    lfn_SearchEarlyTrainingSunapRepayFee();  // 선수납용 위 함수 실행후 해야함 ds복사해서 쓰기 때문  !!!
    ///////
                
  //  lfnSearchEarly_TsamountGubun(); // 선수납 한 인원인지 조회함               !!!        
    if ((ds_ioEarlySunapGubun.GetColumn(0, "EARLYGUBUN") == "L") ) { // 선수납일경우 환불시 선수납용 ds로 복사하여 변경 , 새 ds에서 가져와 수납 예정금액 변경하기 
        lfn_SearchTrainingEarlySunapRepayFee();  // 선수납 환불용 ds 만듬 (수첩용)       !!!
        ds_oTrainingRepayFee.Copy(ds_ioTrainingEarlyRepayFee);  // 선수납용(환불) ds를 환불용ds로 복사함
        ms_SunapingAmount = toNumber(ds_oPosStartInfo.GetColumn(0, 'TFCFEE')) - toNumber(ds_ioTrainingEarlyRepayFee.GetColumn(0, 'LICENSEREPAY')); // 강습수수료(수납할 금액 (선수납자는 수첩비10,000 더함)
    }
    else if ((ds_ioEarlySunapGubun.GetColumn(0, "EARLYGUBUN") == "E") ) { // 선수납일경우 환불시 선수납용 ds로 복사하여 변경 , 새 ds에서 가져와 수납 예정금액 변경하기 
        lfn_SearchTrainingEarlySunapRepayFeeExam(); // 선수납 환불용 ds 만듬 (시험용)    !!!
        ds_oTrainingRepayFee.Copy(ds_ioTrainingEarlyRepayFee);  // 선수납용(환불) ds를 환불용ds로 복사함
        ms_SunapingAmount = toNumber(ds_oPosStartInfo.GetColumn(0, 'TFCFEE')) - toNumber(ds_ioTrainingEarlyRepayFee.GetColumn(0, 'LICENSEREPAY')); // 강습수수료(수납할 금액 (선수납자는 수첩비10,000 더함)
    } 
/*    if ( ds_oPosStartInfo.GetColumn(0, 'TOMGGTMGNO') <> gds_oUserInfo.GetColumn(0, "PDEPTCD")) { // 회차관리지부와 처리지부가 다르면
        ms_ExecutePosSettlementChangeYn = "Y"; // 회계 수납환불 수행
    }*/
    
    //trace("shjung ::: toNumber(ms_SunapedTotalAmount) :: " + toNumber(ms_SunapedTotalAmount));
    //trace("shjung ::: toNumber(ms_SunapingAmount) :: " + toNumber(ms_SunapingAmount));
    
    if (toNumber(ms_SunapedTotalAmount) == 0) { // 수납된 금액이 0원이면
    
        ms_SunapGubun = "0"; // 수납환불구분:수납        
		if ( ds_oPosStartInfo.GetColumn(0, 'TOMGGTMGNO') <> gds_oUserInfo.GetColumn(0, "PDEPTCD")) { // 회차관리지부와 처리지부가 다르면
			ms_ExecutePosSettlementChangeYn = "Y"; // 회계 수납환불 수행
		}
        lbRepayAmount.Text = "수납금액"; // 위치 이동에 따른 변경
        divSunap.radSunapGubun.InnerDataset = "ds_oSunapGubun";

  //trace(ms_SunapingAmount);
        // 폼 사이즈 조절
        var ln_TitleSize = window.Height - this.Height;
        window.Height = this.Height + ln_TitleSize - (divSunap.Top - divRepay.Top);
        btnSetlmt.Top = btnSetlmt.Top - (divSunap.Top - divRepay.Top);
        divSunap.Top = divRepay.Top;

        divProcGubun.Url = "COM::frmCOM8031SSettlementGubunTrainingSunap.xml";
        divRepay.Visible = false; // 환불DIV
        cbxSunapingAmount.Visible = true; 
        //////////// 
        cbxEarlySunapingAmount.Visible = true; 
        cbxEarlySunapingAmount.Enable = true; 
        lbTrainingAndLicenseCostInfo.Visible = true;  // 선수납의한 금액 상세 정보
        ////////////           
        //cbxSunapingAmount.Enable = true; // 수납은 조건이 수납된 금액이 0원이므로 무조건 다밭아야 맞는 것 같음.
        cbxSunapingAmount.Left = "111";  //수납시 콤보 위치 지정함
        cbxSunapingAmount.Top = "123";   //수납시 콤보위치 지정함
        ////////////
        cbxEarlySunapingAmount.Left = "111";
        cbxEarlySunapingAmount.Top = "123";
        ////////////
        cbxRepayFee.Visible = false;
        divSunap.lbSunapingAmount.Visible = false;
        cbxSunapingAmount.Value = ms_SunapingAmount;
        cbxSunapingAmount.Enable = true; // 2009.09.29 정현호 대리 요청으로 품
        
    }     
    else if (toNumber(ms_SunapingAmount) == toNumber(ms_SunapedTotalAmount)) { // 수수료와 수납된 금액이 같은 경우 - 전액환불 세팅/부분환불 가능
        
        ms_SunapGubun = "1"; // 수납환불구분:환불		
		if (right(ds_oPosStartInfo.GetColumn(0, 'TSGUBUN'), 1) <> "1") {  // 현금환불이면
			if ( ds_oPosStartInfo.GetColumn(0, 'TSMGGTMGNO') <> gds_oUserInfo.GetColumn(0, "PDEPTCD")) { // 회차관리지부와 처리지부가 다르면
				ms_ExecutePosSettlementChangeYn = "Y"; // 회계 수납환불 수행
			}
		} 
		else {	// 카드환불이면
			if (ds_oPosStartInfo.GetColumn(0, 'TSMGGTMGNO') <> ds_oPosStartInfo.GetColumn(0, "TSPOSGTMGNO")) { // 회차관리지부와 POS지부가 다르면
				ms_ExecutePosSettlementChangeYn = "Y"; // 회계 수납환불 수행
			}	 
		} 
        lbRepayAmount.Text = "환불금액"; // 위치 이동에 따른 변경
        //divSunap.radSunapGubun.InnerDataset = "ds_oRepaySunapGubun";	// 2020.04.21 환불개선 수정

        divProcGubun.Url = "COM::frmCOM8041SSettlementGubunTrainingRepay.xml";
        divRepay.lfn_SearchPosPrintm(); // 결제(환불)정보를 조회한다.
        divRepay.Visible = true;       
        
   		if (right(ds_oPosStartInfo.GetColumn(0, 'TSGUBUN'), 1) == "1") {  // 카드환불이면
			divRepay.lbAutoSend.Visible = false;
			divRepay.radAutoSend.Visible = false;
			divRepay.lbBank.Visible = false;
			divRepay.cbxBank.Visible = false;
			divRepay.lbAccountNo.Visible = false;
			divRepay.edAccountNo.Visible = false;
			divRepay.lbOnlyNumber.Visible = false;
			divRepay.lbAccountNm.Visible = false;
			divRepay.edAccountNm.Visible = false;
			divRepay.lbNMRemark.Visible = false;
   		}
        cbxRepayFee.Visible = true;        
        lbAbsentDay.Visible = true;
        cbxAbsentDay.Visible = true;
        cbxAbsentDay.Value = ms_RepayAbsenDayGubun;
        divSunap.lbSunapingAmount.Visible = true;
        
        if ((ds_ioEarlySunapGubun.GetColumn(0, "EARLYGUBUN") == "L")) { // 선수납일경우 환불시 상세금액 표기 - 수첩비
            lbTrainingAndLicenseCostInfo.Visible = true;  // 선수납의한 금액 상세 정보 보기
            lbTrainingAndLicenseCostInfo.Left = "335"; //수납시 선수납 상세 위치 지정함
            lbTrainingAndLicenseCostInfo.Top = "173";   //수납시 선수납 상세 위치 지정함   
            lbTrainingAndLicenseCostInfo.text = "(강습비 : " + NumFormat(ds_ioTrainingEarlyRepayFee.GetColumn(0, "TRAININGREPAY"))
                        + "원 + 수첩비 : " + NumFormat(ds_ioTrainingEarlyRepayFee.GetColumn(0, "LICENSEREPAY")) + "원)";            
        } 
        else if ((ds_ioEarlySunapGubun.GetColumn(0, "EARLYGUBUN") == "E")) { // 선수납일경우 환불시 상세금액 표기 -  시험비
            lbTrainingAndLicenseCostInfo.Visible = true;  // 선수납의한 금액 상세 정보 보기
            lbTrainingAndLicenseCostInfo.Left = "335"; //수납시 선수납 상세 위치 지정함
            lbTrainingAndLicenseCostInfo.Top = "173";   //수납시 선수납 상세 위치 지정함   
            lbTrainingAndLicenseCostInfo.text = "(강습비 : " + NumFormat(ds_ioTrainingEarlyRepayFee.GetColumn(0, "TRAININGREPAY"))
                        + "원 + 시험비 : " + NumFormat(ds_ioTrainingEarlyRepayFee.GetColumn(0, "LICENSEREPAY")) + "원)";            
        }
        chkCardChangeYn.Visible = true; // 카드변경처리환불
    } 
    else { // 수수료보다 수납된 금액이 작은 경우 - 부분환불
        ms_SunapGubun = "1"; // 수납환불구분:환불
        lbRepayAmount.Text = "환불금액"; // 위치 이동에 따른 변경        
        //divSunap.radSunapGubun.InnerDataset = "ds_oRepaySunapGubun";	// 2020.04.21 환불개선 수정
        divProcGubun.Url = "COM::frmCOM8041SSettlementGubunTrainingRepay.xml";
        divRepay.lfn_SearchPosPrintm(); // 결제(환불)정보를 조회한다.        
		divRepay.Visible = true;
				
   		if (right(ds_oPosStartInfo.GetColumn(0, 'TSGUBUN'), 1) == "1") {  // 카드환불이면
			divRepay.lbAutoSend.Visible = false;
			divRepay.radAutoSend.Visible = false;
			divRepay.lbBank.Visible = false;
			divRepay.cbxBank.Visible = false;
			divRepay.lbAccountNo.Visible = false;
			divRepay.edAccountNo.Visible = false;
			divRepay.lbOnlyNumber.Visible = false;
			divRepay.lbAccountNm.Visible = false;
			divRepay.edAccountNm.Visible = false;
			divRepay.lbNMRemark.Visible = false;
   		}		
        cbxRepayFee.Visible = true;
        cbxRepayFee.Enable = true;
        lbAbsentDay.Visible = true;
        cbxAbsentDay.Visible = true;
        cbxAbsentDay.Value = ms_RepayAbsenDayGubun;
        divSunap.lbSunapingAmount.Visible = true;

        chkCardChangeYn.Visible = true; // 카드변경처리환불
    }
 }

/*
*    //선수납용 수납용 ds 만듬 일반 ds에서 복사해서 편집 (수첩비 10000 추가함 시험비 10000 동일하기 때문에 같이 씀)
*/
function lfn_SearchEarlyTrainingSunapRepayFee(){ // 강습 수첩비 선 환불/수납 수수료 조회 (수첩비 10,000 추가)
    
    ds_oTrainingEarlySunapFee.copy( ds_oTrainingSunapFee);
    ds_oTrainingEarlySunapFee.AddColumn("TRAININGSUNAP", "Decimal", 30);
    ds_oTrainingEarlySunapFee.AddColumn("LICENSESUNAP", "Decimal", 30);
    
    for ( i = 0; i < ds_oTrainingEarlySunapFee.count; i++ )  {       
        ds_oTrainingEarlySunapFee.SetColumn(i, "TRAININGSUNAP", ds_oTrainingEarlySunapFee.GetColumn(i, "SUNAP")); // 이미 있는 강습비용을 TRAININGSUNAP비용으로 넣는다. 
        ds_oTrainingEarlySunapFee.SetColumn(i, "LICENSESUNAP", 10000); // 수첩(시험)비용을 넣는다.    
        ds_oTrainingEarlySunapFee.SetColumn(i, "SUNAPTEXT", NumFormat( ds_oTrainingEarlySunapFee.GetColumn(i, "SUNAP")  + ds_oTrainingEarlySunapFee.GetColumn(i, "LICENSESUNAP"))); //선수납 비용 표시값    
        ds_oTrainingEarlySunapFee.SetColumn(i, "SUNAP", ds_oTrainingEarlySunapFee.GetColumn(i, "SUNAP")  + ds_oTrainingEarlySunapFee.GetColumn(i, "LICENSESUNAP")); //선수납 비용 값    
    }      
}

/*   race(sKey1) 강습접수관리번호
*    회차의 시작일과, 종료일 구하기
*/
function lfnTrainingStartEndDate()
{
    tit_clearActionInfo();
	tit_addSearchActionInfo("com:searchTrainingStartEndDate", false);
	
	// 서버 호출 
	tit_callService( 
		""
		,""
		,""	// inDs
		,"ds_ioTrainingStartEndDate=ds_oTrainingStartEndDate"	// outDs
	   
	    ,"TJMGNO_A=" + quote(sKey1)   //-- 강습접수관리번호 args 
		,""
		,false
		,""
		,true
	);
}

/*   race(sKey1) 강습접수관리번호
*    선수납인원인지 조회하기
*/
function lfnSearchEarly_TsamountGubun()
{

    tit_clearActionInfo();
	tit_addSearchActionInfo("com:searchEarlySunapGubun", false);
	
	// 서버 호출 
	tit_callService( 
		""
		,""
		,""	// inDs
		,"ds_ioEarlySunapGubun=ds_oEarlySunapGubun"	// outDs
	   
	    ,"TJMGNO_A=" + quote(sKey1)   //-- 강습접수관리번호 args 
		,""
		,false
		,""
		,true
	);
}

function Form_OnUnloadCompleted(obj) {
    var arrRet = array(2);
    arrRet[0] = "END";
    Close(arrRet);
}

function Form_OnKeyDown(obj,objSenderObj,nChar,bShift,bControl,bAlt,nLLParam,nHLParam) {
    switch (nChar) {
        case 27 : // 종료(Esc)
            lfn_End();
            break;
        case 123 : // 화면출력(F12)
            lfn_PrintScreen();
            break;
    }
}

/*
 * 기능 : 종료
 */
function lfn_End(obj) {
    var arrRet = array(2);
    arrRet[0] = "END";
    Close(arrRet);
}
/* 공통 필수 종료 */

/* 사용자 함수 */
/*
 * 기능 : POS 호출 전 처리한다.
 * parameter : 없음
 * return value : 없음
 */
function lfn_ExecuteTrainingPosBefore(obj) {
    tit_clearActionInfo();
    tit_addSingleActionInfo("com:executeTrainingPosBefore", "", 0, "");
    // 서버 호출
    tit_callService(
        ""
        ,""
        ,"ds_iSettlementPos=ds_iSettlementPos" // inDs
        ,"ds_oSettlementPos=ds_oSettlementPos" // outDs
        ,""    // args
        ,"lfn_AfterExecuteTrainingPosBefore"
        ,false
        ,false
        ,true
    );
}

/*
 * 기능 : POS 호출 전 처리 후 처리해야 할 내용
 * parameter : nErrorCode - 에러코드
 *             strErrorMsg - 에러메시지
 * Return : 없음
 */
function lfn_AfterExecuteTrainingPosBefore(nErrorCode, strErrorMsg) {
    if (nErrorCode != 0) { // 트랜잭션 에러를 처리한다.
        gfn_ErrorMsg(nErrorCode, strErrorMsg);
        if (ms_SunapGubun == "1") { // 환불
            lfn_ExecuteTrainingPosCancel();
        } else {
            var arrRet = array(2);
            arrRet[0] = "FAIL";
            Close(arrRet);
        }
        return;
    }

    if (ds_oSettlementPos.GetColumn(0, "RESULTCODE") <> "OK") {
        gfn_ErrorMsg(ds_oSettlementPos.GetColumn(0, "RESULTCODE"), ds_oSettlementPos.GetColumn(0, "RESULTMSG"));
        if (ms_SunapGubun == "1") { // 환불
            lfn_ExecuteTrainingPosCancel();
        } else {
            var arrRet = array(2);
            arrRet[0] = "FAIL";
            Close(arrRet);
        }
        return;
    }

    // POS DIV 호출용 데이타셋을 저장한다.
    divPos.ds_ioPosInput.ClearData();
    divPos.ds_ioPosInput.InsertRow(0);
    divPos.ds_ioPosInput.SetColumn(0, "PMYEAR", ds_oSettlementPos.GetColumn(0, "RESULTPMYEAR")); // 영수증 관리년도
    divPos.ds_ioPosInput.SetColumn(0, "PMMGNO", ds_oSettlementPos.GetColumn(0, "RESULTPMMGNO")); // 영수증 관리번호
    divPos.ds_ioPosInput.SetColumn(0, "PRMGUBUN", sProgramId); // POS단위업무프로그램 (강습21,시험22,수첩23)
    divPos.ds_ioPosInput.SetColumn(0, "PAYMENTFLAG", iif(ms_SunapGubun == "0", iif(divSunap.radSunapGubun.Value == "4", "3", divSunap.radSunapGubun.Value),
            decode(right(ds_oPosStartInfo.GetColumn(0, 'TSGUBUN'), 1),
                "3", "0", "4", "0",
                "5", "2", "6", "2",
                right(ds_oPosStartInfo.GetColumn(0, 'TSGUBUN'), 1)
            )
        )); // 납부방법 현금0, 신용카드1, 현금영수증2, 가상계좌3
    divPos.ds_ioPosInput.SetColumn(0, "LGD_METHOD", ms_SunapGubun); // 수납환불구분(수납0,환불1)
    divPos.ds_ioPosInput.SetColumn(0, "STATUS", "4"); // 초기저장시 4

    if (divSunap.radSunapGubun.Value == "1") { // 카드
        divPos.ds_ioPosInput.SetColumn(0, "LGD_PAN", ds_iSettlementPos.GetColumn(0, "CARDNO")); // 카드 전체 번호
    }

    var ls_RecieptYn = "N"; // 현금영수증여부
    if (divSunap.radSunapGubun.Value == "3" && divSunap.divSunabDtl.radRecieptYn.Value == "Y") { // 납부방법 가상계좌에 현금영수증이면
        ls_RecieptYn = "Y";
    }
    divPos.ds_ioPosInput.SetColumn(0, "LGD_CASHRECEIPTYN", ls_RecieptYn); // 가상계좌 현금영수증여부

	if (divSunap.radSunapGubun.Value == "3" || divSunap.radSunapGubun.Value == "4") {  // 가상계좌이면
	
		divPos.ds_ioPosInput.SetColumn(0, "PHONE", divSunap.divSunabDtl.edHpTel.Text); // 휴대폰번호
		
	}
	
	// 환불이고 부분환불이면 부분환불여부 LG유플러스에 넘김
	if (ms_SunapGubun == "1" and divProcGubun.radProcGubun.Value == "P") {	
		divPos.ds_ioPosInput.SetColumn(0, "PARTREPAYYN", "Y"); // 부분환불		
	} 
	else {	
		divPos.ds_ioPosInput.SetColumn(0, "PARTREPAYYN", "N"); // 전체환불	
	}

    ls_ResultPrintReTransYn = "N"; // 재전송버튼여부


	// 현금 자동환불이면(2020.06.25)
	
	if (ms_SunapGubun == "1" && divRepay.radAutoSend.Value == "Y" && ds_iSettlementPos.GetColumn(0, "PAYMENTGUBUN") <> "1") { // 현금(현금영수증포함)이면
		
		lfn_CashAutoSendProc();

		// 현금자동환불 실패 시 종료
		if (gds_ioCashAutoSend.GetColumn(0, "RESULTCODE") <> "0000") {
		
			return false;
			
		}

	}
	

    if ((ds_iSettlementPos.GetColumn(0, "PAYMENTGUBUN") == "0") // 현금
                || ((ds_iSettlementPos.GetColumn(0, "PAYMENTGUBUN") == "3") && (ms_SunapGubun == "1")) // 가상계좌에 환불
            ) {
        lfn_ExecuteTrainingPosOk(); // POS 정상처리 후 처리

        ls_ResultPrintPosMsg = "결제성공"; // 안전원결과메세지
                
        var ls_RetResultPopup = lfn_PopupResultPos(); // 결과출력팝업을 호출한다.
               
        if (radRecieptYn.Value == "Y") { // 영수증 출력
            gfn_PrintReceipt(ds_oSettlementPos.GetColumn(0, "RESULTPMYEAR")
                , ds_oSettlementPos.GetColumn(0, "RESULTPMMGNO")); // 영수증을 출력한다.
        }

        //trace("33"); ///////////////////!!!!!!!!!!!!!!!!!!!!!!!!!
        
        if (ms_SunapGubun == "0") { // 수납환불구분 : 수납
            if (ms_ExecutePosSettlementChangeYn == "Y") { // 회계수납회차변경실행여부
                lfn_ExecutePosSettlementChange(gds_oUserInfo.GetColumn(0, "PDEPTCD"), ds_oPosStartInfo.GetColumn(0, 'TOMGGTMGNO')); // 회계수납회차변경실행
            }
        }

        //trace("dd__"); ///////////////////!!!!!!!!!!!!!!!!!!!!!!!!!
        
        if (ls_RetResultPopup == "OK") {
            if (mn_PartRepayCnt == 1) { // 납부방법변경 환불 실행 중이면
                Amount = Amount + gds_oPosResult.GetColumn(0, "PROCAMT");  // 결제 금액(부분환불 일경우 일부 수납금액 담음)
                lfn_ExecuteSunap(); // 납부방법변경 환불 후 수납 실행
                
                return;
            } 
            else {
                var arrRet = array(4);
                Amount = Amount + gds_oPosResult.GetColumn(0, "PROCAMT");  // 결제 금액(최종결재의 금액을 담음 수납이든 환불이든 현금일경우)
                arrRet[0] = "OK";
                arrRet[1] = ms_SunapGubun;
                arrRet[2] = Amount;  // 결재 금액
                arrRet[3] = iif(divSunap.radSunapGubun.Value == "4", "3", divSunap.radSunapGubun.Value); //납부방법 현금0, 신용카드1, 현금영수증2, 가상계좌3
                Close(arrRet);
                return;
            }
        }
               
        if (mn_PartRepayCnt == 2) { // 납부방법변경 수납 실행 중이면
            gfn_Alert("환불은 성공했으나, 수납은 실패했습니다.\n정보지원과로 문의하시기 바랍니다.");
                var arrRet = array(2);
                arrRet[0] = "FAIL";
                Close(arrRet);
                return;
        } else {
            var arrRet = array(2);
            arrRet[0] = "FAIL";
            Close(arrRet);
            return;
        }        

    } 
    else {	// 현금이 아닌 경우 POS호출
    
		if (ms_SunapGubun == "0") { // 수납인 경우
			if (divSunap.radSunapGubun.Value == "1") { // 카드
				if (divSunap.divSunabDtl.lb_AutoYn) { // KeyIn이 아니면 IC카드 결제
					ls_OfflinePG = "Y";	// 오프라인PG 결제여부 
					lfn_PosCardProc(); 	// 오프라인PG 카드결제				
				} else {	//직접입력(KeyIn)일 경우 카드번호+월+년
					ls_OfflinePG = "N";	// 오프라인PG 결제여부 
					lfn_PosProc();	// 온라인PG 카드결제				
				}
			} else {	// 카드가 아니면
				ls_OfflinePG = "N";	// 오프라인PG 결제여부 
				lfn_PosProc();	// 온라인PG 결제
			}
		} else { 	// 환불인 경우
			ls_OfflinePG = "N";	// 오프라인PG 결제여부 
			lfn_PosProc();	// 온라인PG 결제
		}

    }
}

/*
 * 기능 : POS처리한다.
 * parameter : 없음
 * return value : 없음
 */
function lfn_PosProc() {
    mb_IsRetry = false;

    var sArg = "";
    var ls_PosResultCode = ""; // POS 결과코드
    var ls_RetPos = Dialog("COM::frmCOM8001PPOSProgressBar.xml", sArg, 300, 123, "TitleBar=false", -1, -1);

    if (ls_RetPos == "OK") {
        ls_ResultPrintPosMsg = divPos.ds_ioPosOutput.GetColumn(0, "MI_RSMSG"); // 결과메세지
        ls_PosResultCode = divPos.ds_ioPosOutput.GetColumn(0, "MI_RSCODE"); // 결과코드
    } else if (ls_RetPos == "FAIL"){ // 실패
        ls_ResultPrintPosMsg = divPos.ds_ioPosOutput.GetColumn(0, "MI_RSMSG"); // 결과메세지
        if ("OK" == divPos.lfn_POSSearch()) { // 실시간 POS 결과를 조회한다.
            ls_PosResultCode = divPos.ds_ioPosOutput.GetColumn(0, "MI_RSCODE"); // 결과코드
        } else {
            ls_PosResultCode = "5"; // 결과코드
        }
    } else { // 10초 이후(실패)
        ls_ResultPrintPosMsg = "10초 - 시간 초과입니다.";
        if ("OK" == divPos.lfn_POSSearch()) { // 실시간 POS 결과를 조회한다.
            ls_PosResultCode = divPos.ds_ioPosOutput.GetColumn(0, "MI_RSCODE"); // 결과코드
        } else {
            ls_PosResultCode = "5"; // 결과코드
        }
    }

    switch (ls_PosResultCode) { // POS 결과
        case "0" : // 데이콤 성공, 안전원 성공
            ls_ResultPrintLgdMsg = "결제성공"; // LG데이콤결과메세지
            ls_ResultPrintKemsMsg = "결제성공"; // 안전원결과메세지
            break;
        case "1" : // 데이콤 성공, 안전원 실패
            // 안전원 성공으로 수정
            divPos.ds_ioPosInput.SetColumn(0, "STATUS", "1"); // 초기저장시 4
            var ls_RetRetry = "";
            var ln_Cnt = 0; // 시도회수
            while (true) {
                ls_RetRetry = divPos.lfn_POS(); // POS 호출
                if (ls_RetRetry == "OK") { // 성공
                    if (divPos.ds_ioPosOutput.GetColumn(0, "MI_RSCODE") == "0") { // 결과코드
                        break;
                    }
                }
                if (ln_Cnt == 10) { // 안전원 성공으로 수정하기 실패
                    lfn_SavePosFail(); // 실패정보를 POSFAIL에 저장한다.

                    if (mn_PartRepayCnt == 2) { // 납부방법변경 수납 실행 중이면
                        gfn_Alert("환불은 성공했으나, 수납에서 LG U+ 결제는 성공했으나, 안전원 결제 저장은 실패했습니다.\n정보지원과로 문의하시기 바랍니다.");
                        var arrRet = array(2);
                        arrRet[0] = "KFSA-FAIL";
                        Close(arrRet);
                    } else {
                        gfn_Alert("LG U+ 결제는 성공했으나, 안전원 결제 저장은 실패했습니다.\n정보지원과로 문의하시기 바랍니다.");
                        var arrRet = array(2);
                        arrRet[0] = "KFSA-FAIL";
                        Close(arrRet);
                    }
                }
                ln_Cnt++;
            }

            ls_ResultPrintKemsMsg = "결제성공"; // 안전원결과메세지
            ls_ResultPrintLgdMsg = "결제성공"; // LG데이콤결과메세지
            break;
        case "3" : // 데이콤 실패, 안전원 실패
            ls_ResultPrintKemsMsg = "결제실패"; // 안전원결과메세지
            ls_ResultPrintLgdMsg = "결제실패"; // LG데이콤결과메세지

            ls_ResultPrintReTransYn = "Y"; // 재전송버튼여부
            break;
        case "4" : // 초기 신청 상태
            ls_ResultPrintKemsMsg = "결제실패"; // 안전원결과메세지
            ls_ResultPrintLgdMsg = "결제실패"; // LG데이콤결과메세지

            ls_ResultPrintReTransYn = "Y"; // 재전송버튼여부
            break;
        default : // 결과를 알 수 없는 상태
           if (mn_PartRepayCnt == 2) { // 납부방법변경 수납 실행 중이면
                gfn_Alert("환불은 성공했으나, 수납에서 결제 결과를 알 수가 없습니다.\n정보지원과로 문의하시기 바랍니다.");
                var arrRet = array(2);
                arrRet[0] = "UNKNOWN-FAIL";
                Close(arrRet);
            } else {
                gfn_Alert("결제 결과를 알 수가 없습니다.\n정보지원과로 문의하시기 바랍니다.");
                var arrRet = array(2);
                arrRet[0] = "UNKNOWN-FAIL";
                Close(arrRet);
            }
            break;
    }

    var ls_RetResultPopup = lfn_PopupResultPos(); // 결과출력팝업을 호출한다.
    if (ls_RetResultPopup == "OK") {
        if (radRecieptYn.Value == "Y") { // 영수증 출력
            gfn_PrintReceipt(ds_oSettlementPos.GetColumn(0, "RESULTPMYEAR")
                , ds_oSettlementPos.GetColumn(0, "RESULTPMMGNO")); // 영수증을 출력한다.
        }

        if (ms_SunapGubun == "0") { // 수납환불구분 : 수납
            lfn_ExecuteTrainingPosOk(); // POS 정상처리 후 처리

            if (ms_ExecutePosSettlementChangeYn == "Y") { // 회계수납회차변경실행여부
                lfn_ExecutePosSettlementChange(gds_oUserInfo.GetColumn(0, "PDEPTCD"), ds_oPosStartInfo.GetColumn(0, 'TOMGGTMGNO')); // 회계수납회차변경실행
            }

//            if (mn_PartRepayCnt == 1) { // 납부방법변경 환불 실행 중이면
//                Amount = Amount + gds_oPosResult.GetColumn(0, "PROCAMT");  // 결재 금액(부분환불 일경우 일부 수납금액 담음)
//                lfn_ExecuteRepaySunap(); // 부분환불 수납 후 환불 실행
//                return;
//            } else {
                var arrRet = array(4);
                Amount = Amount + gds_oPosResult.GetColumn(0, "PROCAMT");  // 결재 금액(최종결재의 금액을 담음 수납이든 환불이든)
                arrRet[0] = "OK";
                arrRet[1] = ms_SunapGubun;
                arrRet[2] = Amount;  // 결재 금액   
                arrRet[3] = iif(divSunap.radSunapGubun.Value == "4", "3", divSunap.radSunapGubun.Value); //수납구분 
                Close(arrRet);
//            }
        } else { // 환불
            lfn_ExecuteTrainingPosOk(); // POS 정상처리 후 처리

            if (mn_PartRepayCnt == 1) { // 납부방법변경 환불 실행 중이면
                Amount = Amount + gds_oPosResult.GetColumn(0, "PROCAMT");  // 결재 금액(부분환불 일경우 일부 수납금액 담음)
                lfn_ExecuteSunap(); // 납부방법변경 환불 후 수납 실행
            } else {
                var arrRet = array(4);
                Amount = Amount + gds_oPosResult.GetColumn(0, "PROCAMT");  // 결재 금액(최종결재의 금액을 담음 수납이든 환불이든)
                arrRet[0] = "OK";
                arrRet[1] = ms_SunapGubun;
                arrRet[2] = Amount;  // 결재 금액
                arrRet[3] = iif(divSunap.radSunapGubun.Value == "4", "3", divSunap.radSunapGubun.Value); //수납구분
                Close(arrRet);
            }
        }
    } else if (ls_RetResultPopup == "FAIL") { // 실패
        lfn_ExecuteTrainingPosCancel(); // POS 호출 실패 후 처리
    } else if (ls_RetResultPopup == "RETRANS") {
        mb_IsRetry = true;
        lfn_PosProc(); // POS처리
    }
}

/**
 * POS 전송 처리(오프라인PG)
 */
function lfn_PosCardProc() {
    var sArg = "";
    
		sArg += "sCardYN='Y'";							// 카드결제여부
		sArg += " sCardSETTLEGUBUN=0";					// 0:수납, 1:환불
		sArg += " sLGD_TXNAME='CardAuthOfflinePos'";	// 업무명
		sArg += " sLGD_REQTYPE='APPR'";					// 수납만 오프라인PG 결제처리 (환불은 Cancel)
		sArg += " sLGD_OID=" + ds_oSettlementPos.GetColumn(0, "RESULTPMYEAR")+"-"+lpad(ds_oSettlementPos.GetColumn(0, "RESULTPMMGNO"), "0", 8);
		sArg += " sLGD_AMOUNT=" + ds_iSettlementPos.GetColumn(0, "PROCAMOUNT");					// 결제금액(,없이 입력)
		sArg += " sLGD_INSTALL=" + quote(divSunap.divSunabDtl.cbxInstallment.Value);	//할부개월 (2자리) ex) 00:일시불, 03:3개월
		sArg += " sLGD_PRIVATENO=''";						// 구매자 생년월일 6자리 (YYMMDD) or 사업자번호 10자리
		sArg += " sLGD_NOINT=''";							// 신용카드 무이자할부 여부
		sArg += " sLGD_BUYER=" + replace(ds_oPosStartInfo.GetColumn(0, "TJPERSONNM")," ","");					// 구매자명
		sArg += " sLGD_BUYERID=''";						// 구매자 아이디
		sArg += " sLGD_BUYERPHONE='0'";					// 
		sArg += " sLGD_BUYEREMAIL=''";

		var vPRODUCTINFO = "";		if (sProgramId == "21") {//			vPRODUCTINFO = "강습";						// 구매내역 2019.08.05 주석
			vPRODUCTINFO = "training";						// 구매내역
		} else if (sProgramId == "22") {//			vPRODUCTINFO = "시험";						// 구매내역 2019.08.05 주석
			vPRODUCTINFO = "exam";						// 구매내역
		} else if (sProgramId == "23") {//			vPRODUCTINFO = "수첩";						// 구매내역 2019.08.05 주석
			vPRODUCTINFO = "license";						// 구매내역
		}
		sArg += " sLGD_PRODUCTINFO='padj'";			// 구매내역(분할정산시 padj 입력)
		sArg += " sLGD_DIVIDE_INFO=" + 
						"{"+"'divideinfo'"+":[{"+"'sub_merchantid'"+":"+"'"+ edJibuMgId.Text+"'"+","+
								"'amount'"+":"+"'"+ds_iSettlementPos.GetColumn(0, "PROCAMOUNT")+"'"+","+
								"'productinfo':'"+vPRODUCTINFO+"'}]}";	// 분할정산

		sArg += " sLGD_TAXFREEAMOUNT=" + ds_iSettlementPos.GetColumn(0, "PROCAMOUNT");	// 면세금액
		sArg += " sLGD_VAT='0'";							// 부가세
		sArg += " sVAN_SFEEAMOUNT='0'";					// 봉사료 
		sArg += " sVAN_TRANTYPE='S0'";	// 수납			// (필수)거래구분 S0 : 신용승인요청, K0 : 키인승인요청, E0 : 은련승인요청, P0 : APP카드 승인요청
//			} else {					// 환불				// (필수)거래구분 S1 : 신용취소요청, K1 : 키인취소요청, E1 : 은련취소요청, P1 : APP카드 취소요청        
//				sArg += " sVAN_TRANTYPE='S1'";
//				sArg += " sLGD_TID=''";						// LG유플러스 거래번호 (신용승인응답에서 Tran_serial 값)
//				sArg += " sVAN_CAPDATE=''";					// 원거래 승인일(YYYYMMDD)
//				sArg += " sVAN_AUTHNO=''";					// 원거래 승인번호
//			}
//    trace(sArg);
    var ls_PosResultCode = ""; // POS 결과코드
    var ls_RetPos = Dialog("COM::frmCOM3003PPOSCardProgressBar.xml", sArg, 300, 123, "", -1, -1);

    if (ls_RetPos == "OK") {
        ls_PosMsg = divPos.ds_ioOfflinePosOutput.GetColumn(0, "Msg"); // 결과메세지
        ls_PosResultCode = "0"; // 결과코드 성공

    } else if (ls_RetPos == "FAIL"){ // 실패
        ls_PosMsg = divPos.ds_ioOfflinePosOutput.GetColumn(0, "Msg"); // 결과메세지
        ls_PosResultCode = "3"; // 결과코드

    } else {
        ls_PosResultCode = "5"; // 결과코드
    }
    
    switch (ls_PosResultCode) { // POS 결과
        case "0" : // LG U+ 성공, 안전원 성공
            ls_ResultPrintLgdMsg = "결제성공"; // LG U+ 결과메세지
            ls_ResultPrintKemsMsg = "결제성공"; // 안전원결과메세지
            break;
        case "3" : // LG U+ 실패, 안전원 실패
            ls_ResultPrintKemsMsg = "결제실패"; // 안전원결과메세지
            ls_ResultPrintLgdMsg = "결제실패"; // LG U+ 결과메세지

            ls_ResultPrintReTransYn = "Y"; // 재전송버튼여부
            break;
        case "5" : // 초기 신청 상태
            ls_ResultPrintKemsMsg = "결제실패"; // 안전원결과메세지
            ls_ResultPrintLgdMsg = "결제실패"; // LG U+ 결과메세지

            ls_ResultPrintReTransYn = "Y"; // 재전송버튼여부
            break;
        default : // 결과를 알 수 없는 상태
           if (mn_PartRepayCnt == 2) { // 납부방법변경 수납 실행 중이면
                gfn_Alert("환불은 성공했으나, 수납에서 결제 결과를 알 수 없습니다.\n정보지원과로 문의하시기 바랍니다.");
                var arrRet = array(2);
                arrRet[0] = "UNKNOWN-FAIL";
                Close(arrRet);
            } else {
                gfn_Alert("결제 결과를 알 수 없습니다.\n정보지원과로 문의하시기 바랍니다.");
                var arrRet = array(2);
                arrRet[0] = "UNKNOWN-FAIL";
                Close(arrRet);
            }
            break;
    }

    var ls_RetResultPopup = lfn_PopupResultPos(); // 결과출력팝업을 호출한다.
    if (ls_RetResultPopup == "OK") {

        if (ms_SunapGubun == "0") { // 수납환불구분 : 수납
            lfn_ExecuteTrainingPosOk(); // POS 정상처리 후 처리

			if (radRecieptYn.Value == "Y") { // 영수증 출력
				gfn_PrintReceipt(ds_oSettlementPos.GetColumn(0, "RESULTPMYEAR")
					, ds_oSettlementPos.GetColumn(0, "RESULTPMMGNO")); // 영수증을 출력한다.
			}

            if (ms_ExecutePosSettlementChangeYn == "Y") { // 회계수납회차변경실행여부
                lfn_ExecutePosSettlementChange(gds_oUserInfo.GetColumn(0, "PDEPTCD"), ds_oPosStartInfo.GetColumn(0, 'TOMGGTMGNO')); // 회계수납회차변경실행
            }

//            if (mn_PartRepayCnt == 1) { // 납부방법변경 환불 실행 중이면
//                Amount = Amount + gds_oPosResult.GetColumn(0, "PROCAMT");  // 결재 금액(부분환불 일경우 일부 수납금액 담음)
//                lfn_ExecuteRepaySunap(); // 부분환불 수납 후 환불 실행
//                return;
//            } else {
                var arrRet = array(4);
                Amount = Amount + gds_oPosResult.GetColumn(0, "PROCAMT");  // 결재 금액(최종결재의 금액을 담음 수납이든 환불이든)
                arrRet[0] = "OK";
                arrRet[1] = ms_SunapGubun;
                arrRet[2] = Amount;  // 결재 금액   
                arrRet[3] = iif(divSunap.radSunapGubun.Value == "4", "3", divSunap.radSunapGubun.Value); //수납구분 
                Close(arrRet);
//            }
        } else { // 환불
            lfn_ExecuteTrainingPosOk(); // POS 정상처리 후 처리

			if (radRecieptYn.Value == "Y") { // 영수증 출력
				gfn_PrintReceipt(ds_oSettlementPos.GetColumn(0, "RESULTPMYEAR")
					, ds_oSettlementPos.GetColumn(0, "RESULTPMMGNO")); // 영수증을 출력한다.
			}

            if (mn_PartRepayCnt == 1) { // 납부방법변경 환불 실행 중이면
                Amount = Amount + gds_oPosResult.GetColumn(0, "PROCAMT");  // 결재 금액(부분환불 일경우 일부 수납금액 담음)
                lfn_ExecuteSunap(); // 납부방법변경 환불 후 수납 실행
            } else {
                var arrRet = array(4);
                Amount = Amount + gds_oPosResult.GetColumn(0, "PROCAMT");  // 결재 금액(최종결재의 금액을 담음 수납이든 환불이든)
                arrRet[0] = "OK";
                arrRet[1] = ms_SunapGubun;
                arrRet[2] = Amount;  // 결재 금액
                arrRet[3] = iif(divSunap.radSunapGubun.Value == "4", "3", divSunap.radSunapGubun.Value); //수납구분
                Close(arrRet);
            }
        }

    } else if (ls_RetResultPopup == "FAIL") { // 실패
        lfn_ExecuteTrainingPosCancel(); // POS 호출 실패 후 처리
    } else if (ls_RetResultPopup == "RETRANS") {
        mb_IsRetry = true;
        lfn_PosCardProc(); // POS처리
    }

}


/*
 * 기능 : 세틀뱅크 현금 자동환불 송금처리.
 * parameter : 없음
 * return value : 없음
 */
function lfn_CashAutoSendProc() {
    mb_IsRetry = false;

    var ls_ResultCode = ""; // POS 결과코드
    var ls_ResultMsg = ""; // POS 결과
    
    var sArg = "sbizgubun='2'";
		sArg += " sgtmgno=" + quote(gds_oUserInfo.GetColumn(0, "PDEPTCD"));
		sArg += " sbank=" + quote(right(divRepay.cbxBank.Value,2));
		sArg += " saccount=" + quote(divRepay.edAccountNo.Text);
		sArg += " sname=" + quote(divRepay.edAccountNm.Text);
		sArg += " samt=" + toString(-toNumber(divRepay.medRepayAmount1.Value));
		sArg += " spmyear=" + quote(ds_oSettlementPos.GetColumn(0, "RESULTPMYEAR"));
		sArg += " spmmgno=" + quote(ds_oSettlementPos.GetColumn(0, "RESULTPMMGNO"));
		sArg += " ssabun=" + quote(gds_oUserInfo.GetColumn(0, "PSABUN"));
		
    var ls_RetPos = Dialog("COM::frmCOM8003PCashAutoSendProgressBar.xml", sArg, 300, 123, "TitleBar=false", -1, -1);

    ls_ResultMsg  = gds_ioCashAutoSend.GetColumn(0, "RESULTMSG"); // 결과메세지
    ls_ResultCode = gds_ioCashAutoSend.GetColumn(0, "RESULTCODE"); // 결과코드

	if (ls_RetPos == "OK"){	// 성공
		gfn_Alert("(환불) 현금 자동송금 되었습니다.\n\n" +
				  "환불 완료처리가 진행됩니다.");
	
	} else if (ls_RetPos == "FAIL"){ // 실패
		gfn_Alert("환불(현금 자동송금)에 실패했습니다.\n\n" +
				  "실패사유 : " + ls_ResultMsg + "\n\n"+
				  "정보지원과로 문의하시기 바랍니다.");
        lfn_ExecuteTrainingPosCancel(); // POS 호출 실패 후 처리
		return false;
	}
}	


/*
 * 기능 : 회계 수납환불을 실행한다.
 * parameter : sBeforeJibu - 회계수납환불 전 지부
 *             sAfterJibu - 회계수납환불 후 지부
 * return value : 없음
 */
function lfn_ExecutePosSettlementChange(sBeforeJibu, sAfterJibu) {
    var sArg = "TJMGNO=" + quote(sKey1); // 강습접수관리번호
    sArg += " TSSEQ=" + quote(iif(ms_SunapGubun == "0", ds_oSettlementPos.GetColumn(0, "RESULTSTLNSEQ"), ds_oPosStartInfo.GetColumn(0, 'TSSEQ'))); // 결제순차번호
    sArg += " BEFOREGTMGNO=" + quote(sBeforeJibu); // 회계수납환불 전 지부
    sArg += " AFTERGTMGNO=" + quote(sAfterJibu); // 회계수납환불 후 지부
    sArg += " PROCDATE=" + quote(ds_iSettlementPos.GetColumn(0, "PROCDATE")); // 처리일자
    sArg += " SUNAPACTIONREF=" + quote(ms_SunapActionRef); // TSSUNAPACTIONREF수납환불_REF

    tit_clearActionInfo();
    tit_addSingleActionInfo("com:executePosSettlementChange", "", 0, "");
    // 서버 호출
    tit_callService(
        ""
        ,""
        ,""    // inDs
        ,"ds_oTrainingOrderChange=ds_oTrainingOrderChange"    // outDs
        ,sArg    // args
        ,"lfn_AfterExecutePosSettlementChange"
        ,false
        ,false
        ,true
    );
}

/*
 * 기능 : 회계 수납환불 실행 후 처리해야 할 내용
 * parameter : nErrorCode - 에러코드
 *             strErrorMsg - 에러메시지
 * Return : 없음
 */
function lfn_AfterExecutePosSettlementChange(nErrorCode, strErrorMsg) {
    if (nErrorCode != 0) { // 트랜잭션 에러를 처리한다.
        gfn_ErrorMsg(nErrorCode, strErrorMsg);
        var arrRet = array(2);
        arrRet[0] = "FAIL";
        Close(arrRet);
        return;
    }

    if (ds_oTrainingOrderChange.GetColumn(0, "RESULTCODE") <> "OK") {
        gfn_ErrorMsg(ds_oTrainingOrderChange.GetColumn(0, "RESULTCODE"), ds_oTrainingOrderChange.GetColumn(0, "RESULTMSG"));
        var arrRet = array(2);
        arrRet[0] = "FAIL";
        Close(arrRet);
        return;
    }
    if (ms_SunapGubun == "1") { // 환불
        ds_oPosStartInfo.SetColumn(0, "TSSEQ", ds_oTrainingOrderChange.GetColumn(0, "SETLEMENTSEQ"));
    }
}

/*
 * 기능 : POS 호출 실패 후 처리한다.
 * parameter : 없음
 * return value : 없음
 */

function lfn_ExecuteTrainingPosCancel() {
    var sArg = "PROGRAMID=" + quote(sProgramId); // POS단위업무프로그램 (강습21,시험22,수첩23)
    sArg += " SUNAPGUBUN=" + quote(ms_SunapGubun); // 수납환불구분(수납0,환불1)
    sArg += " POSYEAR=" + quote(ds_oSettlementPos.GetColumn(0, "RESULTPMYEAR")); // 영수증 관리년도
    sArg += " POSMGNO=" + quote(ds_oSettlementPos.GetColumn(0, "RESULTPMMGNO")); // 영수증 관리번호
    sArg += " JUMUNNO=" + quote(ds_oSettlementPos.GetColumn(0, "RESULTJUMUNNO")); // 주문번호
    sArg += " KEY1=" + quote(sKey1); // KEY값1-관리번호
    sArg += " SSEQ=" + quote(ds_oSettlementPos.GetColumn(0, "RESULTSTLNSEQ")); // 결제순차번호
    sArg += " PAYMENTGUBUN=" + quote(ds_iSettlementPos.GetColumn(0, "PAYMENTGUBUN")); // 납부방법
    sArg += " VIRTCASHRECEIPTYN=" + quote(ds_iSettlementPos.GetColumn(0, "VIRTCASHRECEIPTYN")); // 현금영수증사용여부
    sArg += " SUNAPACTIONREF=" + quote(ms_SunapActionRef); // TSSUNAPACTIONREF수납환불_REF

    tit_clearActionInfo();
    tit_addSingleActionInfo("com:executeTrainingPosCancel", "", 0, "");
    // 서버 호출
    tit_callService(
        ""
        ,""
        ,"" // inDs
        ,"ds_oDeleteSanap=ds_oDeleteSanap" // outDs
        ,sArg // args
        ,"lfn_AfterExecuteTrainingPosCancel"
        ,false
        ,false
        ,true
    );
}

/*
 * 기능 : POS 호출 실패 후 처리 후 처리해야 할 내용
 * parameter : nErrorCode - 에러코드
 *             strErrorMsg - 에러메시지
 * Return : 없음
 */
function lfn_AfterExecuteTrainingPosCancel(nErrorCode, strErrorMsg) {
    if (nErrorCode != 0) { // 트랜잭션 에러를 처리한다.
        gfn_ErrorMsg(nErrorCode, strErrorMsg);
        var arrRet = array(2);
        arrRet[0] = "FAIL";
        Close(arrRet);
        return;
    }

    if (mn_PartRepayCnt == 2) { // 납부방법변경 수납 실행 중이면
        gfn_Alert("환불은 성공했으나, 수납에서 실패해서 환불결과를 삭제했습니다.\n정보지원과로 문의하시기 바랍니다.");
        var arrRet = array(2);
        arrRet[0] = "CANCEL"; // 삭제 후 종료
        Close(arrRet);
    } else {
        var arrRet = array(2);
        arrRet[0] = "CANCEL"; // 삭제 후 종료
        Close(arrRet);
    }
}

/*
 * 기능 : POS 정상처리 후 처리한다.
 * parameter : 없음
 * return value : 없음
 */
function lfn_ExecuteTrainingPosOk(obj) {
    var sArg = "TJMGNO=" + quote(sKey1) // 접수번호
        + " TSSEQ=" + quote(ds_oSettlementPos.GetColumn(0, "RESULTSTLNSEQ")) // 결제순차번호
        + " SUNAPGUBUN=" + quote(ms_SunapGubun) // 수납구분
        + " PARTREPAYYN=" + quote(iif(ms_SunapGubun == "0", "N", iif(divProcGubun.radProcGubun.Value == "B", "N", "Y"))) // 부분환불여부
        + " PAYMENT=" + quote(ds_iSettlementPos.GetColumn(0, "PAYMENTGUBUN")) // 납부방법 현금0, 신용카드1, 현금영수증2, 가상계좌3
        + " PASSYN=" + quote(ds_oPosStartInfo.GetColumn(0, 'TJPASSYN')) // 수료여부
        + " CARDCHANGEYN=" + quote(chkCardChangeYn.Value) // 카드변경처리여부
        + " PVVMMGNO=" + quote(sKey4)	// 부가세관리번호(환불시 수정계산서 연동)
        + " REPAYAMT=" + quote(ds_oTrainingRepayFee.GetColumn(ds_oTrainingRepayFee.FindRow("CD", cbxRepayFee.Value) ,"REPAY")) // 환불금액(환불시 수정계산서 연동)
        + " REPAYDATE=" + quote(left(calSunapDate.Value, 8)); // 환불금액(환불시 수정계산서 연동)
    if (ls_OfflinePG == "Y") {	// 오프라인PG 카드결제이면
        sArg += " OFFPG=" + quote(ls_OfflinePG)	// 오프라인PG 결제 여부
            + " SPCAUTHNO=" + quote(divPos.ds_ioOfflinePosOutput.GetColumn(0,"Authno"))				// 승인번호
            + " SPCAUTHDATE=" + quote(divPos.ds_ioOfflinePosOutput.GetColumn(0,"Trandate"))			// 결제일시
            + " SPCRESPONSECODE=" + quote(divPos.ds_ioOfflinePosOutput.GetColumn(0,"Respcode"))		// 응답코드
            + " SPCRESPONSEDATE=" + quote(divPos.ds_ioOfflinePosOutput.GetColumn(0,"Trandate"))		// 결제일시
            + " SPCCARDNO=" + quote(left(divPos.ds_ioOfflinePosOutput.GetColumn(0,"Cardno"),8))				// 카드번호
            + " SPCCARDNM=" + quote(divPos.ds_ioOfflinePosOutput.GetColumn(0,"Financename"))		// 카드사
            + " SPCCARDTYPE=" + quote(divPos.ds_ioOfflinePosOutput.GetColumn(0,"Financecode"))		// 카드종류
            + " SPCTRANSACTION=" + quote(divPos.ds_ioOfflinePosOutput.GetColumn(0,"Tran_serial"))	// 거래번호
            + " SPMPCGUBUN=" + quote(ms_SunapGubun)													// 수납 0 환불 1
            + " SPMPCORDERNO=" + quote(divPos.ds_ioOfflinePosOutput.GetColumn(0,"Oid"));			// 주문번호
    }
    var sService = "com:executeTrainingPosOk";

    tit_clearActionInfo();
    tit_addSingleActionInfo(sService, "", 0, "");
	if (ls_OfflinePG == "Y") {	// 오프라인PG 카드결제이면
		tit_addSingleActionInfo("com:updatePosOkCard", "", 0, "");
	}
    // 서버 호출
    tit_callService(
        ""
        ,""
        ,""    // inDs
        ,"ds_oPosSunap=ds_oPosSunap" // outDs
        ,sArg    // args
        ,"lfn_AfterExecuteTrainingPosOk"
        ,false
        ,false
        ,true
    );
}

/*
 * 기능 : POS 정상처리 후 처리 후 처리해야 할 내용
 * parameter : nErrorCode - 에러코드
 *             strErrorMsg - 에러메시지
 * Return : 없음
 */
function lfn_AfterExecuteTrainingPosOk(nErrorCode, strErrorMsg) {

    if (nErrorCode != 0) { // 트랜잭션 에러를 처리한다.
        gfn_ErrorMsg(nErrorCode, strErrorMsg);
        var arrRet = array(2);
        arrRet[0] = "FAIL";
        Close(arrRet);
        return;
    }

    if (ds_oPosSunap.GetColumn(0, "RESULTCODE") <> "OK") {
        gfn_ErrorMsg(ds_oPosSunap.GetColumn(0, "RESULTCODE"), ds_oPosSunap.GetColumn(0, "RESULTMSG"));
        var arrRet = array(2);
        arrRet[0] = "FAIL";
        Close(arrRet);
        return;
    }
}

/*
 * 기능 : 전액(01)/부분(02) 환불에 따른 DIV을 선택한다.
 * parameter : sRepayGubun - 전액(01)/부분(02) 환불 구분
 * Return : 없음
 */
function lfn_ChangeRepayDiv(sRepayGubun) {

    if (sRepayGubun == "B") { // 전액환불
    
        divSunap.Visible = false;
        // 폼 사이즈 조절
        var ln_TitleSize = window.Height - this.Height;
        window.Height = this.Height + ln_TitleSize - (btnSetlmt.Top - divSunap.Top);
        btnSetlmt.Top = divSunap.Top;

/*
    } else { // 부분환불			// 2020.04.21 환불개선 수정
        divSunap.Visible = true;

        // 폼 사이즈 조절
        var ln_TitleSize = window.Height - this.Height;
        window.Height = ln_TitleSize + (456);
        divSunap.Top = "252";
        btnSetlmt.Top = "408";
*/        
    }
    /////////////////
    if (cbxRepayFee.Value == "S") {
        divSunap.lbSunapingAmount.Visible = false;
        cbxSunapingAmount.Visible = false;
        divSunap.Visible = false;  // 현금 부분 환불 일 경우
         // 폼 사이즈 조절
        var ln_TitleSize = window.Height - this.Height;
        window.Height = this.Height + ln_TitleSize - (btnSetlmt.Top - divSunap.Top);
        btnSetlmt.Top = divSunap.Top;
    }
    if (cbxRepayFee.Value == "M") {
        divSunap.lbSunapingAmount.Visible = false;
        cbxSunapingAmount.Visible = false;
        divSunap.Visible = false;  // 현금 부분 환불 일 경우
         // 폼 사이즈 조절
        var ln_TitleSize = window.Height - this.Height;
        window.Height = this.Height + ln_TitleSize - (btnSetlmt.Top - divSunap.Top);
        btnSetlmt.Top = divSunap.Top;
    }
    /////////////////
}

/*
 * 기능 : POS 처리 후 결과창을 호출한다.
 * parameter : 없음
 * Return : 없음
 */
var ls_ResultPrintPosMsg = ""; // Pos 처리결과 메세지
var ls_ResultPrintLgdMsg = ""; // LG데이콤결과메세지
var ls_ResultPrintKemsMsg = ""; // 안전원결과메세지
var ls_ResultPrintSBMsg = ""; // 세틀뱅크결과메세지
var ls_ResultPrintReTransYn = "N"; // 재전송 여부

function lfn_PopupResultPos() {
    gfn_SearchPosResult(ds_oSettlementPos.GetColumn(0, "RESULTPMYEAR")
        , ds_oSettlementPos.GetColumn(0, "RESULTPMMGNO")
        , gds_oPosResult); // POS 결과 정보를 조회한다.

    var sArg = ""; // 팝업파라메터
    sArg = "sResultPrintSunapGubun=" + quote(gds_oPosResult.GetColumn(0, "SUNAPGUBUN")); // 수납환불구분(수납0,환불1)
    sArg += " sResultPrintBuyerNm=" + quote(gds_oPosResult.GetColumn(0, "BUYER")); // 구매자
    sArg += " sResultPrintProgramNm=" + quote(gds_oPosResult.GetColumn(0, "PGMNM")); // 상품정보
    sArg += " sResultPrintJumunNo=" + quote(gds_oPosResult.GetColumn(0, "JUMUNNO")); // 주문번호
    sArg += " sResultPrintPaymentGubun=" + quote(gds_oPosResult.GetColumn(0, "PAYMENT")); // 납부방법
    sArg += " sResultPrintProcAmount=" + quote(gds_oPosResult.GetColumn(0, "PROCAMT")); // 처리금액
    sArg += " sResultPrintCardNo=" + quote(gds_oPosResult.GetColumn(0, "CARDNO")); // 카드번호
    sArg += " sResultPrintCardInstall=" + quote(gds_oPosResult.GetColumn(0, "CARDINSTALL")); // 할부개월수
    sArg += " sResultPrintCashReceiptUse=" + quote(gds_oPosResult.GetColumn(0, "CASHRECEIPTUSE")); // 현금영수증발급용도
    sArg += " sResultPrintCashCardNo=" + quote(gds_oPosResult.GetColumn(0, "CASHCARDNO")); // 현금영수증번호
    sArg += " sResultPrintVirtCashReceiptYn=" + quote(iif(gfn_IsNull(gds_oPosResult.GetColumn(0, "CASHCARDNO")), '아니오', '예')); // 현금영수증여부
    sArg += " sResultPrintVirtHpTel=" + quote(ds_iSettlementPos.GetColumn(0, "VIRTHPTEL")); // 휴대폰번호
    sArg += " sResultPrintVirtAccount=" + quote(gds_oPosResult.GetColumn(0, "VIRTACCOUNT")); // 가상계좌
    sArg += " sResultPrintVirtBankCd=" + quote(gds_oPosResult.GetColumn(0, "VIRTBANKCD")); // 입금계좌은행
    sArg += " sResultPrintVirtBankNm=" + quote(gds_oPosResult.GetColumn(0, "VIRTBANKNM")); // 입금계좌은행명
    sArg += " sResultPrintVirtCloseDate=" + quote(gds_oPosResult.GetColumn(0, "VIRTCLOSEDATE")); // 입금마감일
    sArg += " sResultKey1=" + quote(sKey2);		// 회차관리번호
    sArg += " sResultKey2=" + quote(sKey1);		// 접수관리번호
    sArg += " sResultKey3=" + quote(sKey3);		// 접수번호

    var ls_RetReult = ""; // 결제처리결과팝업 리턴값용
    var ls_PaymentGubun = gds_oPosResult.GetColumn(0, "PMPAYMENTFLAG");
    if (ls_PaymentGubun == "0") { // 현금               
        ls_RetReult = Dialog("COM::frmCOM8201PSettlementPOSResult.xml", sArg, 400, 228, "", -1, -1);

    } else if (ls_PaymentGubun == "1") { // 카드               
        ls_RetReult = Dialog("COM::frmCOM8202PSettlementPOSResult.xml", sArg, 500, 316, "", -1, -1);
        
    } else if (ls_PaymentGubun == "2") { // 현금영수증                
        ls_RetReult = Dialog("COM::frmCOM8203PSettlementPOSResult.xml", sArg, 500, 316, "", -1, -1);
        
    } else if ((ls_PaymentGubun == "3" && divSunap.radSunapGubun.Value == "3") ||
               (ls_PaymentGubun == "3" && ms_SunapGubun == "1")) { // 가상계좌 
        ls_RetReult = Dialog("COM::frmCOM8204PSettlementPOSResult.xml", sArg, 400, 396, "", -1, -1);        

    } else if (ms_SunapGubun == "0" && ls_PaymentGubun == "3" && divSunap.radSunapGubun.Value == "4") { // 가상계좌(세틀뱅크)
        ls_RetReult = Dialog("COM::frmCOM8205PSettlementPOSResult.xml", sArg, 400, 396, "", -1, -1);        
    }

    return ls_RetReult;
}

/*
 * 기능 : 강습 환불/수납 수수료 정보를 조회한다. 
 * parameter : 없음
 * return : 없음
 */
function lfn_SearchTrainingSunapRepayFee() {
 
    ds_oTrainingRepayFee.ClearData();
    tit_clearActionInfo(); 
    tit_addSearchActionInfo("com:searchTrainingRepayFeeAll", false);
    tit_addSearchActionInfo("com:searchTrainingSunapFeeAll", false);
    tit_addSearchActionInfo("com:searchTrainingStartEndDate", false); 
    // 서버 호출
    tit_callService(
        ""
        ,""
        ,"" // inDs     
        ,"ds_oTrainingRepayFee=ds_oTrainingRepayFee ds_oTrainingSunapFee=ds_oTrainingSunapFee ds_ioTrainingStartEndDate=ds_oTrainingStartEndDate" // outDs  
        ,"TJMGNO=" + quote(sKey1)
        + " TJMGNO_A=" + quote(sKey1)   //-- 강습접수관리번호
           + " sSunapingAmount=" + quote(ms_SunapingAmount) // 수납할 금액           
        ,""
        ,true
        ,true
        ,true
    );        
}

/*
 * 기능 : 강습 환불/수납 수수료 정보(선수납용 - 환불 DS만 구함(수첩용) 수납은 기존 수납의 DS복사해서씀)를 조회한다.
 * parameter : 없음
 * return : 없음
 */
function lfn_SearchTrainingEarlySunapRepayFee() {
    ds_ioTrainingEarlyRepayFee.ClearData();

    tit_clearActionInfo();
    tit_addSearchActionInfo("com:searchTrainingEarlyRepayFeeAll", false);

    // 서버 호출
    tit_callService(
        ""
        ,""
        ,"" // inDs
        ,"ds_ioTrainingEarlyRepayFee=ds_oTrainingEarlyRepayFee" // outDs
        ,"TJMGNO=" + quote(sKey1)
            + " sSunapingAmount=" + quote(ms_SunapingAmount) // 수납할 금액
        ,""
        ,true
        ,true
        ,true
    );
}

/*
 * 기능 : 강습 환불/수납 수수료 정보(선수납용 - 환불 DS만 구함(시험용) 수납은 기존 수납의 DS복사해서씀)를 조회한다.
 * parameter : 없음
 * return : 없음
 */
function lfn_SearchTrainingEarlySunapRepayFeeExam() {
    ds_ioTrainingEarlyRepayFee.ClearData();

    tit_clearActionInfo();
    tit_addSearchActionInfo("com:searchTrainingEarlyRepayFeeAllExam", false);

    // 서버 호출
    tit_callService(
        ""
        ,""
        ,"" // inDs
        ,"ds_ioTrainingEarlyRepayFee=ds_oTrainingEarlyRepayFee" // outDs
        ,"TJMGNO=" + quote(sKey1)
            + " sSunapingAmount=" + quote(ms_SunapingAmount) // 수납할 금액
        ,""
        ,true
        ,true
        ,true
    );
}

/* 사용자 이벤트 함수 */
function chkPonyDate_OnClick(obj,strValue) {
    if (chkPonyDate == "1") {
        calPonyDate.Value = AddDate(GetDate(), -1);
        calPonyDate.Enable = true;
    } else {
        calPonyDate.Value = "";
        calPonyDate.Enable = false;
    }
}



/*
* 수첩비 현금 환불
*/
function EarlyRepay() {   
    tit_clearActionInfo();
    tit_AddSingleActionInfo(
    
        "training:insertFailPassLicenseRepaySingle"	// insert  		
        , ""	// update  
        , ""	// delete
        , ""	// flag column 명
        , ""	// key sql id
        , 0	// key 증가 값
        , "" 
        , 0 
        , "N"	// 실행타입
    );
    // 서버 호출 
    tit_callService(
        ""
        ,""
        ,""//ds_iFailPassLicenseRepaySingle=ds_ioEjpassEarlyLicenseAlreadySunab:U"/// inDs   // 일반수납인지 선수납인지에 따라 다름     
        ,""	// outDs
        ,"EJLICENSEAMTTJMGNO=" + quote(sKey1)
         + " PROCDATE_A=" + quote(calSunapDate.Value)	// args
                   	
        // args 
        ,"lfn_AfterSaveJubsuList"
        ,false
    );
}

/*
* 시험 현금 환불
*/
function EarlyRepayExam() {   
    tit_clearActionInfo();
    tit_AddSingleActionInfo(
    
        "training:insertFailPassExamRepaySingle"	// insert  		
        , ""	// update  
        , ""	// delete
        , ""	// flag column 명
        , ""	// key sql id
        , 0	// key 증가 값
        , "" 
        , 0 
        , "N"	// 실행타입
    );
    // 서버 호출 
    tit_callService(
        ""
        ,""
        ,""//ds_iFailPassLicenseRepaySingle=ds_ioEjpassEarlyLicenseAlreadySunab:U"/// inDs   // 일반수납인지 선수납인지에 따라 다름     
        ,""	// outDs
        ,"EJLICENSEAMTTJMGNO=" + quote(sKey1)
         + " PROCDATE_A=" + quote(calSunapDate.Value)	// args
                   	
        // args 
        ,"lfn_AfterSaveJubsuListExam"
        ,false
    );
}

/*
* 시험
*/
function lfn_AfterSaveJubsuListExam(nErrorCode, strErrorMsg) {

    if (nErrorCode != 0) { // 트랜잭션 에러를 처리한다.

        gfn_ErrorMsg(nErrorCode, strErrorMsg);
        return;
    } 
    var ls_RetReult = ""; // 결제처리결과팝업 리턴값용
    var sArg = ""; // 팝업파라메터
    sArg = "sResultPrintSunapGubun=" + quote("환불"); // 수납환불구분(수납0,환불1)
    sArg += " sResultPrintBuyerNm=" + quote(ds_ioTrainingStartEndDate.GetColumn(0, "TJPERSONNM")); // 구매자
    sArg += " sResultPrintProgramNm=" + quote("시험응시 수수료"); // 상품정보
    sArg += " sResultPrintJumunNo=" + quote(ds_ioTrainingStartEndDate.GetColumn(0, "JUMUNNUMBER")); // 주문번호
   // sArg += " sResultPrintProcAmount=" + quote(ds_ioTrainingStartEndDate.GetColumn(0, "TSEXAMAMOUNT")); // 처리금액
    sArg += " sResultPrintProcAmount=" + quote(-10000); // 처리금액
    ls_RetReult = Dialog("COM::frmCOM8201PSettlementPOSResult.xml", sArg, 400, 228, "", -1, -1);
    //gfn_SaveMessage(); 
    Close(ls_RetReult);
    
}

/*
* 수첩
*/
function lfn_AfterSaveJubsuList(nErrorCode, strErrorMsg) {

    if (nErrorCode != 0) { // 트랜잭션 에러를 처리한다.

        gfn_ErrorMsg(nErrorCode, strErrorMsg);
        return;
    } 
    var ls_RetReult = ""; // 결제처리결과팝업 리턴값용
    var sArg = ""; // 팝업파라메터
    sArg = "sResultPrintSunapGubun=" + quote("환불"); // 수납환불구분(수납0,환불1)
    sArg += " sResultPrintBuyerNm=" + quote(ds_ioTrainingStartEndDate.GetColumn(0, "TJPERSONNM")); // 구매자
    sArg += " sResultPrintProgramNm=" + quote("수첩교부 수수료"); // 상품정보
    sArg += " sResultPrintJumunNo=" + quote(ds_ioTrainingStartEndDate.GetColumn(0, "JUMUNNUMBER")); // 주문번호
   // sArg += " sResultPrintProcAmount=" + quote(ds_ioTrainingStartEndDate.GetColumn(0, "TSLICENSEAMOUNT")); // 처리금액
    sArg += " sResultPrintProcAmount=" + quote(-10000);
    ls_RetReult = Dialog("COM::frmCOM8201PSettlementPOSResult.xml", sArg, 400, 228, "", -1, -1);
    //gfn_SaveMessage(); 
    Close(ls_RetReult);
    
}
// 결제처리
function btnSetlmt_OnClick(obj) {
    if (!gfn_FormValidate(this)) { // 입력 Validation Check
        return false;
    }

    ds_iSettlementPos.ClearData();
    divPos.ds_ioPosInput.ClearData(); // POS INPUT용


	//alert(ds_oTrainingRepayFee.GetColumn(ds_oTrainingRepayFee.FindRow("CD", cbxRepayFee.Value) ,"REPAY"));
	
	//return false;
	
    if ((chkPonyDate.Value == "1" )
            && (left(calSunapDate.Value, 8) <= left(calPonyDate.Value, 8))) {
        gfn_Alert("정산일자는 처리일자보다 이전이어야 합니다.");
        calPonyDate.SetFocus();
        return false;
    }

    // 강습결제정보를 저장한다.
    if (ms_SunapGubun == "0") { // 수납환불구분 : 수납
        if (!gfn_Confirm("[ " + divSunap.radSunapGubun.Text + " ] 결제처리 하시겠습니까?")) {
            return false;
        }
        if (ds_oPosStartInfo.GetColumn(0, 'TFCFEE') <> cbxSunapingAmount.Value) { // 강습수수료와 수납금액
            if (!gfn_Confirm("강습수수료(" + NumFormat(ds_oPosStartInfo.GetColumn(0, 'TFCFEE')) + "원) 전액 수납이 아닙니다.\n결제처리 하시겠습니까?")) {
                return false;
            }
        } 

        // POS처리용 데이타셋을 설정한다.
        ds_iSettlementPos.InsertRow(0);
        
        // 가상 계좌일 경우 POS_kfsa_012 에서 _kfsa_012 로 변경함
        //if (divSunap.radSunapGubun.Value == "3" || divSunap.radSunapGubun.Value == "4") {   // 납부방법  가상계좌
        //    ds_iSettlementPos.SetColumn(0, "JIBUMGID", replace(edJibuMgId.Text, "POS_", "")); // 카드/지부상점ID
        //    trace("수납" + ds_iSettlementPos.GetColumn(0, "JIBUMGID"));            
        //} else {
            ds_iSettlementPos.SetColumn(0, "JIBUMGID", edJibuMgId.Text); // 카드/지부상점ID
        //}

        ds_iSettlementPos.SetColumn(0, "TFCSEQ", ms_TFCSEQ);	// 수수료코드 관리번호 추가 2012.01.19
        ds_iSettlementPos.SetColumn(0, "PROGRAMID", sProgramId); // POS단위업무프로그램 (강습21,시험22,수첩23)        
        ds_iSettlementPos.SetColumn(0, "SUNAPGUBUN", ms_SunapGubun); // 수납환불구분(수납0,환불1)        
        ds_iSettlementPos.SetColumn(0, "PARTREPAYYN", 'N'); // 부분환불여부(Y:부분환불,N:부분환불아님)
        ds_iSettlementPos.SetColumn(0, "POSYEAR", ms_RepayPosYear); // 환불용 POS년도
        ds_iSettlementPos.SetColumn(0, "POSMGNO", ms_RepayPosMgno); // 환불용 POS관리번호
        ds_iSettlementPos.SetColumn(0, "KEY1", sKey1); // KEY값1-관리번호
        //ds_iSettlementPos.SetColumn(0, "KEY2", sKey2); // KEY값2
        
        ds_iSettlementPos.SetColumn(0, "PROCGUBUN", divProcGubun.radProcGubun.Value); // 결제구분(강습01, 강습+시험, 강습+수첩 등)
        //////// 강습인지(01), 강습+수첩인지(02) , 강습+시험(03)에 따라 수첩비 금액을 전달함 
        if (divProcGubun.radProcGubun.Value == "01") {  // 01 강습
                ds_iSettlementPos.SetColumn(0, "PROCAMOUNT", cbxSunapingAmount.Value); // 수납할 금액
                ds_iSettlementPos.SetColumn(0, "LICENSEAMOUNT", "0"); // 강습만 접수시 수첩비 없음
                ds_iSettlementPos.SetColumn(0, "EXAMAMOUNT", "0");    // 강습만 접수시 시험비 없음
        } else if(divProcGubun.radProcGubun.Value == "02") { //02 강습+수첩
                ds_iSettlementPos.SetColumn(0, "PROCAMOUNT", cbxEarlySunapingAmount.Value); // 강습+수첩 수납할 금액(선수납)
                ds_iSettlementPos.SetColumn(0, "LICENSEAMOUNT", ds_oTrainingEarlySunapFee.GetColumn(cbxEarlySunapingAmount.Index, "LICENSESUNAP")); // 수첩비 수납할 금액
                ds_iSettlementPos.SetColumn(0, "EXAMAMOUNT", "0");                          // 강습+수첩 접수시 시험비 없음
        } else if(divProcGubun.radProcGubun.Value == "03") { //03 강습+시험
                ds_iSettlementPos.SetColumn(0, "PROCAMOUNT", cbxEarlySunapingAmount.Value); // 강습+시험 수납할 금액(선수납)
                ds_iSettlementPos.SetColumn(0, "LICENSEAMOUNT", "0");                       // 강습+시험 접수시 수첩비 없음
                ds_iSettlementPos.SetColumn(0, "EXAMAMOUNT", ds_oTrainingEarlySunapFee.GetColumn(cbxEarlySunapingAmount.Index, "LICENSESUNAP")); // 시험비 수납할 금액
        } 
                            
        ////////
        ds_iSettlementPos.SetColumn(0, "PROCDATE", left(calSunapDate.Value, 8)); // 처리일자
        ds_iSettlementPos.SetColumn(0, "PONYGUBUN", iif(chkPonyDate.Value == "1", "1", "0")); // 정산구분
        ds_iSettlementPos.SetColumn(0, "PONYDATE", iif(chkPonyDate.Value == "1", left(calPonyDate.Value, 8), "")); // 정산일자
        ds_iSettlementPos.SetColumn(0, "PRINTYN", radRecieptYn.Value); // 영수증출력여부 Y/N
        ds_iSettlementPos.SetColumn(0, "SUNAPACTIONREF", ms_SunapActionRef); // TSSUNAPACTIONREF수납환불_REF
        ds_iSettlementPos.SetColumn(0, "REPAYTSSEQ", ds_oPosStartInfo.GetColumn(0, 'TSSEQ')); // 환불할 결제순차번호

        ds_iSettlementPos.SetColumn(0, "BANKSUNAPGUBUN", divSunap.radBankSunapGubun.Value); // 수납방법(방문직납0,방문은납4)
        ds_iSettlementPos.SetColumn(0, "PAYMENTGUBUN", iif(divSunap.radSunapGubun.Value == "4", "3", divSunap.radSunapGubun.Value)); // 납부방법 현금0, 신용카드1, 현금영수증2, 가상계좌3
		ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "1"); // default "1"로 세팅 -- 처리기관 구분(0:현금, 1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
		
        switch (divSunap.radSunapGubun.Value) { // 납부방법
            case "0" : // 현금
                ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "0"); // 처리기관 구분(0:현금, 1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
                break;
            case "1" : // 카드
				if (divSunap.divSunabDtl.lb_AutoYn == false) { //직접입력(KeyIn)일 경우 카드번호+월+년
					if (gfn_IsNull(divSunap.divSunabDtl.edCardNo.Text)) {
						divSunap.divSunabDtl.edCardNo.SetFocus();
						gfn_Alert("카드번호를 입력해 주십시오.");
						return false;
					}
				}
                if (divSunap.divSunabDtl.lb_AutoYn) { // 자동입력
                    ds_iSettlementPos.SetColumn(0, "CARDNO", ""); // 2018.07 IC카드리더기로 변경  // 2020.04.21  환불개선 수정 시 카드번호 입력 안함
                } else { // 수동입력
                    ds_iSettlementPos.SetColumn(0, "CARDNO", divSunap.divSunabDtl.edCardNo.Text
                        + divSunap.divSunabDtl.cbxValidTermMonth.Value
                        + divSunap.divSunabDtl.cbxValidTermYear.Value); // 카드번호 + 월 + 년
                }
                //////// 강습인지(01), 강습+수첩인지(02) 강습+시험(03)에 따라 카드 메시지 표시 위해 금액 비교하는 변수 다르게함 
                if (divProcGubun.radProcGubun.Value == "01") {
                    if ((toNumber(cbxSunapingAmount.Value) < 50000) && (divSunap.divSunabDtl.cbxInstallment.Value <> "00")) {
                        divSunap.divSunabDtl.cbxInstallment.SetFocus();
                        gfn_Alert("5만원 이상일 경우 할부 가능합니다.");
                        return false;
                    }
                } else {  // 강습 + 수첩, 강습 + 시험은 같은 금액 값 사용함
                    if ((toNumber(cbxEarlySunapingAmount.Value) < 50000) && (divSunap.divSunabDtl.cbxInstallment.Value <> "00")) {
                        divSunap.divSunabDtl.cbxInstallment.SetFocus();
                        gfn_Alert("5만원 이상일 경우 할부 가능합니다.");
                        return false;
                    }
                }
                
                ds_iSettlementPos.SetColumn(0, "CARDINSTALL", divSunap.divSunabDtl.cbxInstallment.Value); // 할부개월수
                ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "1"); // 처리기관 구분(0:현금, 1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
                break;
            case "2" : // 현금영수증
                if (gfn_IsNull(divSunap.divSunabDtl.edCashCardNo.Text)) {
                    divSunap.divSunabDtl.edCashCardNo.SetFocus();
                    gfn_Alert("현금영수증번호를 입력해 주십시오.");
                    return false;
                }
                ds_iSettlementPos.SetColumn(0, "CASHRECEIPTUSE", divSunap.divSunabDtl.radUseGubun.Value); // 현금영수증발급용도 용도('1':소득공제, '2':지출증빙)
                ds_iSettlementPos.SetColumn(0, "CASHCARDNO", divSunap.divSunabDtl.edCashCardNo.Text); // 현금영수증번호
                break;
                ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "0"); // 처리기관 구분(0:현금, 1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
            case "3" : // 가상계좌(LG U+)
                ds_iSettlementPos.SetColumn(0, "VIRTBANKCODE", divSunap.divSunabDtl.cbxBank.Value); // 입금계좌은행
                ds_iSettlementPos.SetColumn(0, "VIRTBANKNAME", divSunap.divSunabDtl.cbxBank.Text); // 입금계좌은행명
                ds_iSettlementPos.SetColumn(0, "VIRTCLOSEDATE", divSunap.divSunabDtl.calEndDate.Value); // 입금마감일
                ds_iSettlementPos.SetColumn(0, "VIRTHPTEL", divSunap.divSunabDtl.edHpTel.Text); // 가상계좌휴대폰번호
                ds_iSettlementPos.SetColumn(0, "VIRTCASHRECEIPTYN", divSunap.divSunabDtl.radRecieptYn.Value); // 가상계좌 현금영수증 사용여부Y/N
                if (divSunap.divSunabDtl.radRecieptYn.Value == "Y") {
                    if (gfn_IsNull(divSunap.divSunabDtl.divVirtual.edCashCardNo.Text)) {
                        divSunap.divSunabDtl.divVirtual.edCashCardNo.SetFocus();
                        gfn_Alert("현금영수증번호를 입력해 주십시오.");
                        return false;
                    }
                    ds_iSettlementPos.SetColumn(0, "CASHRECEIPTUSE", divSunap.divSunabDtl.divVirtual.radUseGubun.Value); // 현금영수증발급용도 용도('1':소득공제, '2':지출증빙)
                    ds_iSettlementPos.SetColumn(0, "CASHCARDNO", divSunap.divSunabDtl.divVirtual.edCashCardNo.Text); // 현금영수증번호
                }
                ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "1"); // 처리기관 구분(0:현금, 1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
                break;
            case "4" : // 가상계좌(세틀뱅크)
                ds_iSettlementPos.SetColumn(0, "VIRTBANKCODE", divSunap.divSunabDtl.cbxBank.Value); // 입금계좌은행
                ds_iSettlementPos.SetColumn(0, "VIRTBANKNAME", divSunap.divSunabDtl.cbxBank.Text); // 입금계좌은행명
                ds_iSettlementPos.SetColumn(0, "VIRTCLOSEDATE", divSunap.divSunabDtl.calEndDate.Value); // 입금마감일
                ds_iSettlementPos.SetColumn(0, "VIRTHPTEL", divSunap.divSunabDtl.edHpTel.Text); // 가상계좌휴대폰번호
                ds_iSettlementPos.SetColumn(0, "VIRTCASHRECEIPTYN", divSunap.divSunabDtl.radRecieptYn.Value); // 가상계좌 현금영수증 사용여부Y/N
/* 현금영수증 사용안함
                if (divSunap.divSunabDtl.radRecieptYn.Value == "Y") {
                    if (gfn_IsNull(divSunap.divSunabDtl.divVirtual.edCashCardNo.Text)) {
                        divSunap.divSunabDtl.divVirtual.edCashCardNo.SetFocus();
                        gfn_Alert("현금영수증번호를 입력해 주십시오.");
                        return false;
                    }
                    ds_iSettlementPos.SetColumn(0, "CASHRECEIPTUSE", divSunap.divSunabDtl.divVirtual.radUseGubun.Value); // 현금영수증발급용도 용도('1':소득공제, '2':지출증빙)
                    ds_iSettlementPos.SetColumn(0, "CASHCARDNO", divSunap.divSunabDtl.divVirtual.edCashCardNo.Text); // 현금영수증번호
                }
*/

/*
				ds_iSettlementPos.SetColumn(0, "PAYMENTGUBUN", "3"); // 납부방법 현금0, 신용카드1, 현금영수증2, 가상계좌3
                if (divSunap.divSunabDtl.cbxBank.index == 1) {	// 국민은행
					ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "2"); // 처리기관 구분(1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
				} else if (divSunap.divSunabDtl.cbxBank.index == 2) {	// 신한은행
					ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "3"); // 처리기관 구분(1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
				} else if (divSunap.divSunabDtl.cbxBank.index == 3) {	// 우리은행
					ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "4"); // 처리기관 구분(1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
				} else if (divSunap.divSunabDtl.cbxBank.index == 0) {	// 농협은행
					ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "5"); // 처리기관 구분(1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
				} else {
					ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "2"); // 처리기관 구분(1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
				}
				
*/			
				ds_iSettlementPos.SetColumn(0, "PAYMENTGUBUN", "3"); // 납부방법 현금0, 신용카드1, 현금영수증2, 가상계좌3
				
                if (divSunap.divSunabDtl.cbxBank.index == 0) {	// 국민은행
					ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "2"); // 처리기관 구분(1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
					
				} else if (divSunap.divSunabDtl.cbxBank.index == 1) {	// 신한은행
					ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "3"); // 처리기관 구분(1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
				
				} else if (divSunap.divSunabDtl.cbxBank.index == 2) {	// 우리은행
					ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "4"); // 처리기관 구분(1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
				
				} else if (divSunap.divSunabDtl.cbxBank.index == 3) {	// 농협은행
					ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "5"); // 처리기관 구분(1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
				
				} else {
					ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "2"); // 처리기관 구분(1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
				}
                break;
        }
    } else { // 환불
    
    
		/////////////////// 시험응시수수료나 수첩교부 수수료 현금으로 환불
		
		if(cbxRepayFee.Value == "S" ){
			if (!gfn_Confirm(" 선수납한 수첩교부 수수료를 부분환불이 아닌 현금 환불 할 경우 현금 환불 이후에는\n\n"
							+"          더 이상의 결제처리가 되지 않습니다. 진행 하시겠습니까?")) {
				return false;
			}
			
			EarlyRepay(); 
			
			return false;
			
		}       
		///////////////////
		/////////////////// 시험응시수수료나 수첩교부 수수료 현금으로 환불
    
		if(cbxRepayFee.Value == "M" ){
			if (!gfn_Confirm(" 선수납한 수첩교부 수수료를 부분환불이 아닌 현금 환불 할 경우 현금 환불 이후에는\n\n"
							+"          더 이상의 결제처리가 되지 않습니다. 진행 하시겠습니까?")) {
				return false;
			}
			
			EarlyRepayExam(); 
			
			return false;
			
		}
		
       // 수납된 금액보다 환불할 금액이 크면 환불 안되게 // 2020.04.21  환불개선 수정
		if (toNumber(medTotalSunapFee.Value) < -toNumber(divRepay.medRepayAmount1.Value)) {
			gfn_Alert("수납된 금액("+medTotalSunapFee.Text+")보다 환불할 금액("+divRepay.medRepayAmount1.Text+")이 크므로 환불이 불가합니다.");
			return false;
		}
		
		///////////////////    
//        if (chkCardChangeYn.Value <> "Y") { // 카드변경처리가 아니면
            if ((ds_oPosStartInfo.GetColumn(0, 'TJPASSYN') == "Y")  // 수료여부
                        && (chkCardChangeYn.Value <> "Y") // 카드변경처리가 아니면
                    ) {
                if (!gfn_Confirm("[수료처리]된 자료입니다. [수료취소처리]됩니다.\n그래도, 환불처리 하시겠습니까?")) {
                    return false;
                }
            } else {
                if (!gfn_Confirm("환불처리 하시겠습니까?")) {
                    return false;
                }
            }

            if (divProcGubun.radProcGubun.Value == "B") { // 전액환불
            
				if (chkCardChangeYn.Value == "Y") { // 카드변경처리이면
					if (!gfn_Confirm("카드 등 납부방법 변경처리 하시겠습니까?")) {
						return false;
					}
	
//					ms_SunapGubun = '1'; // 수납환불구분 : 수납'0'으로 변경	수납 먼저 처리하고 환불 처리함//  2020.05.07 '1'로 변경 환불 먼저하고 수납 처리함
					mn_PartRepayCnt = 1; // 납부방법 변경 환불여부  1:환불
				}
            
                // POS처리용 데이타셋을 설정한다.
                ds_iSettlementPos.InsertRow(0);              
                // 가상 계좌일 경우 POS_kfsa_012 에서 _kfsa_012 로 변경함
                //if (decode(right(ds_oPosStartInfo.GetColumn(0, "TSGUBUN"), 1), "3", "0", "4", "0",
                //                                                               "5", "2", "6", "2", right(ds_oPosStartInfo.GetColumn(0, 'TSGUBUN'), 1)
                //        ) == "3") {   // 납부방법  가상계좌
                //    ds_iSettlementPos.SetColumn(0, "JIBUMGID", replace(edJibuMgId.Text, "POS_", "")); // 카드/지부상점ID
                //    trace("전액환불" + ds_iSettlementPos.GetColumn(0, "JIBUMGID"));            
                //} else {
                    ds_iSettlementPos.SetColumn(0, "JIBUMGID", edJibuMgId.Text); // 카드/지부상점ID
                //}                   
            //    ds_iSettlementPos.SetColumn(0, "JIBUMGID", edJibuMgId.Text); // 카드/지부상점ID                           
                ds_iSettlementPos.SetColumn(0, "PROGRAMID", sProgramId); // POS단위업무프로그램 (강습21,시험22,수첩23)
                ds_iSettlementPos.SetColumn(0, "SUNAPGUBUN", ms_SunapGubun); // 수납환불구분(수납0,환불1)
                ds_iSettlementPos.SetColumn(0, "PARTREPAYYN", 'N'); // 부분환불여부(Y:부분환불,N:부분환불아님)
                ds_iSettlementPos.SetColumn(0, "POSYEAR", ms_RepayPosYear); // 환불용 POS년도
                ds_iSettlementPos.SetColumn(0, "POSMGNO", ms_RepayPosMgno); // 환불용 POS관리번호
                ds_iSettlementPos.SetColumn(0, "KEY1", sKey1); // KEY값1-접수관리번호
                //ds_iSettlementPos.SetColumn(0, "KEY2", sKey2); // KEY값2
                ds_iSettlementPos.SetColumn(0, "PROCGUBUN", divProcGubun.radProcGubun.Value); // 처리구분(환불구분(전액B, 부분P))
                ds_iSettlementPos.SetColumn(0, "REPAYCD", cbxRepayFee.Value); // 환불처리코드(B, 1, 2, 3, 4, 5, A)
                ds_iSettlementPos.SetColumn(0, "PROCAMOUNT", ds_oTrainingRepayFee.GetColumn(cbxRepayFee.Index, "REPAY")); // 결제금액
                ds_iSettlementPos.SetColumn(0, "PROCDATE", left(calSunapDate.Value, 8)); // 처리일자
                ds_iSettlementPos.SetColumn(0, "PONYGUBUN", iif(chkPonyDate.Value == "1", "1", "0")); // 정산구분
                ds_iSettlementPos.SetColumn(0, "PONYDATE", iif(chkPonyDate.Value == "1", left(calPonyDate.Value, 8), "")); // 정산일자
                ds_iSettlementPos.SetColumn(0, "SUNAPACTIONREF", ms_SunapActionRef); // TSSUNAPACTIONREF수납환불_REF
                ds_iSettlementPos.SetColumn(0, "REPAYTSSEQ", ds_oPosStartInfo.GetColumn(0, 'TSSEQ')); // 환불할 결제순차번호
    
                ds_iSettlementPos.SetColumn(0, "PAYMENTGUBUN", 
                        decode(right(ds_oPosStartInfo.GetColumn(0, 'TSGUBUN'), 1),
                            "3", "0", "4", "0",
                            "5", "2", "6", "2",
                            right(ds_oPosStartInfo.GetColumn(0, 'TSGUBUN'), 1)
                        )
                    ); // 납부방법 현금0, 신용카드1, 현금영수증2, 가상계좌3
                    
				ds_iSettlementPos.SetColumn(0, "TFCSEQ", ms_TFCSEQ);	// 수수료코드 관리번호 추가 2012.01.19

            } else { // 부분환불
//                ms_SunapGubun = '0'; // 수납환불구분 : 수납'0'으로 변경		// 2020.04.21  환불개선 수정
//                mn_PartRepayCnt = 1; // 부분환불여부 부분환불 수납			// 2020.04.21  환불개선 수정
				mn_PartRepayCnt = 0;	// 부분환불 개선으로 0으로 적용(카드 등 납부방법변경시에만 1로 적용)
                // 수납용 POS처리용 데이타셋을 설정한다.
                ds_iSettlementPos.InsertRow(0);                
                // 가상 계좌일 경우 POS_kfsa_012 에서 _kfsa_012 로 변경함
                //if (divSunap.radSunapGubun.Value == "3" || divSunap.radSunapGubun.Value == "4") {   // 납부방법  가상계좌
                //    ds_iSettlementPos.SetColumn(0, "JIBUMGID", replace(edJibuMgId.Text, "POS_", "")); // 카드/지부상점ID
                //    trace("부분환불" + ds_iSettlementPos.GetColumn(0, "JIBUMGID"));            
                //} else {
                    ds_iSettlementPos.SetColumn(0, "JIBUMGID", edJibuMgId.Text); // 카드/지부상점ID
                //}                               
               // ds_iSettlementPos.SetColumn(0, "JIBUMGID", edJibuMgId.Text); // 카드/지부상점ID                
                ds_iSettlementPos.SetColumn(0, "PROGRAMID", sProgramId); // POS단위업무프로그램 (강습21,시험22,수첩23)
                ds_iSettlementPos.SetColumn(0, "SUNAPGUBUN", ms_SunapGubun); // 수납환불구분(수납0,환불1)
                ds_iSettlementPos.SetColumn(0, "PARTREPAYYN", 'Y'); // 부분환불여부(Y:부분환불,N:부분환불아님)
                ds_iSettlementPos.SetColumn(0, "POSYEAR", ms_RepayPosYear); // 환불용 POS년도
                ds_iSettlementPos.SetColumn(0, "POSMGNO", ms_RepayPosMgno); // 환불용 POS관리번호
                ds_iSettlementPos.SetColumn(0, "KEY1", sKey1); // KEY값1-접수관리번호
                //ds_iSettlementPos.SetColumn(0, "KEY2", sKey2); // KEY값2
                ds_iSettlementPos.SetColumn(0, "PROCGUBUN", divProcGubun.radProcGubun.Value); // 처리구분(환불구분(전액B, 부분P))
                ds_iSettlementPos.SetColumn(0, "PROCAMOUNT", ds_oTrainingRepayFee.GetColumn(cbxRepayFee.Index, "REPAY")); // 결제금액	// 2020.04.21  환불개선 수정
                ds_iSettlementPos.SetColumn(0, "PROCDATE", left(calSunapDate.Value, 8)); // 처리일자
                ds_iSettlementPos.SetColumn(0, "PONYGUBUN", iif(chkPonyDate.Value == "1", "1", "0")); // 정산구분
                ds_iSettlementPos.SetColumn(0, "PONYDATE", iif(chkPonyDate.Value == "1", left(calPonyDate.Value, 8), "")); // 정산일자
                ds_iSettlementPos.SetColumn(0, "SUNAPACTIONREF", ms_SunapActionRef); // TSSUNAPACTIONREF수납환불_REF
                ds_iSettlementPos.SetColumn(0, "REPAYTSSEQ", ds_oPosStartInfo.GetColumn(0, 'TSSEQ')); // 환불할 결제순차번호
    
//                ds_iSettlementPos.SetColumn(0, "BANKSUNAPGUBUN", divSunap.radBankSunapGubun.Value); // 수납방법(방문직납0,방문은납4)			// 2020.04.21  환불개선 수정
//                ds_iSettlementPos.SetColumn(0, "PAYMENTGUBUN", iif(divSunap.radSunapGubun.Value == "4", "3", divSunap.radSunapGubun.Value)); // 납부방법 현금0, 신용카드1, 현금영수증2, 가상계좌3		// 2020.04.21  환불개선 수정
                ds_iSettlementPos.SetColumn(0, "PAYMENTGUBUN",
                        decode(right(ds_oPosStartInfo.GetColumn(0, 'TSGUBUN'), 1),
                            "3", "0", "4", "0",
                            "5", "2", "6", "2",
                            right(ds_oPosStartInfo.GetColumn(0, 'TSGUBUN'), 1)
                        )
                    ); // 납부방법 현금0, 신용카드1, 현금영수증2, 가상계좌3			// 2020.04.21  환불개선 수정
                    
				ds_iSettlementPos.SetColumn(0, "TFCSEQ", ms_TFCSEQ);	// 수수료코드 관리번호 추가 2012.01.19

/*	부분수납	// 2020.04.21  환불개선 수정	
                switch (divSunap.radSunapGubun.Value) { // 납부방법
                    case "0" : // 현금
						ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "0"); // 처리기관 구분(0:현금, 1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
                        break;
                    case "1" : // 카드
						if (divSunap.divSunabDtl.lb_AutoYn == false) { //직접입력(KeyIn)일 경우 카드번호+월+년
							if (gfn_IsNull(divSunap.divSunabDtl.edCardNo.Text)) {
								divSunap.divSunabDtl.edCardNo.SetFocus();
								gfn_Alert("카드번호를 입력해 주십시오.");
								return false;
							}
						}
                        if (divSunap.divSunabDtl.lb_AutoYn) { // 자동입력
                            ds_iSettlementPos.SetColumn(0, "CARDNO", divSunap.divSunabDtl.edCardNo.Text); // 카드번호 32자리 카드리더기 값
                        } else { // 수동입력
                            ds_iSettlementPos.SetColumn(0, "CARDNO", divSunap.divSunabDtl.edCardNo.Text
                                + divSunap.divSunabDtl.cbxValidTermMonth.Value
                                + divSunap.divSunabDtl.cbxValidTermYear.Value); // 카드번호 + 월 + 년
                        }
                    
                       if ((toNumber(cbxSunapingAmount.Value) < 50000) && (divSunap.divSunabDtl.cbxInstallment.Value <> "00")) {
                            divSunap.divSunabDtl.cbxInstallment.SetFocus();
                            gfn_Alert("5만원 이상일 경우 할부 가능합니다.");
                            return false;
                       }                   
                        
                        ds_iSettlementPos.SetColumn(0, "CARDINSTALL", divSunap.divSunabDtl.cbxInstallment.Value); // 할부개월수
                        ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "1"); // 처리기관 구분(0:현금, 1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
                        break;
                    case "2" : // 현금영수증
                        if (gfn_IsNull(divSunap.divSunabDtl.edCashCardNo.Text)) {
                            divSunap.divSunabDtl.edCashCardNo.SetFocus();
                            gfn_Alert("현금영수증번호를 입력해 주십시오.");
                            return false;
                        }
                        ds_iSettlementPos.SetColumn(0, "CASHRECEIPTUSE", divSunap.divSunabDtl.radUseGubun.Value); // 현금영수증발급용도 용도('1':소득공제, '2':지출증빙)
                        ds_iSettlementPos.SetColumn(0, "CASHCARDNO", divSunap.divSunabDtl.edCashCardNo.Text); // 현금영수증번호
                        ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "0"); // 처리기관 구분(0:현금, 1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
                        break;
                }
*/                
            }

/*
        } else { // 카드변경처리
            if (!gfn_Confirm("카드 등 납부방법 변경처리 하시겠습니까?")) {
                return false;
            }

            ms_SunapGubun = '1'; // 수납환불구분 : 수납'0'으로 변경	수납 먼저 처리하고 환불 처리함//  2020.05.07 '1'로 변경 환불 먼저하고 수납 처리함
            mn_PartRepayCnt = 1; // 부분환불여부 부분환불 수납
            // 수납용 POS처리용 데이타셋을 설정한다.
            ds_iSettlementPos.InsertRow(0);          
            // 가상 계좌일 경우 POS_kfsa_012 에서 _kfsa_012 로 변경함
            //if (divSunap.radSunapGubun.Value == "3" || divSunap.radSunapGubun.Value == "4") {   // 납부방법  가상계좌
            //    ds_iSettlementPos.SetColumn(0, "JIBUMGID", replace(edJibuMgId.Text, "POS_", "")); // 카드/지부상점ID
            //    trace("카드변경" + ds_iSettlementPos.GetColumn(0, "JIBUMGID"));            
            //} else {
                ds_iSettlementPos.SetColumn(0, "JIBUMGID", edJibuMgId.Text); // 카드/지부상점ID
            //}                        
            //ds_iSettlementPos.SetColumn(0, "JIBUMGID", edJibuMgId.Text); // 카드/지부상점ID          
            ds_iSettlementPos.SetColumn(0, "PROGRAMID", sProgramId); // POS단위업무프로그램 (강습21,시험22,수첩23)
            ds_iSettlementPos.SetColumn(0, "SUNAPGUBUN", ms_SunapGubun); // 수납환불구분(수납0,환불1)
            ds_iSettlementPos.SetColumn(0, "PARTREPAYYN", 'Y'); // 부분환불여부(Y:부분환불,N:부분환불아님)
            ds_iSettlementPos.SetColumn(0, "POSYEAR", ms_RepayPosYear); // 환불용 POS년도
            ds_iSettlementPos.SetColumn(0, "POSMGNO", ms_RepayPosMgno); // 환불용 POS관리번호
            ds_iSettlementPos.SetColumn(0, "KEY1", sKey1); // KEY값1-관리번호

// 카드 등 결제 변경시 부분환불 개념임 결제 변경시 최초 선수납 여부에 따라 부분수납 프로세스 변경해야함 
            
            if ((ds_ioEarlySunapGubun.GetColumn(0, "EARLYGUBUN") == "L")) { 
                ds_iSettlementPos.SetColumn(0, "PROCGUBUN", "02"); // 결제구분(강습+수첩 등)
            } else if((ds_ioEarlySunapGubun.GetColumn(0, "EARLYGUBUN") == "E")) {
                ds_iSettlementPos.SetColumn(0, "PROCGUBUN", "03"); // 결제구분(강습+시험 등)
            } else if((ds_ioEarlySunapGubun.GetColumn(0, "EARLYGUBUN") == "N")) { // 일반수납일 경우
                ds_iSettlementPos.SetColumn(0, "PROCGUBUN", divProcGubun.radProcGubun.Value); // 결제구분(강습01, 강습+시험, 강습+수첩 등)
            }
          
            if ((ds_ioEarlySunapGubun.GetColumn(0, "EARLYGUBUN") == "N")) { 
            
                ds_iSettlementPos.SetColumn(0, "PROCAMOUNT", cbxSunapingAmount.Value); // 결제금액
                
            } else if ((ds_ioEarlySunapGubun.GetColumn(0, "EARLYGUBUN") == "L")) { // 수첩
            // 선수납일경우 
                ds_iSettlementPos.SetColumn(0, "PROCAMOUNT", edSunapingAmount_Edit.Value); // 결제금액
                ds_iSettlementPos.SetColumn(0, "LICENSEAMOUNT", ds_oTrainingEarlySunapFee.GetColumn(cbxEarlySunapingAmount.Index, "LICENSESUNAP")); // 수첩비 수납할 금액                
            } else if((ds_ioEarlySunapGubun.GetColumn(0, "EARLYGUBUN") == "E")) { // 시험
             // 선수납일경우 
                ds_iSettlementPos.SetColumn(0, "PROCAMOUNT", edSunapingAmount_Edit.Value); // 결제금액
                ds_iSettlementPos.SetColumn(0, "EXAMAMOUNT", ds_oTrainingEarlySunapFee.GetColumn(cbxEarlySunapingAmount.Index, "LICENSESUNAP")); // 시험비 수납할 금액
            }
                      
            ds_iSettlementPos.SetColumn(0, "PROCDATE", left(calSunapDate.Value, 8)); // 처리일자
            ds_iSettlementPos.SetColumn(0, "PONYGUBUN", iif(chkPonyDate.Value == "1", "1", "0")); // 정산구분
            ds_iSettlementPos.SetColumn(0, "PONYDATE", iif(chkPonyDate.Value == "1", left(calPonyDate.Value, 8), "")); // 정산일자
            ds_iSettlementPos.SetColumn(0, "SUNAPACTIONREF", ms_SunapActionRef); // TSSUNAPACTIONREF수납환불_REF
            ds_iSettlementPos.SetColumn(0, "REPAYTSSEQ", ds_oPosStartInfo.GetColumn(0, 'TSSEQ')); // 환불할 결제순차번호

            ds_iSettlementPos.SetColumn(0, "BANKSUNAPGUBUN", divSunap.radBankSunapGubun.Value); // 수납방법(방문직납0,방문은납4)
            ds_iSettlementPos.SetColumn(0, "PAYMENTGUBUN", iif(divSunap.radSunapGubun.Value == "4", "3", divSunap.radSunapGubun.Value)); // 납부방법 현금0, 신용카드1, 현금영수증2, 가상계좌3

			ds_iSettlementPos.SetColumn(0, "TFCSEQ", ms_TFCSEQ);	// 수수료코드 관리번호 추가 2012.01.19

            ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "1"); // 처리기관 구분(0:현금, 1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
				
			if (divSunap.divSunabDtl.lb_AutoYn == false) { //직접입력(KeyIn)일 경우 카드번호+월+년
				if (gfn_IsNull(divSunap.divSunabDtl.edCardNo.Text)) {
					divSunap.divSunabDtl.edCardNo.SetFocus();
					gfn_Alert("카드번호를 입력해 주십시오.");
					return false;
				}
            }
            if (divSunap.divSunabDtl.lb_AutoYn) { // 자동입력
                ds_iSettlementPos.SetColumn(0, "CARDNO", divSunap.divSunabDtl.edCardNo.Text); // 카드번호 32자리 카드리더기 값
            } else { // 수동입력
                ds_iSettlementPos.SetColumn(0, "CARDNO", divSunap.divSunabDtl.edCardNo.Text
                    + divSunap.divSunabDtl.cbxValidTermMonth.Value
                    + divSunap.divSunabDtl.cbxValidTermYear.Value); // 카드번호 + 월 + 년
            }
            
            if ((ds_ioEarlySunapGubun.GetColumn(0, "EARLYGUBUN") == "N")) { 
            
               if ((toNumber(cbxSunapingAmount.Value) < 50000) && (divSunap.divSunabDtl.cbxInstallment.Value <> "00")) {
                    divSunap.divSunabDtl.cbxInstallment.SetFocus();
                    gfn_Alert("5만원 이상일 경우 할부 가능합니다.");
                    return false;
               }
            } else {
            // 선수납일경우                            
               if ((toNumber(edSunapingAmount_Edit.Value) < 50000) && (divSunap.divSunabDtl.cbxInstallment.Value <> "00")) {
                    divSunap.divSunabDtl.cbxInstallment.SetFocus();
                    gfn_Alert("5만원 이상일 경우 할부 가능합니다.");
                    return false;
                }
            }
                        
            ds_iSettlementPos.SetColumn(0, "CARDINSTALL", divSunap.divSunabDtl.cbxInstallment.Value); // 할부개월수
    
        }
*/        
    }

    btnSetlmt.Enable = false; // 결제버튼 비활성화
    if (ms_SunapGubun == "1") { // 환불
        if (ms_ExecutePosSettlementChangeYn == "Y") { // 회계수납회차변경실행여부
			var ls_aftergtmgno = "";
			if (right(ds_oPosStartInfo.GetColumn(0, 'TSGUBUN'), 1) == "1") { // 카드이면
				ls_aftergtmgno = ds_oPosStartInfo.GetColumn(0, 'TSPOSGTMGNO');
			} else {
				ls_aftergtmgno = gds_oUserInfo.GetColumn(0, "PDEPTCD");
			}
            lfn_ExecutePosSettlementChange(ds_oPosStartInfo.GetColumn(0, 'TOMGGTMGNO'), ls_aftergtmgno); // 회계수납회차변경실행
            ds_iSettlementPos.SetColumn(0, "REPAYTSSEQ", ds_oPosStartInfo.GetColumn(0, 'TSSEQ')); // 환불할 결제순차번호
        }
    }


	if ((ms_SunapGubun == "0" && divSunap.radSunapGubun.Value <= "3") || ms_SunapGubun == "1") {	// 현금,현영,LG U+ 카드,가상계좌, 환불
		lfn_ExecuteTrainingPosBefore(); // POS 호출 전 처리
	} else if (ms_SunapGubun == "0" && divSunap.radSunapGubun.Value == "4") {	// 세틀뱅크 가상계좌(수납시만)
		lfn_SETTLEBANK_ExecuteTrainingPosBefore(); // POS 호출 전 처리
	}
    
}

function cbxRepayFee_OnChanged(obj,strCode,strText,nOldIndex,nNewIndex) {
    if (strCode == "B") {
        divProcGubun.radProcGubun.Value = "B"; // 전액환불
        divSunap.lbSunapingAmount.Visible = false;
        cbxSunapingAmount.Visible = false;
        cbxRepayFee.Value = "B";
        divRepay.medRepayAmount1.value = ds_oTrainingRepayFee.GetColumn(nNewIndex, "REPAY");
    } else {
        divProcGubun.radProcGubun.Value = "P"; // 부분환불
        //divSunap.lbSunapingAmount.Visible = true;		// 2020.04.21 환불개선 수정
        //cbxSunapingAmount.Visible = true;		// 2020.04.21 환불개선 수정
        divRepay.medRepayAmount1.value = ds_oTrainingRepayFee.GetColumn(nNewIndex, "REPAY");
    }

    //cbxSunapingAmount.Value = toNumber(ms_SunapedTotalAmount) + toNumber(ds_oTrainingRepayFee.GetColumn(nNewIndex, "REPAY"));		// 2020.04.21 환불개선 수정
    if ((ds_ioEarlySunapGubun.GetColumn(0, "EARLYGUBUN") == "L")) { // 선수납일경우 환불시 상세금액 표기
        lbTrainingAndLicenseCostInfo.Visible = true;  // 선수납의한 금액 상세 정보 보기 수첩비
        lbTrainingAndLicenseCostInfo.Left = "335"; //수납시 선수납 상세 위치 지정함
        lbTrainingAndLicenseCostInfo.Top = "173";   //수납시 선수납 상세 위치 지정함   
        lbTrainingAndLicenseCostInfo.text = "(강습수수료 : -" + NumFormat(ds_ioTrainingEarlyRepayFee.GetColumn(nNewIndex, "TRAININGREPAY"))
                    + "원 + 수첩교부수수료 : " + NumFormat(ds_ioTrainingEarlyRepayFee.GetColumn(nNewIndex, "LICENSEREPAY")) + "원)";            
    } else if ((ds_ioEarlySunapGubun.GetColumn(0, "EARLYGUBUN") == "E")) { // 선수납일경우 환불시 상세금액 표기
        lbTrainingAndLicenseCostInfo.Visible = true;  // 선수납의한 금액 상세 정보 보기 강습비
        lbTrainingAndLicenseCostInfo.Left = "335"; //수납시 선수납 상세 위치 지정함
        lbTrainingAndLicenseCostInfo.Top = "173";   //수납시 선수납 상세 위치 지정함   
        lbTrainingAndLicenseCostInfo.text = "(강습수수료 : -" + NumFormat(ds_ioTrainingEarlyRepayFee.GetColumn(nNewIndex, "TRAININGREPAY"))
                    + "원 + 시험응시수수료 : " + NumFormat(ds_ioTrainingEarlyRepayFee.GetColumn(nNewIndex, "LICENSEREPAY")) + "원)";            
    } else {
         // 선수납 한 사람이 아닐 경우    
        lbTrainingAndLicenseCostInfo.Visible = false;  // 선수납의한 금액 상세 정보 안보기
    } 

    lfn_ChangeRepayDiv(divProcGubun.radProcGubun.Value);
}

/*
 * 기능 : 납부방법변경(환불) 수납 후 환불을 실행한다. 미사용
 * parameter : 없음
 * return : 없음
 */
function lfn_ExecuteRepaySunap() {
    ms_SunapGubun = '1'; // 수납환불구분 : 환불'1'로 변경
    mn_PartRepayCnt = 2; // 납부방법변경(환불)여부 부분환불 환불
    ms_SunapActionRef = toNumber(ms_SunapActionRef) + 1; // TSSUNAPACTIONREF수납환불_REF

    ds_iSettlementPos.ClearData();
    divPos.ds_ioPosInput.ClearData(); // POS INPUT용

    // 환불용 POS처리용 데이타셋을 설정한다.
    ds_iSettlementPos.InsertRow(0);
    ds_iSettlementPos.SetColumn(0, "JIBUMGID", edJibuMgId.Text); // 카드/지부상점ID
    ds_iSettlementPos.SetColumn(0, "PROGRAMID", sProgramId); // POS단위업무프로그램 (강습21,시험22,수첩23)
    ds_iSettlementPos.SetColumn(0, "SUNAPGUBUN", ms_SunapGubun); // 수납환불구분(수납0,환불1)
    ds_iSettlementPos.SetColumn(0, "PARTREPAYYN", 'Y'); // 부분환불여부(Y:부분환불,N:부분환불아님)
    ds_iSettlementPos.SetColumn(0, "POSYEAR", ms_RepayPosYear); // 환불용 POS년도
    ds_iSettlementPos.SetColumn(0, "POSMGNO", ms_RepayPosMgno); // 환불용 POS관리번호
    ds_iSettlementPos.SetColumn(0, "KEY1", sKey1); // KEY값1-접수관리번호
    //ds_iSettlementPos.SetColumn(0, "KEY2", sKey2); // KEY값2
    ds_iSettlementPos.SetColumn(0, "PROCGUBUN", divProcGubun.radProcGubun.Value); // 처리구분(환불구분(전액B, 부분P))
    ds_iSettlementPos.SetColumn(0, "REPAYCD", cbxRepayFee.Value); // 환불처리코드(B, 1, 2, 3, 4, 5, A)
    ds_iSettlementPos.SetColumn(0, "PROCAMOUNT", ds_oTrainingRepayFee.GetColumn(cbxRepayFee.Index, "REPAY")); // 결제금액
    ds_iSettlementPos.SetColumn(0, "PROCDATE", left(calSunapDate.Value, 8)); // 처리일자
    ds_iSettlementPos.SetColumn(0, "PONYGUBUN", iif(chkPonyDate.Value == "1", "1", "0")); // 정산구분
    ds_iSettlementPos.SetColumn(0, "PONYDATE", iif(chkPonyDate.Value == "1", left(calPonyDate.Value, 8), "")); // 정산일자
    ds_iSettlementPos.SetColumn(0, "PRINTYN", radRecieptYn.Value); // 영수증출력여부 Y/N
    ds_iSettlementPos.SetColumn(0, "SUNAPACTIONREF", ms_SunapActionRef); // TSSUNAPACTIONREF수납환불_REF
    ds_iSettlementPos.SetColumn(0, "REPAYTSSEQ", ds_oPosStartInfo.GetColumn(0, 'TSSEQ')); // 환불할 결제순차번호

    ds_iSettlementPos.SetColumn(0, "PAYMENTGUBUN",
            decode(right(ds_oPosStartInfo.GetColumn(0, 'TSGUBUN'), 1),
                "3", "0", "4", "0",
                "5", "2", "6", "2",
                right(ds_oPosStartInfo.GetColumn(0, 'TSGUBUN'), 1)
            )
        ); // 납부방법 현금0, 신용카드1, 현금영수증2, 가상계좌3

	ds_iSettlementPos.SetColumn(0, "TFCSEQ", ms_TFCSEQ);	// 수수료코드 관리번호 추가 2012.01.19

    if (ms_SunapGubun == "1") { // 환불
        if (ms_ExecutePosSettlementChangeYn == "Y") { // 회계수납회차변경실행여부
        	var ls_aftergtmgno = "";
			if (right(ds_oPosStartInfo.GetColumn(0, 'TSGUBUN'), 1) == "1") { // 카드이면
				ls_aftergtmgno = ds_oPosStartInfo.GetColumn(0, 'TSPOSGTMGNO');
			} else {
				ls_aftergtmgno = gds_oUserInfo.GetColumn(0, "PDEPTCD");
			}
            lfn_ExecutePosSettlementChange(ds_oPosStartInfo.GetColumn(0, 'TOMGGTMGNO'), ls_aftergtmgno); // 회계수납회차변경실행
            ds_iSettlementPos.SetColumn(0, "REPAYTSSEQ", ds_oPosStartInfo.GetColumn(0, 'TSSEQ')); // 환불할 결제순차번호
        }
    }
    lfn_ExecuteTrainingPosBefore(); // POS 호출 전 처리
    ds_iSettlementPos.SetColumn(0, "REPAYTSSEQ", ds_oPosStartInfo.GetColumn(0, 'TSSEQ')); // 환불할 결제순차번호
}


/*
 * 기능 : 납부방법변경(환불) 환불 후 수납을 실행한다.	2020.05.07
 * parameter : 없음
 * return : 없음
 */
function lfn_ExecuteSunap() {
    ms_SunapGubun = '0'; // 수납환불구분 : 수납'0'로 변경
    mn_PartRepayCnt = 2; // 납부방법변경(환불)여부 부분환불 수납
    ms_SunapActionRef = toNumber(ms_SunapActionRef) + 1; // TSSUNAPACTIONREF수납환불_REF

    ds_iSettlementPos.ClearData();
    divPos.ds_ioPosInput.ClearData(); // POS INPUT용
    
	// 수납용 POS처리용 데이타셋을 설정한다.
	ds_iSettlementPos.InsertRow(0);          
	ds_iSettlementPos.SetColumn(0, "JIBUMGID", edJibuMgId.Text); // 카드/지부상점ID
	ds_iSettlementPos.SetColumn(0, "PROGRAMID", sProgramId); // POS단위업무프로그램 (강습21,시험22,수첩23)
	ds_iSettlementPos.SetColumn(0, "SUNAPGUBUN", ms_SunapGubun); // 수납환불구분(수납0,환불1)
	ds_iSettlementPos.SetColumn(0, "PARTREPAYYN", 'Y'); // 부분환불여부(Y:부분환불,N:부분환불아님)
	ds_iSettlementPos.SetColumn(0, "POSYEAR", ms_RepayPosYear); // 환불용 POS년도
	ds_iSettlementPos.SetColumn(0, "POSMGNO", ms_RepayPosMgno); // 환불용 POS관리번호
	ds_iSettlementPos.SetColumn(0, "KEY1", sKey1); // KEY값1-관리번호

// 카드 등 결제 변경시 부분환불 개념임 결제 변경시 최초 선수납 여부에 따라 부분수납 프로세스 변경해야함 
	
	if ((ds_ioEarlySunapGubun.GetColumn(0, "EARLYGUBUN") == "L")) { 
		ds_iSettlementPos.SetColumn(0, "PROCGUBUN", "02"); // 결제구분(강습+수첩 등)
	} else if((ds_ioEarlySunapGubun.GetColumn(0, "EARLYGUBUN") == "E")) {
		ds_iSettlementPos.SetColumn(0, "PROCGUBUN", "03"); // 결제구분(강습+시험 등)
	} else if((ds_ioEarlySunapGubun.GetColumn(0, "EARLYGUBUN") == "N")) { // 일반수납일 경우
		ds_iSettlementPos.SetColumn(0, "PROCGUBUN", divProcGubun.radProcGubun.Value); // 결제구분(강습01, 강습+시험, 강습+수첩 등)
	}
  
	if ((ds_ioEarlySunapGubun.GetColumn(0, "EARLYGUBUN") == "N")) { 
	
		ds_iSettlementPos.SetColumn(0, "PROCAMOUNT", cbxSunapingAmount.Value); // 결제금액
		
	} else if ((ds_ioEarlySunapGubun.GetColumn(0, "EARLYGUBUN") == "L")) { // 수첩
	// 선수납일경우 
		ds_iSettlementPos.SetColumn(0, "PROCAMOUNT", edSunapingAmount_Edit.Value); // 결제금액
		ds_iSettlementPos.SetColumn(0, "LICENSEAMOUNT", ds_oTrainingEarlySunapFee.GetColumn(cbxEarlySunapingAmount.Index, "LICENSESUNAP")); // 수첩비 수납할 금액                
	} else if((ds_ioEarlySunapGubun.GetColumn(0, "EARLYGUBUN") == "E")) { // 시험
	 // 선수납일경우 
		ds_iSettlementPos.SetColumn(0, "PROCAMOUNT", edSunapingAmount_Edit.Value); // 결제금액
		ds_iSettlementPos.SetColumn(0, "EXAMAMOUNT", ds_oTrainingEarlySunapFee.GetColumn(cbxEarlySunapingAmount.Index, "LICENSESUNAP")); // 시험비 수납할 금액
	}
			  
	ds_iSettlementPos.SetColumn(0, "PROCDATE", left(calSunapDate.Value, 8)); // 처리일자
	ds_iSettlementPos.SetColumn(0, "PONYGUBUN", iif(chkPonyDate.Value == "1", "1", "0")); // 정산구분
	ds_iSettlementPos.SetColumn(0, "PONYDATE", iif(chkPonyDate.Value == "1", left(calPonyDate.Value, 8), "")); // 정산일자
	ds_iSettlementPos.SetColumn(0, "SUNAPACTIONREF", ms_SunapActionRef); // TSSUNAPACTIONREF수납환불_REF
	ds_iSettlementPos.SetColumn(0, "REPAYTSSEQ", ds_oPosStartInfo.GetColumn(0, 'TSSEQ')); // 환불할 결제순차번호

	ds_iSettlementPos.SetColumn(0, "BANKSUNAPGUBUN", divSunap.radBankSunapGubun.Value); // 수납방법(방문직납0,방문은납4)
	ds_iSettlementPos.SetColumn(0, "PAYMENTGUBUN", iif(divSunap.radSunapGubun.Value == "4", "3", divSunap.radSunapGubun.Value)); // 납부방법 현금0, 신용카드1, 현금영수증2, 가상계좌3

	ds_iSettlementPos.SetColumn(0, "TFCSEQ", ms_TFCSEQ);	// 수수료코드 관리번호 추가 2012.01.19

	ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "1"); // 처리기관 구분(0:현금, 1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
		
	switch (divSunap.radSunapGubun.Value) { // 납부방법
		case "0" : // 현금
			ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "0"); // 처리기관 구분(0:현금, 1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
			break;
			
		case "1" : // 카드
			if (divSunap.divSunabDtl.lb_AutoYn == false) { //직접입력(KeyIn)일 경우 카드번호+월+년
				if (gfn_IsNull(divSunap.divSunabDtl.edCardNo.Text)) {
					divSunap.divSunabDtl.edCardNo.SetFocus();
					gfn_Alert("카드번호를 입력해 주십시오.");
					return false;
				}
			}
		
			if (divSunap.divSunabDtl.lb_AutoYn) { // 자동입력
				ds_iSettlementPos.SetColumn(0, "CARDNO", ""); // 2018.07 IC카드리더기로 변경  // 2020.04.21  환불개선 수정 시 카드번호 입력 안함
			} else { // 수동입력
				ds_iSettlementPos.SetColumn(0, "CARDNO", divSunap.divSunabDtl.edCardNo.Text
					+ divSunap.divSunabDtl.cbxValidTermMonth.Value
					+ divSunap.divSunabDtl.cbxValidTermYear.Value); // 카드번호 + 월 + 년
			}
			//////// 일반수납일 경우
			if ((ds_ioEarlySunapGubun.GetColumn(0, "EARLYGUBUN") == "N")) { 
			
			   if ((toNumber(cbxSunapingAmount.Value) < 50000) && (divSunap.divSunabDtl.cbxInstallment.Value <> "00")) {
					divSunap.divSunabDtl.cbxInstallment.SetFocus();
					gfn_Alert("5만원 이상일 경우 할부 가능합니다.");
					return false;
			   }
			} else {
			// 선수납일 경우                            
			   if ((toNumber(edSunapingAmount_Edit.Value) < 50000) && (divSunap.divSunabDtl.cbxInstallment.Value <> "00")) {
					divSunap.divSunabDtl.cbxInstallment.SetFocus();
					gfn_Alert("5만원 이상일 경우 할부 가능합니다.");
					return false;
				}
			}
			
			ds_iSettlementPos.SetColumn(0, "CARDINSTALL", divSunap.divSunabDtl.cbxInstallment.Value); // 할부개월수
			ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "1"); // 처리기관 구분(0:현금, 1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
			break;
			
            case "2" : // 현금영수증
                if (gfn_IsNull(divSunap.divSunabDtl.edCashCardNo.Text)) {
                    divSunap.divSunabDtl.edCashCardNo.SetFocus();
                    gfn_Alert("현금영수증번호를 입력해 주십시오.");
                    return false;
                }
                ds_iSettlementPos.SetColumn(0, "CASHRECEIPTUSE", divSunap.divSunabDtl.radUseGubun.Value); // 현금영수증발급용도 용도('1':소득공제, '2':지출증빙)
                ds_iSettlementPos.SetColumn(0, "CASHCARDNO", divSunap.divSunabDtl.edCashCardNo.Text); // 현금영수증번호
                break;
                ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "0"); // 처리기관 구분(0:현금, 1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
            case "3" : // 가상계좌(LG U+)
                ds_iSettlementPos.SetColumn(0, "VIRTBANKCODE", divSunap.divSunabDtl.cbxBank.Value); // 입금계좌은행
                ds_iSettlementPos.SetColumn(0, "VIRTBANKNAME", divSunap.divSunabDtl.cbxBank.Text); // 입금계좌은행명
                ds_iSettlementPos.SetColumn(0, "VIRTCLOSEDATE", divSunap.divSunabDtl.calEndDate.Value); // 입금마감일
                ds_iSettlementPos.SetColumn(0, "VIRTHPTEL", divSunap.divSunabDtl.edHpTel.Text); // 가상계좌휴대폰번호
                ds_iSettlementPos.SetColumn(0, "VIRTCASHRECEIPTYN", divSunap.divSunabDtl.radRecieptYn.Value); // 가상계좌 현금영수증 사용여부Y/N
                if (divSunap.divSunabDtl.radRecieptYn.Value == "Y") {
                    if (gfn_IsNull(divSunap.divSunabDtl.divVirtual.edCashCardNo.Text)) {
                        divSunap.divSunabDtl.divVirtual.edCashCardNo.SetFocus();
                        gfn_Alert("현금영수증번호를 입력해 주십시오.");
                        return false;
                    }
                    ds_iSettlementPos.SetColumn(0, "CASHRECEIPTUSE", divSunap.divSunabDtl.divVirtual.radUseGubun.Value); // 현금영수증발급용도 용도('1':소득공제, '2':지출증빙)
                    ds_iSettlementPos.SetColumn(0, "CASHCARDNO", divSunap.divSunabDtl.divVirtual.edCashCardNo.Text); // 현금영수증번호
                }
                ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "1"); // 처리기관 구분(0:현금, 1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
                break;
            case "4" : // 가상계좌(세틀뱅크)
                ds_iSettlementPos.SetColumn(0, "VIRTBANKCODE", divSunap.divSunabDtl.cbxBank.Value); // 입금계좌은행
                ds_iSettlementPos.SetColumn(0, "VIRTBANKNAME", divSunap.divSunabDtl.cbxBank.Text); // 입금계좌은행명
                ds_iSettlementPos.SetColumn(0, "VIRTCLOSEDATE", divSunap.divSunabDtl.calEndDate.Value); // 입금마감일
                ds_iSettlementPos.SetColumn(0, "VIRTHPTEL", divSunap.divSunabDtl.edHpTel.Text); // 가상계좌휴대폰번호
                ds_iSettlementPos.SetColumn(0, "VIRTCASHRECEIPTYN", divSunap.divSunabDtl.radRecieptYn.Value); // 가상계좌 현금영수증 사용여부Y/N
/* 현금영수증 사용안함
                if (divSunap.divSunabDtl.radRecieptYn.Value == "Y") {
                    if (gfn_IsNull(divSunap.divSunabDtl.divVirtual.edCashCardNo.Text)) {
                        divSunap.divSunabDtl.divVirtual.edCashCardNo.SetFocus();
                        gfn_Alert("현금영수증번호를 입력해 주십시오.");
                        return false;
                    }
                    ds_iSettlementPos.SetColumn(0, "CASHRECEIPTUSE", divSunap.divSunabDtl.divVirtual.radUseGubun.Value); // 현금영수증발급용도 용도('1':소득공제, '2':지출증빙)
                    ds_iSettlementPos.SetColumn(0, "CASHCARDNO", divSunap.divSunabDtl.divVirtual.edCashCardNo.Text); // 현금영수증번호
                }
*/

/*
				ds_iSettlementPos.SetColumn(0, "PAYMENTGUBUN", "3"); // 납부방법 현금0, 신용카드1, 현금영수증2, 가상계좌3
                if (divSunap.divSunabDtl.cbxBank.index == 1) {	// 국민은행
					ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "2"); // 처리기관 구분(1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
				} else if (divSunap.divSunabDtl.cbxBank.index == 2) {	// 신한은행
					ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "3"); // 처리기관 구분(1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
				} else if (divSunap.divSunabDtl.cbxBank.index == 3) {	// 우리은행
					ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "4"); // 처리기관 구분(1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
				} else if (divSunap.divSunabDtl.cbxBank.index == 0) {	// 농협은행
					ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "5"); // 처리기관 구분(1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
				} else {
					ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "2"); // 처리기관 구분(1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
				}
				
*/

				ds_iSettlementPos.SetColumn(0, "PAYMENTGUBUN", "3"); // 납부방법 현금0, 신용카드1, 현금영수증2, 가상계좌3
                
                if (divSunap.divSunabDtl.cbxBank.index == 0) {	// 국민은행
					ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "2"); // 처리기관 구분(1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
				
				} else if (divSunap.divSunabDtl.cbxBank.index == 1) {	// 신한은행
					ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "3"); // 처리기관 구분(1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
				
				} else if (divSunap.divSunabDtl.cbxBank.index == 2) {	// 우리은행
					ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "4"); // 처리기관 구분(1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
				
				} else if (divSunap.divSunabDtl.cbxBank.index == 3) {	// 농협은행
					ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "5"); // 처리기관 구분(1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
				
				} else {
					ds_iSettlementPos.SetColumn(0, "ORGGUBUN", "2"); // 처리기관 구분(1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
				}
				
				
                break;
	}
	
	lfn_ExecuteTrainingPosBefore(); // POS 호출 전 처리
    
}

/*
 * 기능 : POS 처리를 위한 정보들을 조회한다.
 * parameter : 없음
 * return value : 없음
 */
function lfn_SearchTrainingPosStartInfo(obj) {
    var sArg = "TJMGNO=" + quote(sKey1); // 접수번호
        sArg += " TJMGNO_A=" + quote(sKey1); // 접수번호
    var sService = "com:searchTrainingPosStartInfo";

    tit_clearActionInfo();
    tit_addSingleActionInfo(sService, "", 0, "");
    tit_addSearchActionInfo("com:searchEarlySunapGubun", false);  //이번에 추가함 선수납인지 확인
    // 서버 호출
    tit_callService(
        ""
        ,""
        ,""    // inDs
        ,"ds_oPosStartInfo=ds_oPosStartInfo ds_ioEarlySunapGubun=ds_oEarlySunapGubun"    // outDs
        ,sArg    // args
        ,"lfn_AfterSearchTrainingPosStartInfo"
        ,false
        ,false
        ,true
    );
}

/*
 * 기능 :  POS 처리를 위한 정보 조회 후 처리해야 할 내용
 * parameter : nErrorCode - 에러코드
 *             strErrorMsg - 에러메시지
 * Return : 없음
 */
function lfn_AfterSearchTrainingPosStartInfo(nErrorCode, strErrorMsg) {

    if (nErrorCode != 0) { // 트랜잭션 에러를 처리한다.
        gfn_ErrorMsg(nErrorCode, strErrorMsg);
        var arrRet = array(2);
        arrRet[0] = "FAIL";
        Close(arrRet);
        return;
    }

    if (ds_oPosStartInfo.GetColumn(0, "RESULTCODE") <> "OK") {
        gfn_ErrorMsg(ds_oPosStartInfo.GetColumn(0, "RESULTCODE"), ds_oPosStartInfo.GetColumn(0, "RESULTMSG"));
        var arrRet = array(2);
        arrRet[0] = "OPEN-FAIL";
        Close(arrRet);
    }

    // ds_oPosStartInfo.GetColumn(0, 'TJTPMGNO'); // 강습자관리번호
    // ds_oPosStartInfo.GetColumn(0, 'TOMGNO'); // 회차관리번호
    // ds_oPosStartInfo.GetColumn(0, 'TJLASTTOHSEQ'); // 최종회차SEQ
    // ds_oPosStartInfo.GetColumn(0, 'TJLASTTSSEQ'); // 최종결제SEQ
    // ds_oPosStartInfo.GetColumn(0, 'TJLASTTJHSEQ'); // 최종이력SEQ
    // ds_oPosStartInfo.GetColumn(0, 'TOMGGTMGNO'); // 회차관리지부
    // ds_oPosStartInfo.GetColumn(0, 'TJLASTSUNAPGUBUN'); // 최종수납환불구분
    // ds_oPosStartInfo.GetColumn(0, 'TJPASSYN'); // 수료여부
    // ds_oPosStartInfo.GetColumn(0, 'TJPERSONNM'); // 성명
    // ds_oPosStartInfo.GetColumn(0, 'TJRESIDENTNO'); // 주민번호
    ms_HpTel = ds_oPosStartInfo.GetColumn(0, 'TPHPTEL'); // 휴대폰
    ms_RepayAbsenDayGubun = ds_oPosStartInfo.GetColumn(0, 'ABSENTDAY'); // 결강일차
    // ds_oPosStartInfo.GetColumn(0, 'TJJUBSUYN'); // 접수유효여부
    // ds_oPosStartInfo.GetColumn(0, 'LASTSTATUS'); // 최종접수상태
    ms_SunapingAmount = ds_oPosStartInfo.GetColumn(0, 'TFCFEE'); // 강습수수료(수납할 금액)
    ms_TFCSEQ = ds_oPosStartInfo.GetColumn(0, 'TFCSEQ'); // 수수료코드 관리번호
    ms_SunapedTotalAmount = ds_oPosStartInfo.GetColumn(0, 'TOTALPROCAMOUNT'); // 수납된 금액
    // ds_oPosStartInfo.GetColumn(0, 'TSSEQ'); // 환불할 결제SEQ
    ms_RepayPosYear = ds_oPosStartInfo.GetColumn(0, 'TSPMYEAR'); // POS영수증관리년도
    ms_RepayPosMgno = ds_oPosStartInfo.GetColumn(0, 'TSPMMGNO'); // POS영수증관리번호
    //ds_oPosStartInfo.GetColumn(0, 'TSGUBUN'); // 결제방법:10,11,12,13,…
    ms_RepayPayment = ds_oPosStartInfo.GetColumn(0, 'PRINTPAYMENT'); // 결과출력용 납입방법(0,1,2,3)
    ms_SunapActionRef = ds_oPosStartInfo.GetColumn(0, 'TSSUNAPACTIONREF'); // TSSUNAPACTIONREF수납환불_REF
}

// 카드변경처리환불
function chkCardChangeYn_OnClick(obj,strValue) {

	if (strValue == "Y") { // 카드변경처리환불인 경우
        divProcGubun.radProcGubun.Enable = false; // 전액/부분환불 구분
        cbxRepayFee.Enable = false; // 환불금액
        divSunap.radSunapGubun.Value = "1"; // 카드납부
        divSunap.radSunapGubun_OnChanged(obj, "1");
        //divSunap.radSunapGubun.Enable = false; // 납부방법

        divProcGubun.radProcGubun.Value = "B";

        divSunap.Visible = true;
        // 폼 사이즈 조절
        var ln_TitleSize = window.Height - this.Height;
        //window.Height = ln_TitleSize + (456);
        //divSunap.Top = "252";
        //btnSetlmt.Top = "408";
        // 220609 shjung 통합영수증발급(POS) 시스템 팝업 - 카드 등 납부방법 변경 시 클릭  
        // 결제 영역 확장
        window.Height = ln_TitleSize + (550);
        divSunap.Top = "315";
        btnSetlmt.Top = "490";

        divSunap.lbSunapingAmount.Visible = true;
        cbxSunapingAmount.Visible = true;
        //cbxRepayFee.Value = "B"; // 환불금액
        cbxRepayFee.Value = ds_oTrainingRepayFee.GetColumn(ds_oTrainingRepayFee.FindRow("REPAY", "-" + ms_SunapedTotalAmount), "CD");
        divRepay.medRepayAmount1.value = ds_oTrainingRepayFee.GetColumn(ds_oTrainingRepayFee.currow, "REPAY");
        divSunap.cbxSunapingAmount.Value = ms_SunapedTotalAmount; 
 
        if ((ds_ioEarlySunapGubun.GetColumn(0, "EARLYGUBUN") == "N")) { 
            cbxSunapingAmount.Visible = true;
            edSunapingAmount_Edit.Visible = false;  // 실제 선수납시 값으로 사용함             
         //       edSunapingAmount_Edit_View.Visible = false;  // 실제 선수납시 값으로 사용함            
        } else {
 
         // 선수납일경우 표시 하는 컨트롤 변경함 선수납시 콤보에 값이 보이지 않아서 그러함          
            cbxSunapingAmount.Visible = false;
            edSunapingAmount_Edit.Visible = true;  // 실제 선수납시 값으로 사용함 
            edSunapingAmount_Edit.Text = ms_SunapedTotalAmount;
            edSunapingAmount_Edit.Top = 275;
            edSunapingAmount_Edit.Left = 695;
        }
        
	} else { // 아닌 경우
        divProcGubun.radProcGubun.Enable = true; // 전액/부분환불 구분
        cbxRepayFee.Enable = true; // 환불금액
        //divSunap.radSunapGubun.Enable = true; // 납부방법

        divProcGubun.radProcGubun.Value = "B";
        divProcGubun.radProcGubun_OnChanged();
        
        cbxSunapingAmount.Visible = false;  // 선수납 값이 잘 안보여서 만든 것임 
        edSunapingAmount_Edit.Visible = false;  // 체크 해제시 안보임실제 선수납시 값으로 사용함             
 //       edSunapingAmount_Edit_View.Visible = false;  // 실제 선수납시 값으로 사용함  
        
        }
	}
}
            
/*
 * 기능 : POS 실패정보를 POSFAIL에 저장한다.
 * parameter : 없음
 * Return : 없음
 */
function lfn_SavePosFail() {
    var sArg = "PFPMYEAR=" + quote(ds_oSettlementPos.GetColumn(0, "RESULTPMYEAR")); // 영수증관리년도
    sArg += " PFPMMGNO=" + quote(ds_oSettlementPos.GetColumn(0, "RESULTPMMGNO")); // 영수증관리번호
    sArg += " PFPGMGUBUN=" + quote(sProgramId); // 프로그램구분
    sArg += " PFERRORCD=" + quote("1"); // 오류코드
    sArg += " PFREPAYGUBUN=" + quote(ds_iSettlementPos.GetColumn(0, "SUNAPGUBUN")); // 수납환불구분
    sArg += " PFKEY1=" + quote(sKey1); // KEY1
    sArg += " PFKEY2=" + quote(ds_iSettlementPos.GetColumn(0, "PAYMENTGUBUN")); // KEY2
    sArg += " PFSETLMTSEQ=" + quote(ds_oSettlementPos.GetColumn(0, "RESULTSTLNSEQ")); // 결제SEQ
    sArg += " PFHALFREPAYGUBUN=" + quote(iif(ms_SunapGubun == "0", "N", iif(divProcGubun.radProcGubun.Value == "B", "N", "Y"))); // 부분환불여부
    sArg += " PFSUNAPGUBUN=" + quote(ds_iSettlementPos.GetColumn(0, "PAYMENTGUBUN")); // 납부방법
    sArg += " PFPASSYN=" + quote(ds_oPosStartInfo.GetColumn(0, 'TJPASSYN')); // 수료여부
    sArg += " PFSUNAPCHANGEYN=" + quote(chkCardChangeYn.Value); // 납부방법_변경처리여부
    
    tit_clearActionInfo();
    tit_addSingleActionInfo("com:insertPosFail", "", 0, "");
    // 서버 호출
    tit_callService(
        ""
        ,""
        ,""    // inDs
        ,""    // outDs
        ,sArg    // args
        ,"lfn_AfterSavePosFail"
        ,false
        ,false
        ,true
    );
}

/*
 * 기능 : POS 실패정보 POSFAIL 저장 후 처리해야 할 내용
 * parameter : nErrorCode - 에러코드
 *             strErrorMsg - 에러메시지
 * Return : 없음
 */
function lfn_AfterSavePosFail(nErrorCode, strErrorMsg) {
    if (nErrorCode != 0) { // 트랜잭션 에러를 처리한다.
        gfn_ErrorMsg(nErrorCode, strErrorMsg);
        return;
    }        
}
function cbxEarlySunapingAmount_OnChanged(obj,strCode,strText,nOldIndex,nNewIndex)
{
    if(divProcGubun.radProcGubun.value == "02") {
        lbTrainingAndLicenseCostInfo.text = "(강습수수료 : " + NumFormat(ds_oTrainingEarlySunapFee.GetColumn(nNewIndex, "TRAININGSUNAP"))
    
                                           + " + 수첩교부수수료 : " + NumFormat(ds_oTrainingEarlySunapFee.GetColumn(nNewIndex, "LICENSESUNAP")) + ")";
    } else if(divProcGubun.radProcGubun.value == "03") { 
        lbTrainingAndLicenseCostInfo.text = "(강습수수료 : " + NumFormat(ds_oTrainingEarlySunapFee.GetColumn(nNewIndex, "TRAININGSUNAP"))
    
                                           + " + 시험응시수수료 : " + NumFormat(ds_oTrainingEarlySunapFee.GetColumn(nNewIndex, "LICENSESUNAP")) + ")";
    }
}


///////////////////////////////////////////////////////////////////////////////////////////////////////////
// 세틀뱅크 가상계좌
///////////////////////////////////////////////////////////////////////////////////////////////////////////
    
/* 사용자 함수 */
/*
 * 기능 : POS 호출 전 처리한다.
 * parameter : 없음
 * return value : 없음
 */
function lfn_SETTLEBANK_ExecuteTrainingPosBefore(obj) {
    tit_clearActionInfo();
    tit_addSingleActionInfo("com:executeTrainingPosBefore", "", 0, "");
    // 서버 호출
    tit_callService(
        ""
        ,""
        ,"ds_iSettlementPos=ds_iSettlementPos" // inDs
        ,"ds_oSettlementPos=ds_oSettlementPos" // outDs
        ,""    // args
        ,"lfn_AfterSETTLEBANKExecuteTrainingPosBefore"
        ,false
        ,false
        ,true
    );
}

/*
 * 기능 : POS 호출 전 처리 후 처리해야 할 내용
 * parameter : nErrorCode - 에러코드
 *             strErrorMsg - 에러메시지
 * Return : 없음
 */
function lfn_AfterSETTLEBANKExecuteTrainingPosBefore(nErrorCode, strErrorMsg) {
    if (nErrorCode != 0) { // 트랜잭션 에러를 처리한다.
        gfn_ErrorMsg(nErrorCode, strErrorMsg);
        if (ms_SunapGubun == "1") { // 환불
            lfn_ExecuteTrainingPosCancel();
        } else {
            var arrRet = array(2);
            arrRet[0] = "FAIL";
            Close(arrRet);
        }
        return;
    }

    if (ds_oSettlementPos.GetColumn(0, "RESULTCODE") <> "OK") {
        gfn_ErrorMsg(ds_oSettlementPos.GetColumn(0, "RESULTCODE"), ds_oSettlementPos.GetColumn(0, "RESULTMSG"));
        if (ms_SunapGubun == "1") { // 환불
            lfn_ExecuteTrainingPosCancel();
        } else {
            var arrRet = array(2);
            arrRet[0] = "FAIL";
            Close(arrRet);
        }
        return;
    }

    // POS DIV 호출용 데이타셋을 저장한다.
    divSETTLEBANKPos.ds_ioPosInput.ClearData();
    divSETTLEBANKPos.ds_ioPosInput.InsertRow(0);
    divSETTLEBANKPos.ds_ioPosInput.SetColumn(0, "GTMGNO", gds_oUserInfo.GetColumn(0, "PDEPTCD")); //지부코드
    divSETTLEBANKPos.ds_ioPosInput.SetColumn(0, "WORKGUBUN", "2"); //1:고객관리 2:강습 등
    divSETTLEBANKPos.ds_ioPosInput.SetColumn(0, "PMYEAR", ds_oSettlementPos.GetColumn(0, "RESULTPMYEAR")); // 영수증 관리년도
    divSETTLEBANKPos.ds_ioPosInput.SetColumn(0, "PMMGNO", ds_oSettlementPos.GetColumn(0, "RESULTPMMGNO")); // 영수증 관리번호
    divSETTLEBANKPos.ds_ioPosInput.SetColumn(0, "PMPCORDERNO", ds_oSettlementPos.GetColumn(0, "RESULTJUMUNNO")); // 주문번호
    divSETTLEBANKPos.ds_ioPosInput.SetColumn(0, "CLOSEDATE", substr(divSunap.divSunabDtl.calEndDate.Value,0,8)); // 입금마감일
    divSETTLEBANKPos.ds_ioPosInput.SetColumn(0, "CLOSETIME", substr(divSunap.divSunabDtl.calEndDate.Value,8,6)); // 입금마감시간
    divSETTLEBANKPos.ds_ioPosInput.SetColumn(0, "OWNERNM", "한국소방안전원-" + ds_oPosStartInfo.GetColumn(0, "TJPERSONNM")); // 예금주
    divSETTLEBANKPos.ds_ioPosInput.SetColumn(0, "PRMGUBUN", sProgramId); // POS단위업무프로그램 (강습21,시험22,수첩23)
    divSETTLEBANKPos.ds_ioPosInput.SetColumn(0, "PAYMENTFLAG", iif(ms_SunapGubun == "0", iif(divSunap.radSunapGubun.Value == "4", "3", divSunap.radSunapGubun.Value),
            decode(right(ds_oPosStartInfo.GetColumn(0, 'TSGUBUN'), 1),
                "3", "0", "4", "0",
                "5", "2", "6", "2",
                right(ds_oPosStartInfo.GetColumn(0, 'TSGUBUN'), 1)
            )
        )); // 납부방법 현금0, 신용카드1, 현금영수증2, 가상계좌3

	divSETTLEBANKPos.ds_ioPosInput.SetColumn(0, "PHONE", divSunap.divSunabDtl.edHpTel.Text); // 휴대폰번호
	divSETTLEBANKPos.ds_ioPosInput.SetColumn(0, "ORGGUBUN", ds_iSettlementPos.GetColumn(0, "ORGGUBUN")); // 처리기관 구분(0:현금, 1:LG U+ , 2:세틀뱅크(국민) 3:세틀뱅크(신한) 4:세틀뱅크(우리) 5:세틀뱅크(농협))
	if (divProcGubun.radProcGubun.Value == "01") {  // 01 강습비만
		divSETTLEBANKPos.ds_ioPosInput.SetColumn(0, "PROCAMOUNT", cbxSunapingAmount.Value); // 수납할 금액
	} else if(divProcGubun.radProcGubun.Value == "02"||divProcGubun.radProcGubun.Value == "03") { //02 강습비+수첩비 or 강습+시험비
		divSETTLEBANKPos.ds_ioPosInput.SetColumn(0, "PROCAMOUNT", cbxEarlySunapingAmount.Value); // 수납할 금액
	}

    ls_ResultPrintReTransYn = "N"; // 재전송버튼여부
    lfn_VirtualAccountProc(); // 가상계좌 할당처리
    
}

/*
 * 기능 : 가상계좌 할당처리한다.
 * parameter : 없음
 * return value : 없음
 */
var ms_RetPos = ""; // 할당결과
function lfn_VirtualAccountProc() { // 가상계좌 할당처리
    mb_IsRetry = false;

    var sArg = "";
    var ls_PosResultCode = ""; // POS 결과코드
    ms_RetPos = Dialog("COM::frmCOM8002PPOSProgressBar.xml", sArg, 300, 123, "TitleBar=false", -1, -1);

	// 가상계좌 할당 결과
    if (ms_RetPos == "OK") {
		ls_ResultPrintPosMsg = "가상계좌 할당성공"; // 안전원결과메세지
		ls_ResultPrintSBMsg = "가상계좌 할당성공"; // 세틀뱅크결과메세지
		ls_ResultPrintKemsMsg = "가상계좌 할당성공"; // 안전원결과메세지
		
    } else if (ms_RetPos == "FAIL"){ // 실패
		ls_ResultPrintPosMsg = "가상계좌 할당실패"; // 안전원결과메세지
		ls_ResultPrintKemsMsg = "가상계좌 할당실패"; // 안전원결과메세지
		ls_ResultPrintSBMsg = "가상계좌 할당실패"; // 세틀뱅크결과메세지	
    }
    
    var ls_RetResultPopup = lfn_PopupResultPos(); // 결과출력팝업을 호출한다.
    if (ls_RetResultPopup == "OK") {
        if (ms_SunapGubun == "0") { // 수납환불구분 : 수납
            lfn_ExecuteTrainingPosOk(); // POS 정상처리 후 처리

            if (ms_ExecutePosSettlementChangeYn == "Y") { // 회계수납회차변경실행여부
                lfn_ExecutePosSettlementChange(gds_oUserInfo.GetColumn(0, "PDEPTCD"), ds_oPosStartInfo.GetColumn(0, 'TOMGGTMGNO')); // 회계수납회차변경실행
            }

//            if (mn_PartRepayCnt == 1) { // 부분환불 수납 실행 중이면
//                Amount = Amount + gds_oPosResult.GetColumn(0, "PROCAMT");  // 결재 금액(부분환불 일경우 일부 수납금액 담음)
//                lfn_ExecuteRepaySunap(); // 부분환불 수납 후 환불 실행
//                return;
//            } else {
                var arrRet = array(4);
                Amount = Amount + gds_oPosResult.GetColumn(0, "PROCAMT");  // 결재 금액(최종결재의 금액을 담음 수납이든 환불이든)
                arrRet[0] = "OK";
                arrRet[1] = ms_SunapGubun;
                arrRet[2] = Amount;  // 결재 금액 
                arrRet[3] = iif(divSunap.radSunapGubun.Value == "4", "3", divSunap.radSunapGubun.Value); //수납구분
                Close(arrRet);
//            }
        }
    } else if (ls_RetResultPopup == "FAIL") { // 실패
        lfn_ExecuteTrainingPosCancel(); // POS 호출 실패 후 처리
    }
}]]></Script>
</Window>